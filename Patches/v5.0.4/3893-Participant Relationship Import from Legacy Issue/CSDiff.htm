<HTML><HEAD><TITLE> Differences Analysis</TITLE></HEAD><BODY BGCOLOR=WHITE><h3>Base file: D:\!Changes_I2MS\WEBI2MS\3893-Participant Relationship Import from Legacy Issue\OSI_PARTICIPANT-BodyOnly.sql</h3><h3>Compared file: D:\!Changes_I2MS\WEBI2MS\3893-Participant Relationship Import from Legacy Issue\OSI_PARTICIPANT-Production.sql</h3><body onunload=exit()><form method="POST">  <p align="center"><i><font size="3">Generated by   <a href="http://www.ComponentSoftware.com/products/csdiff/" target="_blank">CSDiff</a> on  6/20/2011 2:03 PM</font></i>&nbsp;&nbsp;
  <input type="button" value="Navigate Changes" name="Navigate" onclick=pop_navigate()></p></form></body><html>
<style type="text/css">
<!--
.HDNormal {  }
.HDDeleted {  color: #00ff00;background:  #ffffff;text-decoration:line-through ; font-family: Courier New ; font-size: 10pt;}
.HDAdded {  color: #000000;background:  #ffff00;text-decoration:none ; font-family: Courier New ; font-size: 10pt;}
-->
</style>
<body>
<pre>
 <span class="HDNormal">
1:  CREATE OR REPLACE PACKAGE BODY Osi_Participant AS
2:  /******************************************************************************
3:     name:     osi_participant
4:     purpose:  provides functionality for participant objects.
5:  
6:     revisions:
7:      date         author          description
8:      ----------   --------------  ------------------------------------
9:       12-may-2009 t.whitehead     Created this package.
10:      01-jun-2009 t.whitehead     Added create_nonindiv_instance.
11:      02-jun-2009 t.whitehead     Added Set_Current_Name.
12:      08-jun-2009 t.whitehead     Added Get_Subtype.
13:      15-jun-2009 t.whitehead     Added get_address_data, get_birth_city,
14:                                   get_birth_country, get_birth_state, get_number.
15:      16-jun-2009 t.whitehead     Added get_confirmation.
16:      22-jun-2009 t.whitehead     Added set_clearance.
17:      08-jul-2009 t.whitehead     Added set_current_address.
18:      20-jul-2009 t.whitehead     Added dob and sex params to create_instance.
19:      23-jul-2009 t.whitehead     Added p_acronym to create_nonindiv_instance.
20:      31-jul-2009 t.whitehead     Added get_relation_specifics, get_type_lov.
21:      10-aug-2009 t.whitehead     Modified get_name to consider versioning.
22:      11-aug-2009 t.whitehead     Modified the remaining functions that need to
23:                                  consider versioning.
24:      14-aug-2009 t.whitehead     Added get/set _address_sid, get_current_version,
25:                                  get_birth_address_sid methods.
26:      03-sep-2009 t.whitehead     Added get_subtype_sid, get_mil_member_name.
27:      04-sep-2009 t.whitehead     Added get_org_member_name.
28:      17-sep-2009 t.whitehead     Added get_next/previous_version, add/delete_version,
29:                                  get_participant.
30:      18-sep-2009 t.whitehead     Added is_confirmed.
31:      23-sep-2009 t.whitehead     Added get_version_label.
32:      05-oct-2009 t.whitehead     Added get/set_image_sid.
33:      09-oct-2009 t.whitehead     Added get_id.
34:      12-oct-2009 t.whitehead     Added an optional parameter to get_version_label.
35:      28-oct-2009 t.whitehead     Added has_isn_number.
36:      03-nov-2009 t.whitehead     Added get_create_menu.
37:      09-nov-2009 j.faris         Added can_delete.
38:      13-nov-2009 t.whitehead     Added p_omit_sa to get_details. This parameter is null by default
39:                                  and will cause the function to return all information about an
40:                                  individual. If you pass anything in for this parameter then
41:                                  service affiliation data will not be included in the details.
42:      11-dec-2009 t.whitehead     Added get_birth_country_code.
43:      31-dec-2009 t.whitehead     Added run_report_details.
44:      13-jan-2009 t.whitehead     Added check_writability.
45:      21-jan-2010 j.faris         Modified get_type_lov a accept an optional type list parameter.
46:      25-jan-2010 t.whitehead     Added remap_org_names.
47:      03-feb-2010 t.whitehead     Moved confirm, unconfirm from osi_status_proc.
48:      04-feb-2010 t.whitehead     Added check_for_matches.
49:      11-feb-2010 t.whitehead     Added check_for_duplicates.
50:      16-feb-2010 t.whitehead     Added get_confirm_messages, get_confirm_session. After calling
51:                                  check_for_duplicates calling get_confirm_messages returns any messages
52:                                  that would explain why check_for_duplicates returned null and
53:                                  get_confirm_session returns either null or a session sid.
54:      17-feb-2010 r.dibble        Added get_inv_type_sid
55:      19-feb-2010 t.whitehead     Added replace_with.
56:      21-apr-2010 t.whitehead     Added get_birth_state_code, get_contact_value.
57:      07-jun-2010 t.mcguffin      Added logging to DEERS query code.
58:      11-jun-2010 t.whitehead     Added get_rank.
59:      14-jun-2010 j.horne         Updated get_org_member_name to return sid of organization, changed name to
60:                                  get_org_member. Added get_org_member_addr.
61:      11-aug-2010 t.whitehead     Added get_type.
62:      23-aug-2010 r.dibble        Added import_legacy_participant
63:                                  Modified check_for_matches to search legacy participants
64:      25-aug-2010 r.dibble        Added get_legacy_part_details, get_legacy_part_names
65:      27-aug-2010 r.dibble        Modified import_legacy_participant to handle all versions
66:                                  Added import_legacy_part_version
67:      03-sep-2010 r.dibble        Added get_max_allowed_for_role, get_num_part_in_role
68:      08-sep-2010 t.whitehead     Updated the unconfirm procedure to automatically add a note.
69:      27-sep-2010 r.dibble        Fixed minor issue with import_legacy_participant() for note category handling
70:      18-sep-2010 r.dibble        Added these_details_are_editable
71:      19-Sep-2010 r.dibble        Modified import_legacy_participant to handle new attachments architecture
72:                                   as well as handle the DETAILS_LOCK functionality.
73:      11-Nov-2010 j.horne         Updated get_org_member.  Removed join to t_osi_partic_relation and added
74:                                  v_osi_partic_relation_2way
75:      24-Nov-2010 Tim Ward        Changed import_legacy_participant to use Global Temporary Tables for
76:                                   both Notes and Attachments to avoid the ora-22992 error that occurs when
77:                                   trying to get records with LOBs accross Database Links.
78:      08-Jan-2011 Tim Ward        Changed check_for_duplicates to not set v_confirm_allowed := 'N' when v_session
79:                                   is null, causing the function to return 'N' when it shouldn't.
80:      14-Jan-2011 j.horne         Updated run_report_details so SQL to get relationships used participant SID
81:                                   and not participant version sid. Updated SQL for images to look at SEQ.
82:      20-Jan-2011 j.horne         Added procedure reorder_partic_images and partic_image_sort
83:      24-Jan-2011 Tim Ward        Added Is_Married Function.
84:      24-Jan-2011 Tim Ward        Changed get_address_date to use V_OSI_PARTIC_ADDRESS and added DISPLAY as a return type.
85:      15-Feb-2011 Tim Ward        Fixed Is_Married still had a hard coded sid.
86:      16-Feb-2011 Tim Ward        Fixed import_legacy_participant to use the Legacy Attach_by and Attach_date as the new
87:                                   Create_by and Create_on.
88:      24-Feb-2011 j.faris         Fixed the ethnicity mapping in import_legacy_participant.
89:      24-Feb-2011 j.faris         Added import_legacy_relationships, get_imp_relations_flag, updates
90:                                  to import_legacy_part_version and import_legacy_participant.
91:      28-Feb-2011 Tim Ward        Changed CASE k.addr_type to CASE upper(k.addr_type) in import_legacy_participant.
92:                                   This gets rid of an "ORA-06592" error that was happening when the type returned
93:                                   was 'Permanent' instead of 'PERMANENT'.
94:      18-Mar-2011 Tim Ward        CR#3731 - Privilege needs to be checked in here now since the
95:                                   checkForPriv from i2ms.js deleteObj function.
96:                                   Changed for loops to select count(*).
97:                                   Changed in can_delete.
98:      24-Mar-2011 Tim Ward        CR#3770 - Found DEERS can return N/A for Hair Color and that was imported into Legacy 
99:                                   I2MS, when trying to import that from Legacy we get an Error:  No Data Found.
100:                                      Changed import_legacy_part_version.
101:         28-Mar-2011 Tim Ward        CR#3770 - Found DEERS can return Unknown for Eye Color and that was imported into Legacy 
102:                                      I2MS, when trying to import that from Legacy we get an Error:  No Data Found.
103:                                      Changed import_legacy_part_version.
104:         08-Jun-2011 Tim Ward        CR#3597 - Foreign ID # Saves incorrectly during creation (saves as SSN).
105:                                      Changed create_instance.
<a name="diff" id="c0"><span class="HDDeleted">106:         20-Jun-2011 Tim Ward        CR#3893 - Releationship failing to import because the detailed report was getting
107:                                      too big.  Don't need/want to show relationship information for units, one was
108:                                      pulling 200+ relationships and it got too large for the VARCHAR2 and the CLOB.
109:                                      Changed import_legacy_participant and import_legacy_participant.get_part_rel_info.
110:                                      
</span></a>111:    ******************************************************************************/
112:        c_pipe          VARCHAR2(100)   := Core_Util.get_config('CORE.PIPE_PREFIX')
113:                                           || 'OSI_PARTICIPANT';
114:        v_address_sid   T_OSI_PARTIC_ADDRESS.SID%TYPE;
115:        v_image_sid     T_OSI_ATTACHMENT.SID%TYPE;
116:        v_messages      VARCHAR2(2000);
117:        v_session       VARCHAR2(20);
118:    
119:        /*
120:         * Private functions first.
121:         */
122:        PROCEDURE log_error(p_msg IN VARCHAR2) IS
123:        BEGIN
124:            Core_Logger.log_it(c_pipe, p_msg);
125:        END log_error;
126:    
127:        /*
128:         * Public functions.
129:         */
130:        FUNCTION add_version(p_obj IN VARCHAR2)
131:            RETURN VARCHAR2 IS
132:            v_new_version   T_OSI_PARTICIPANT_VERSION.SID%TYPE;
133:            v_old_version   T_OSI_PARTICIPANT_VERSION.SID%TYPE;
134:            v_obj           T_OSI_PARTICIPANT.SID%TYPE;
135:            v_type          T_CORE_OBJ_TYPE.code%TYPE;
136:            v_sql           VARCHAR2(4000);
137:            v_table         VARCHAR2(100);
138:            v_current       VARCHAR2(20);
139:            v_temp          VARCHAR2(20);
140:    
141:            /*
142:             * Get the timestamp trigger name for the given table.
143:             */
144:            FUNCTION get_ts_trigger_script(p_table_name IN VARCHAR2, p_on_off IN VARCHAR2 := NULL)
145:                RETURN VARCHAR2 IS
146:                v_trig   VARCHAR2(256);
147:                v_rtn    VARCHAR2(300);
148:            BEGIN
149:                SELECT trigger_name
150:                  INTO v_trig
151:                  FROM USER_TRIGGERS
152:                 WHERE table_name = p_table_name AND trigger_name LIKE '%_TS';
153:    
154:                SELECT 'alter trigger ' || v_trig || DECODE(p_on_off, NULL, ' disable', ' enable')
155:                  INTO v_rtn
156:                  FROM dual;
157:    
158:                RETURN v_rtn;
159:            EXCEPTION
160:                WHEN NO_DATA_FOUND THEN
161:                    RETURN NULL;
162:                WHEN OTHERS THEN
163:                    log_error('get_ts_trigger_script: ' || SQLERRM);
164:                    RETURN 'get_ts_trigger_script: ' || SQLERRM;
165:            END get_ts_trigger_script;
166:    
167:            /*
168:             * This function return a DML string that will copy all the data from a given table for
169:             * one version (p_old_version) into records for a new version (p_new_version).
170:             */
171:            FUNCTION get_duplicate_sql(
172:                p_table_name    IN   VARCHAR2,
173:                p_new_version   IN   VARCHAR2,
174:                p_old_version   IN   VARCHAR2)
175:                RETURN VARCHAR2 IS
176:                v_sql       VARCHAR2(4000)
177:                                         := 'insert into ' || p_table_name || ' (participant_version, ';
178:                v_rtn       VARCHAR2(4000);
179:                v_columns   VARCHAR2(4000);
180:            BEGIN
181:                FOR i IN (SELECT LOWER(column_name) AS column_name
182:                            FROM USER_TAB_COLUMNS
183:                           WHERE table_name = p_table_name
184:                             AND LOWER(column_name) NOT IN('sid', 'participant_version', 'obj'))
185:                LOOP
186:                    v_columns := v_columns || i.column_name || ', ';
187:                END LOOP;
188:    
189:                v_columns := RTRIM(v_columns, ', ');
190:                v_sql :=
191:                    v_sql || v_columns || ') select ''' || p_new_version || ''', ' || v_columns
192:                    || ' from ' || p_table_name || ' where participant_version = ''' || p_old_version
193:                    || '''';
194:                v_rtn := v_rtn || v_sql;
195:                RETURN v_rtn;
196:            END get_duplicate_sql;
197:        BEGIN
198:            v_obj := p_obj;
199:            -- Get the current version sid.
200:            v_old_version := get_current_version(v_obj);
201:    
202:            -- Get the new version sid.
203:            INSERT INTO T_OSI_PARTICIPANT_VERSION
204:                        (participant)
205:                 VALUES (v_obj)
206:              RETURNING SID
207:                   INTO v_new_version;
208:    
209:            -- Determine if this is an individual or not.
210:            SELECT ot.code
211:              INTO v_type
212:              FROM T_CORE_OBJ o, T_CORE_OBJ_TYPE ot
213:             WHERE o.SID = p_obj AND o.obj_type = ot.SID;
214:    
215:            -- Name and Address versioning apply to individuals, organizations and companies.
216:    
217:            -- Names data.
218:            BEGIN
219:                v_table := 'T_OSI_PARTIC_NAME';
220:    
221:                -- Get the current name.
222:                SELECT current_name
223:                  INTO v_current
224:                  FROM T_OSI_PARTICIPANT_VERSION
225:                 WHERE SID = v_old_version;
226:    
227:                -- Disable the timestamp trigger to preserve the original timestamp.
228:                EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
229:    
230:                -- Copy all the existing names except for the "current" one.
231:                v_sql := get_duplicate_sql(v_table, v_new_version, v_old_version);
232:                v_sql := v_sql || ' and sid &lt;&gt; ''' || v_current || '''';
233:    
234:                EXECUTE IMMEDIATE v_sql;
235:    
236:                -- Now we'll do the "current" name manually.
237:                FOR x IN (SELECT name_type, title, last_name, first_name, middle_name, cadency,
238:                                 create_by, create_on, modify_by, modify_on
239:                            FROM T_OSI_PARTIC_NAME
240:                           WHERE SID = v_current)
241:                LOOP
242:                    INSERT INTO T_OSI_PARTIC_NAME
243:                                (participant_version,
244:                                 name_type,
245:                                 title,
246:                                 last_name,
247:                                 first_name,
248:                                 middle_name,
249:                                 cadency,
250:                                 create_by,
251:                                 create_on,
252:                                 modify_by,
253:                                 modify_on)
254:                         VALUES (v_new_version,
255:                                 x.name_type,
256:                                 x.title,
257:                                 x.last_name,
258:                                 x.first_name,
259:                                 x.middle_name,
260:                                 x.cadency,
261:                                 x.create_by,
262:                                 x.create_on,
263:                                 x.modify_by,
264:                                 x.modify_on)
265:                      RETURNING SID
266:                           INTO v_temp;
267:    
268:                    -- Update which name is the current name.
269:                    UPDATE T_OSI_PARTICIPANT_VERSION
270:                       SET current_name = v_temp
271:                     WHERE SID = v_new_version;
272:                END LOOP;
273:    
274:                -- Re-enable the timestamp trigger.
275:                EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
276:            EXCEPTION
277:                WHEN OTHERS THEN
278:                    log_error('add_version: Error versioning name data: ' || SQLERRM);
279:    
280:                    -- There was a problem so re-enable the trigger.
281:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
282:    
283:                    RAISE;
284:            END;
285:    
286:            -- Address data.
287:            BEGIN
288:                -- Get the current address.
289:                SELECT current_address
290:                  INTO v_current
291:                  FROM T_OSI_PARTICIPANT_VERSION
292:                 WHERE SID = v_old_version;
293:    
294:                EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
295:    
296:                -- Here we'll duplicate the records manually.
297:                FOR x IN (SELECT SID, obj, address_type, address_1, address_2, city, province, state,
298:                                 postal_code, country, geo_coords, start_date, end_date, known_date,
299:                                 comments, create_by, create_on, modify_by, modify_on
300:                            FROM T_OSI_ADDRESS
301:                           WHERE obj = v_obj)
302:                LOOP
303:                    INSERT INTO T_OSI_ADDRESS
304:                                (obj,
305:                                 address_type,
306:                                 address_1,
307:                                 address_2,
308:                                 city,
309:                                 province,
310:                                 state,
311:                                 postal_code,
312:                                 country,
313:                                 geo_coords,
314:                                 start_date,
315:                                 end_date,
316:                                 known_date,
317:                                 comments,
318:                                 create_by,
319:                                 create_on,
320:                                 modify_by,
321:                                 modify_on)
322:                         VALUES (x.obj,
323:                                 x.address_type,
324:                                 x.address_1,
325:                                 x.address_2,
326:                                 x.city,
327:                                 x.province,
328:                                 x.state,
329:                                 x.postal_code,
330:                                 x.country,
331:                                 x.geo_coords,
332:                                 x.start_date,
333:                                 x.end_date,
334:                                 x.known_date,
335:                                 x.comments,
336:                                 x.create_by,
337:                                 x.create_on,
338:                                 x.modify_by,
339:                                 x.modify_on)
340:                      RETURNING SID
341:                           INTO v_temp;
342:    
343:                    -- Add corresponding records to the participant address table.
344:                    INSERT INTO T_OSI_PARTIC_ADDRESS
345:                                (participant_version, address)
346:                         VALUES (v_new_version, v_temp);
347:    
348:                    IF (x.SID = v_current) THEN
349:                        -- Update the "current" address.
350:                        UPDATE T_OSI_PARTICIPANT_VERSION
351:                           SET current_address = v_temp
352:                         WHERE SID = v_new_version;
353:                    END IF;
354:                END LOOP;
355:    
356:                EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
357:            EXCEPTION
358:                WHEN OTHERS THEN
359:                    log_error('add_version: Error versioning address data: ' || SQLERRM);
360:    
361:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
362:    
363:                    RAISE;
364:            END;
365:    
366:            -- Vehicle data.
367:            BEGIN
368:                v_table := 'T_OSI_PARTIC_VEHICLE';
369:    
370:                EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
371:    
372:                v_sql := get_duplicate_sql(v_table, v_new_version, v_old_version);
373:    
374:                EXECUTE IMMEDIATE v_sql;
375:    
376:                EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
377:            EXCEPTION
378:                WHEN OTHERS THEN
379:                    log_error('add_version: Error versioning vehicle data: ' || SQLERRM);
380:    
381:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
382:    
383:                    RAISE;
384:            END;
385:    
386:            -- Specifics/Organization Attributes apply only to organizations.
387:            IF (v_type = 'PART.NONINDIV.ORG') THEN
388:                BEGIN
389:                    v_table := 'T_OSI_PARTIC_ORG_ATTR';
390:    
391:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
392:    
393:                    EXECUTE IMMEDIATE get_duplicate_sql(v_table, v_new_version, v_old_version);
394:    
395:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
396:                EXCEPTION
397:                    WHEN OTHERS THEN
398:                        log_error
399:                               ('add_version: Error versioning other organization attributes data: '
400:                                || SQLERRM);
401:    
402:                        EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
403:    
404:                        RAISE;
405:                END;
406:            END IF;
407:    
408:            -- Company and Organization specific data.
409:            IF (v_type IN('PART.NONINDIV.COMP', 'PART.NONINDIV.ORG')) THEN
410:                BEGIN
411:                    v_table := 'T_OSI_PARTICIPANT_NONHUMAN';
412:    
413:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
414:    
415:                    v_sql := get_duplicate_sql(v_table, v_new_version, v_old_version);
416:                    v_sql := REPLACE(v_sql, 'participant_version', 'sid');
417:    
418:                    EXECUTE IMMEDIATE v_sql;
419:    
420:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
421:                EXCEPTION
422:                    WHEN OTHERS THEN
423:                        log_error('add_version: Error versioning non-individual data: ' || SQLERRM);
424:    
425:                        EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
426:    
427:                        RAISE;
428:                END;
429:            END IF;
430:    
431:            -- Everything below applies only to individuals.
432:            IF (v_type = 'PART.INDIV') THEN
433:                -- Other Dates data.
434:                BEGIN
435:                    v_table := 'T_OSI_PARTIC_DATE';
436:    
437:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
438:    
439:                    EXECUTE IMMEDIATE get_duplicate_sql(v_table, v_new_version, v_old_version);
440:    
441:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
442:                EXCEPTION
443:                    WHEN OTHERS THEN
444:                        log_error('add_version: Error versioning other dates data: ' || SQLERRM);
445:    
446:                        EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
447:    
448:                        RAISE;
449:                END;
450:    
451:                -- Citizenships data.
452:                BEGIN
453:                    v_table := 'T_OSI_PARTIC_CITIZENSHIP';
454:    
455:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
456:    
457:                    EXECUTE IMMEDIATE get_duplicate_sql(v_table, v_new_version, v_old_version);
458:    
459:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
460:                EXCEPTION
461:                    WHEN OTHERS THEN
462:                        log_error('add_version: Error versioning citizenship data: ' || SQLERRM);
463:    
464:                        EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
465:    
466:                        RAISE;
467:                END;
468:    
469:                -- Identifying Numbers data.
470:                BEGIN
471:                    v_table := 'T_OSI_PARTIC_NUMBER';
472:    
473:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
474:    
475:                    EXECUTE IMMEDIATE get_duplicate_sql(v_table, v_new_version, v_old_version);
476:    
477:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
478:                EXCEPTION
479:                    WHEN OTHERS THEN
480:                        log_error('add_version: Error versioning identifying numbers data: ' || SQLERRM);
481:    
482:                        EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
483:    
484:                        RAISE;
485:                END;
486:    
487:                -- Individual data.
488:                BEGIN
489:                    v_table := 'T_OSI_PARTICIPANT_HUMAN';
490:    
491:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
492:    
493:                    v_sql := get_duplicate_sql(v_table, v_new_version, v_old_version);
494:                    v_sql := REPLACE(v_sql, 'participant_version', 'sid');
495:    
496:                    EXECUTE IMMEDIATE v_sql;
497:    
498:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
499:                EXCEPTION
500:                    WHEN OTHERS THEN
501:                        log_error('add_version: Error versioning individual data: ' || SQLERRM);
502:    
503:                        EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
504:    
505:                        RAISE;
506:                END;
507:    
508:                -- More individual data.
509:                BEGIN
510:                    v_table := 'T_OSI_PERSON_CHARS';
511:    
512:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
513:    
514:                    v_sql := get_duplicate_sql(v_table, v_new_version, v_old_version);
515:                    v_sql := REPLACE(v_sql, 'participant_version', 'sid');
516:    
517:                    EXECUTE IMMEDIATE v_sql;
518:    
519:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
520:                EXCEPTION
521:                    WHEN OTHERS THEN
522:                        log_error('add_version: Error versioning person chars data: ' || SQLERRM);
523:    
524:                        EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
525:    
526:                        RAISE;
527:                END;
528:    
529:                -- Special marks data.
530:                BEGIN
531:                    v_table := 'T_OSI_PARTIC_MARK';
532:    
533:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
534:    
535:                    v_sql := get_duplicate_sql(v_table, v_new_version, v_old_version);
536:    
537:                    EXECUTE IMMEDIATE v_sql;
538:    
539:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
540:                EXCEPTION
541:                    WHEN OTHERS THEN
542:                        log_error('add_version: Error versioning special marks data: ' || SQLERRM);
543:    
544:                        EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
545:    
546:                        RAISE;
547:                END;
548:    
549:                -- Contact data.
550:                BEGIN
551:                    v_table := 'T_OSI_PARTIC_CONTACT';
552:    
553:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table);
554:    
555:                    v_sql := get_duplicate_sql(v_table, v_new_version, v_old_version);
556:    
557:                    EXECUTE IMMEDIATE v_sql;
558:    
559:                    EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
560:                EXCEPTION
561:                    WHEN OTHERS THEN
562:                        log_error('add_version: Error versioning contact data: ' || SQLERRM);
563:    
564:                        EXECUTE IMMEDIATE get_ts_trigger_script(v_table, 1);
565:    
566:                        RAISE;
567:                END;
568:            END IF;
569:    
570:            -- Set the new version as the current version.
571:            UPDATE T_OSI_PARTICIPANT
572:               SET current_version = v_new_version
573:             WHERE SID = v_obj;
574:    
575:            RETURN v_new_version;
576:        EXCEPTION
577:            WHEN OTHERS THEN
578:                log_error('add_version: ' || SQLERRM);
579:                RAISE;
580:        END add_version;
581:    
582:        FUNCTION delete_version(p_version IN VARCHAR2)
583:            RETURN VARCHAR2 IS
584:            v_result    VARCHAR2(1)                          := 'Y';
585:            v_current   T_OSI_PARTICIPANT_VERSION.SID%TYPE;
586:        BEGIN
587:            v_current := get_previous_version(p_version);
588:    
589:            IF (v_current IS NULL) THEN
590:                v_result := 'N';
591:            ELSE
592:                UPDATE T_OSI_PARTICIPANT
593:                   SET current_version = v_current
594:                 WHERE SID = get_participant(p_version);
595:    
596:                DELETE FROM T_OSI_PARTICIPANT_VERSION
597:                      WHERE SID = p_version;
598:            END IF;
599:    
600:            RETURN v_result;
601:        EXCEPTION
602:            WHEN OTHERS THEN
603:                log_error('delete_version: ' || SQLERRM);
604:                RETURN 'delete_version: ' || SQLERRM;
605:        END delete_version;
606:    
607:        FUNCTION can_delete(p_obj IN VARCHAR2) RETURN VARCHAR2 IS
608:             
609:             v_count_check number;
610:             
611:        BEGIN
612:             if osi_auth.check_for_priv('DELETE',Core_Obj.get_objtype(p_obj))='N' then
613:             
614:               return 'You are not authorized to perform the requested action.';
615:               
616:             end if;
617:    
618:             ---Does this person have associations (files or activities)?---
619:             select count(*) into v_count_check FROM T_OSI_PARTIC_INVOLVEMENT pi, T_OSI_PARTICIPANT_VERSION pv WHERE pi.participant_version = pv.SID AND pv.participant = p_obj;
620:             if v_count_check &gt; 0 then
621:    
622:               RETURN 'You cannot delete a participant used in a file or activity.';
623:    
624:             end if;
625:    
626:             ---Does this person have relationships?---
627:             select count(*) into v_count_check FROM T_OSI_PARTIC_RELATION pr WHERE pr.partic_a = p_obj OR pr.partic_b = p_obj;
628:             if v_count_check &gt; 0 then
629:    
630:               RETURN 'You cannot delete a participant with an existing relationship.';
631:    
632:             end if;
633:    
634:             RETURN 'Y';
635:    
636:        EXCEPTION
637:            WHEN OTHERS THEN
638:                log_error('OSI_PARTICIPANT.Can_Delete: Error encountered using Object ' || NVL(p_obj, 'NULL') || ':' || SQLERRM);
639:                RETURN 'Untrapped error in OSI_PARTICIPANT.Can_Delete using Object: ' || NVL(p_obj, 'NULL');
640:    
641:        END can_delete;
642:    
643:        FUNCTION check_writability(p_obj IN VARCHAR2, p_version IN VARCHAR2)
644:            RETURN VARCHAR2 IS
645:        BEGIN
646:            IF (   p_version IS NULL
647:                OR p_version = get_current_version(p_obj)) THEN
648:                RETURN 'Y';
649:            ELSE
650:                RETURN 'N';
651:            END IF;
652:        EXCEPTION
653:            WHEN OTHERS THEN
654:                log_error('check_writability: ' || SQLERRM);
655:                RAISE;
656:        END check_writability;
657:    
658:        FUNCTION create_instance(
659:            p_lname     IN   VARCHAR2 := NULL,
660:            p_fname     IN   VARCHAR2 := NULL,
661:            p_ssn       IN   VARCHAR2 := NULL,
662:            p_dob       IN   DATE := NULL,
663:            p_sex       IN   VARCHAR2 := NULL,
664:            p_unknown   IN   VARCHAR2 := 'Y',
665:            p_num_type  IN   VARCHAR2 := NULL)
666:            RETURN VARCHAR2 IS
667:            v_sid         T_CORE_OBJ.SID%TYPE;
668:            v_obj_type    T_CORE_OBJ_TYPE.SID%TYPE;
669:            v_par_type    T_OSI_REFERENCE.SID%TYPE;
670:            v_num_type    T_OSI_REFERENCE.SID%TYPE;
671:            v_ssn         T_OSI_PARTIC_NUMBER.num_value%TYPE;
672:            v_name_type   T_OSI_PARTIC_NAME_TYPE.SID%TYPE;
673:            v_fname       T_OSI_PARTIC_NAME.first_name%TYPE;
674:            v_lname       T_OSI_PARTIC_NAME.last_name%TYPE;
675:            v_version     T_OSI_PARTICIPANT_VERSION.SID%TYPE;
676:            v_cur_name    T_OSI_PARTIC_NAME.SID%TYPE;
677:    
678:            /*
679:            * The first name for an unknown participant is UNIT_CODE-YEAR-NUMBER.
680:            * Example: 106-2009-0001
681:            * The last four digits start at one and are incremented by one. Each year the
682:            * sequence starts over.
683:            */
684:            FUNCTION get_unknown_number
685:                RETURN VARCHAR2 IS
686:                v_max    T_OSI_PARTIC_NAME.first_name%TYPE;
687:                v_rtn    T_OSI_PARTIC_NAME.first_name%TYPE;
688:                v_temp   T_OSI_PARTIC_NAME.first_name%TYPE;
689:            BEGIN
690:                v_temp :=
691:                    Osi_Unit.get_code(Osi_Personnel.get_current_unit()) || '-'
692:                    || TO_CHAR(SYSDATE, 'YYYY');
693:    
694:                SELECT MAX(first_name)
695:                  INTO v_max
696:                  FROM T_OSI_PARTIC_NAME
697:                 WHERE first_name LIKE v_temp || '%';
698:    
699:                IF (v_max IS NULL) THEN
700:                    v_max := 0;
701:                ELSE
702:                    v_max := SUBSTR(v_max, INSTR(v_max, '-', 1, 2) + 1);
703:                END IF;
704:    
705:                v_rtn := v_temp || '-' || trim(TO_CHAR(v_max + 1, '0000'));
706:                RETURN v_rtn;
707:            END get_unknown_number;
708:        BEGIN
709:            v_obj_type := Core_Obj.lookup_objtype('PART.INDIV');
710:    
711:            INSERT INTO T_CORE_OBJ
712:                        (obj_type)
713:                 VALUES (v_obj_type)
714:              RETURNING SID
715:                   INTO v_sid;
716:    
717:            INSERT INTO T_OSI_PARTICIPANT
718:                        (SID, unknown_flag, dob)
719:                 VALUES (v_sid, p_unknown, p_dob);
720:    
721:            INSERT INTO T_OSI_PARTICIPANT_VERSION
722:                        (participant)
723:                 VALUES (v_sid)
724:              RETURNING SID
725:                   INTO v_version;
726:    
727:            UPDATE T_OSI_PARTICIPANT
728:               SET current_version = v_version
729:             WHERE SID = v_sid;
730:    
731:            INSERT INTO T_OSI_PARTICIPANT_HUMAN
732:                        (SID)
733:                 VALUES (v_version);
734:    
735:            INSERT INTO T_OSI_PERSON_CHARS
736:                        (SID, sex)
737:                 VALUES (v_version, p_sex);
738:    
739:            SELECT n.SID
740:              INTO v_name_type
741:              FROM T_OSI_PARTIC_NAME_TYPE_MAP m, T_OSI_PARTIC_NAME_TYPE n
742:             WHERE m.participant_type = Osi_Reference.lookup_ref_sid('PART.INDIV', 'PI')
743:               AND m.name_type = n.SID
744:               AND n.code = 'L'
745:               AND m.active = 'Y';
746:    
747:            IF (p_unknown = 'Y') THEN
748:                v_lname := 'UNKNOWN';
749:                v_fname := get_unknown_number;
750:                v_ssn := NULL;
751:            ELSE
752:                v_lname := p_lname;
753:                v_fname := p_fname;
754:                v_ssn := p_ssn;
755:            END IF;
756:    
757:            INSERT INTO T_OSI_PARTIC_NAME
758:                        (participant_version, name_type, last_name, first_name)
759:                 VALUES (v_version, v_name_type, v_lname, v_fname)
760:              RETURNING SID
761:                   INTO v_cur_name;
762:    
763:            UPDATE T_OSI_PARTICIPANT_VERSION
764:               SET current_name = v_cur_name
765:             WHERE SID = v_version;
766:    
767:            IF (p_ssn IS NOT NULL) THEN
768:              
769:              IF (p_num_type is null) THEN
770:    
771:                SELECT SID
772:                  INTO v_num_type
773:                  FROM T_OSI_PARTIC_NUMBER_TYPE
774:                 WHERE CODE='SSN';
775:    
776:              ELSE
777:    
778:                v_num_type := p_num_type;
779:    
780:              END IF;
781:             
782:                INSERT INTO T_OSI_PARTIC_NUMBER
783:                            (participant_version, num_type, num_value)
784:                     VALUES (v_version, v_num_type, v_ssn);
785:            END IF;
786:    
787:            Osi_Status.change_status_brute(v_sid, Osi_Status.get_starting_status(v_obj_type), 'Created');
788:            RETURN v_sid;
789:        EXCEPTION
790:            WHEN OTHERS THEN
791:                log_error('create_instance: ' || SQLERRM);
792:                RAISE;
793:        END create_instance;
794:    
795:        FUNCTION create_nonindiv_instance(
796:            p_obj_type_sid   IN   VARCHAR2,
797:            p_sub_type       IN   VARCHAR2,
798:            p_name_type      IN   VARCHAR2,
799:            p_name           IN   VARCHAR2,
800:            p_acronym        IN   VARCHAR2 := NULL)
801:            RETURN VARCHAR2 IS
802:            v_sid        T_CORE_OBJ.SID%TYPE;
803:            v_version    T_OSI_PARTICIPANT_VERSION.SID%TYPE;
804:            v_cur_name   T_OSI_PARTIC_NAME.SID%TYPE;
805:        BEGIN
806:            INSERT INTO T_CORE_OBJ
807:                        (obj_type)
808:                 VALUES (p_obj_type_sid)
809:              RETURNING SID
810:                   INTO v_sid;
811:    
812:            INSERT INTO T_OSI_PARTICIPANT
813:                        (SID)
814:                 VALUES (v_sid);
815:    
816:            INSERT INTO T_OSI_PARTICIPANT_VERSION
817:                        (participant)
818:                 VALUES (v_sid)
819:              RETURNING SID
820:                   INTO v_version;
821:    
822:            UPDATE T_OSI_PARTICIPANT
823:               SET current_version = v_version
824:             WHERE SID = v_sid;
825:    
826:            INSERT INTO T_OSI_PARTICIPANT_NONHUMAN
827:                        (SID, sub_type)
828:                 VALUES (v_version, p_sub_type);
829:    
830:            INSERT INTO T_OSI_PARTIC_NAME
831:                        (participant_version, name_type, last_name, first_name)
832:                 VALUES (v_version, p_name_type, p_name, p_acronym)
833:              RETURNING SID
834:                   INTO v_cur_name;
835:    
836:            UPDATE T_OSI_PARTICIPANT_VERSION
837:               SET current_name = v_cur_name
838:             WHERE SID = v_version;
839:    
840:            Osi_Status.change_status_brute(v_sid,
841:                                           Osi_Status.get_starting_status(p_obj_type_sid),
842:                                           'Created');
843:            RETURN v_sid;
844:        EXCEPTION
845:            WHEN OTHERS THEN
846:                log_error('create_nonindiv_instance: ' || SQLERRM);
847:                RAISE;
848:        END create_nonindiv_instance;
849:    
850:        FUNCTION is_confirmed(p_pvop IN VARCHAR2)
851:            RETURN VARCHAR2 IS
852:            v_yn   VARCHAR2(1);
853:        BEGIN
854:            SELECT DECODE(confirm_by, NULL, NULL, 'Y')
855:              INTO v_yn
856:              FROM v_osi_participant_version
857:             WHERE SID = p_pvop
858:                OR (participant = p_pvop AND SID = current_version);
859:    
860:            RETURN v_yn;
861:        EXCEPTION
862:            WHEN OTHERS THEN
863:                log_error('is_confirmed: ' || SQLERRM);
864:                RETURN 'is_confirmed: ' || SQLERRM;
865:        END is_confirmed;
866:    
867:        FUNCTION get_address_data(
868:            p_pvop           IN   VARCHAR2,
869:            p_address_code   IN   VARCHAR2,
870:            p_address_item   IN   VARCHAR2)
871:            RETURN VARCHAR2 IS
872:        BEGIN
873:            FOR x IN (SELECT * FROM V_OSI_PARTIC_ADDRESS
874:                       WHERE (participant_version = p_pvop or participant_version = osi_participant.get_current_version(p_pvop))
875:                         and type_code=p_address_code
876:                       order by modify_on desc)
877:            LOOP
878:                CASE UPPER(p_address_item)
879:                    WHEN 'SID' THEN
880:                        RETURN x.SID;
881:                    WHEN 'ADDRESS1' THEN
882:                        RETURN x.address_1;
883:                    WHEN 'ADDRESS2' THEN
884:                        RETURN x.address_2;
885:                    WHEN 'ADDRESS' THEN
886:                        RETURN x.address_1 || CHR(10) || CHR(13) || x.address_2;
887:                    WHEN 'CITY' THEN
888:                        RETURN x.city;
889:                    WHEN 'PROVINCE' THEN
890:                        RETURN x.province;
891:                    WHEN 'STATE' THEN
892:                        RETURN x.state_desc;
893:                    WHEN 'STATE_CODE' THEN
894:                        RETURN x.state_code;
895:                    WHEN 'ZIP' THEN
896:                        RETURN x.postal_code;
897:                    WHEN 'POSTAL_CODE' THEN
898:                        RETURN x.postal_code;
899:                    WHEN 'COUNTRY' THEN
900:                        RETURN x.country_desc;
901:                    WHEN 'COUNTRY_CODE' THEN
902:                        RETURN x.country_code;
903:                    WHEN 'GEO_COORDS' THEN
904:                        RETURN x.geo_coords;
905:                    WHEN 'DISPLAY' THEN
906:                        IF SUBSTR(UPPER(p_address_code),-3) = '_ML' THEN
907:                          RETURN( x.display_string );
908:                        ELSIF SUBSTR(UPPER(p_address_code),-4) = '_SCO' THEN
909:                             RETURN( NVL(x.state_desc, x.country_desc) );
910:                        ELSE
911:                          RETURN( x.single_line );
912:                        END IF;
913:                END CASE;
914:            END LOOP;
915:    
916:            RETURN NULL;
917:        EXCEPTION
918:            WHEN OTHERS THEN
919:                log_error('get_address_data: ' || SQLERRM);
920:                RETURN 'get_address_data: ' || SQLERRM;
921:        END get_address_data;
922:    
923:        FUNCTION get_address_sid
924:            RETURN VARCHAR2 IS
925:        BEGIN
926:            RETURN v_address_sid;
927:        END get_address_sid;
928:    
929:        FUNCTION get_birth_address_sid(p_pvop IN VARCHAR2)
930:            RETURN VARCHAR2 IS
931:        BEGIN
932:            RETURN get_address_data(p_pvop, 'BIRTH', 'SID');
933:        END get_birth_address_sid;
934:    
935:        FUNCTION get_birth_city(p_pvop IN VARCHAR2)
936:            RETURN VARCHAR2 IS
937:        BEGIN
938:            RETURN get_address_data(p_pvop, 'BIRTH', 'CITY');
939:        END get_birth_city;
940:    
941:        FUNCTION get_birth_country(p_pvop IN VARCHAR2)
942:            RETURN VARCHAR2 IS
943:        BEGIN
944:            RETURN get_address_data(p_pvop, 'BIRTH', 'COUNTRY');
945:        END get_birth_country;
946:    
947:        FUNCTION get_birth_country_code(p_pvop IN VARCHAR2)
948:            RETURN VARCHAR2 IS
949:        BEGIN
950:            RETURN get_address_data(p_pvop, 'BIRTH', 'COUNTRY_CODE');
951:        END get_birth_country_code;
952:    
953:        FUNCTION get_birth_state(p_pvop IN VARCHAR2)
954:            RETURN VARCHAR2 IS
955:        BEGIN
956:            RETURN get_address_data(p_pvop, 'BIRTH', 'STATE');
957:        END get_birth_state;
958:    
959:        FUNCTION get_birth_state_code(p_pvop IN VARCHAR2)
960:            RETURN VARCHAR2 IS
961:        BEGIN
962:            RETURN get_address_data(p_pvop, 'BIRTH', 'STATE_CODE');
963:        END get_birth_state_code;
964:    
965:        FUNCTION get_confirm_messages
966:            RETURN VARCHAR2 IS
967:        BEGIN
968:            RETURN v_messages;
969:        END get_confirm_messages;
970:    
971:        FUNCTION get_confirm_session
972:            RETURN VARCHAR2 IS
973:        BEGIN
974:            RETURN v_session;
975:        END get_confirm_session;
976:    
977:        FUNCTION get_confirmation(p_pvop IN VARCHAR2)
978:            RETURN VARCHAR2 IS
979:            v_confirmed   T_OSI_PARTICIPANT.confirm_by%TYPE;
980:        BEGIN
981:            SELECT DECODE(confirm_by, NULL, 'Not Confirmed', 'Confirmed')
982:              INTO v_confirmed
983:              FROM v_osi_participant_version
984:             WHERE SID = p_pvop
985:                OR (participant = p_pvop AND SID = current_version);
986:    
987:            RETURN v_confirmed;
988:        EXCEPTION
989:            WHEN OTHERS THEN
990:                log_error('get_confirmation: ' || SQLERRM);
991:                RETURN 'get_confirmation: ' || SQLERRM;
992:        END get_confirmation;
993:    
994:        FUNCTION get_contact_value(p_pvop IN VARCHAR2, p_type IN VARCHAR2)
995:            RETURN VARCHAR2 IS
996:        BEGIN
997:            FOR x IN (SELECT VALUE
998:                        FROM v_osi_participant_version pv, T_OSI_PARTIC_CONTACT pc
999:                       WHERE (   pv.SID = p_pvop
1000:                             OR (pv.participant = p_pvop AND pv.SID = pv.current_version))
1001:                        AND pc.participant_version = pv.SID
1002:                        AND pc.TYPE = Osi_Reference.lookup_ref_sid('CONTACT_TYPE', p_type))
1003:           LOOP
1004:               RETURN x.VALUE;
1005:           END LOOP;
1006:   
1007:           RETURN NULL;
1008:       EXCEPTION
1009:           WHEN OTHERS THEN
1010:               log_error('get_contact_value: ' || SQLERRM);
1011:               RETURN 'get_contact_value: ' || SQLERRM;
1012:       END get_contact_value;
1013:   
1014:       FUNCTION get_create_menu(p_icon IN VARCHAR2, p_page_item IN VARCHAR2, p_type_list IN VARCHAR2)
1015:           RETURN VARCHAR2 IS
1016:           v_array      apex_application_global.vc_arr2;
1017:           v_rtn        VARCHAR2(4000);
1018:           v_id         VARCHAR2(10);
1019:           v_page_num   NUMBER;
1020:       BEGIN
1021:           v_array := apex_util.string_to_table(p_type_list, '~');
1022:           v_id := dbms_random.string('U', 10);
1023:           v_rtn := '&lt;a href="javascript:showHide(''' || v_id || ''');"&gt;' || p_icon || '&lt;/a&gt;';
1024:           v_rtn := v_rtn || '&lt;div id="' || v_id || '" style="display:none;position:absolute;"&gt;';
1025:           v_rtn := v_rtn || '&lt;ul class="expandButton"&gt;';
1026:   
1027:           FOR x IN 1 .. v_array.COUNT
1028:           LOOP
1029:               FOR y IN (SELECT description
1030:                           FROM T_CORE_OBJ_TYPE
1031:                          WHERE code = UPPER(v_array(x)))
1032:               LOOP
1033:                   IF (v_array(x) = 'PART.INDIV') THEN
1034:                       v_rtn :=
1035:                           v_rtn
1036:                           || '&lt;li class="expandedItem1"&gt;&lt;a href="javascript:createObject(30000,''';
1037:                       v_rtn := v_rtn || v_array(x) || ''', ''P30000_RETURN_ITEM,P30000_MODE'', ''';
1038:                   ELSE
1039:                       v_rtn :=
1040:                           v_rtn
1041:                           || '&lt;li class="expandedItem1"&gt;&lt;a href="javascript:createObject(30100,''';
1042:                       v_rtn := v_rtn || v_array(x) || ''', ''P30100_RETURN_ITEM,P30100_MODE'', ''';
1043:                   END IF;
1044:   
1045:                   v_rtn := v_rtn || p_page_item || ',FROM_OBJ'');"';
1046:                   v_rtn := v_rtn || ' class="expandedLink"&gt;' || y.description || '&lt;/a&gt;&lt;/li&gt;';
1047:               END LOOP;
1048:           END LOOP;
1049:   
1050:           RETURN v_rtn || '&lt;/ul&gt;';
1051:       END get_create_menu;
1052:   
1053:       FUNCTION get_current_version(p_obj IN VARCHAR2)
1054:           RETURN VARCHAR2 IS
1055:       BEGIN
1056:           FOR x IN (SELECT current_version
1057:                       FROM T_OSI_PARTICIPANT
1058:                      WHERE SID = p_obj)
1059:           LOOP
1060:               RETURN x.current_version;
1061:           END LOOP;
1062:   
1063:           RETURN NULL;
1064:       END get_current_version;
1065:   
1066:       FUNCTION get_date(p_pvop IN VARCHAR2, p_code IN VARCHAR2)
1067:           RETURN DATE IS
1068:       BEGIN
1069:           FOR x IN (SELECT   d.VALUE
1070:                         FROM T_OSI_PARTIC_DATE d, v_osi_participant_version pv, T_OSI_REFERENCE r
1071:                        WHERE (   pv.SID = p_pvop
1072:                               OR (pv.participant = p_pvop AND pv.SID = pv.current_version))
1073:                          AND d.participant_version = pv.SID
1074:                          AND d.TYPE = r.SID
1075:                          AND (   r.USAGE = 'INDIV_DATE'
1076:                               OR r.USAGE = 'NON_INDIV_DATE')
1077:                          AND r.code = p_code
1078:                     ORDER BY d.modify_on DESC)
1079:           LOOP
1080:               RETURN x.VALUE;
1081:           END LOOP;
1082:   
1083:           RETURN NULL;
1084:       EXCEPTION
1085:           WHEN OTHERS THEN
1086:               log_error('get_date: ' || SQLERRM);
1087:               RETURN 'get_date: ' || SQLERRM;
1088:       END get_date;
1089:   
1090:       FUNCTION get_details(
1091:           p_pvop          IN   VARCHAR2,
1092:           p_omit_sa       IN   VARCHAR2 := NULL,
1093:           p_for_confirm   IN   VARCHAR2 := NULL)
1094:           RETURN VARCHAR2 IS
1095:           v_rtn       VARCHAR2(4000);
1096:           v_objtype   T_CORE_OBJ_TYPE.SID%TYPE;
1097:   
1098:           FUNCTION row_start
1099:               RETURN VARCHAR2 IS
1100:           BEGIN
1101:               RETURN '&lt;TR&gt;';
1102:           END row_start;
1103:   
1104:           FUNCTION row_end
1105:               RETURN VARCHAR2 IS
1106:           BEGIN
1107:               RETURN '&lt;/TR&gt;';
1108:           END row_end;
1109:   
1110:           FUNCTION new_row(p_text IN VARCHAR2)
1111:               RETURN VARCHAR2 IS
1112:           BEGIN
1113:               RETURN row_start || p_text || row_end;
1114:           END new_row;
1115:   
1116:           FUNCTION cell_start(p_col_span IN INTEGER := 0, p_row_span IN INTEGER := 0)
1117:               RETURN VARCHAR2 IS
1118:               v_rtn   VARCHAR2(500) := '&lt;TD vAlign="top" ';
1119:           BEGIN
1120:               IF (p_col_span &gt; 0) THEN
1121:                   v_rtn := v_rtn || 'colSpan="' || p_col_span || '" ';
1122:               END IF;
1123:   
1124:               IF (p_row_span &gt; 0) THEN
1125:                   v_rtn := v_rtn || 'rowSpan="' || p_row_span || '" ';
1126:               END IF;
1127:   
1128:               RETURN v_rtn || '&gt;';
1129:           END cell_start;
1130:   
1131:           FUNCTION cell_end
1132:               RETURN VARCHAR2 IS
1133:           BEGIN
1134:               RETURN '&lt;/TD&gt;';
1135:           END cell_end;
1136:   
1137:           FUNCTION new_cell(p_text IN VARCHAR2, p_col_span IN INTEGER := 0, p_row_span IN INTEGER := 0)
1138:               RETURN VARCHAR2 IS
1139:           BEGIN
1140:               RETURN cell_start(p_col_span, p_row_span) || p_text || cell_end;
1141:           END new_cell;
1142:   
1143:           FUNCTION make_label(p_text IN VARCHAR2)
1144:               RETURN VARCHAR2 IS
1145:           BEGIN
1146:               RETURN '&lt;LABEL class="optionallabel"&gt;&lt;SPAN&gt;' || p_text || '&lt;/SPAN&gt;&lt;/LABEL&gt;';
1147:           END make_label;
1148:   
1149:           FUNCTION get_indiv_details(p_pvop IN VARCHAR2)
1150:               RETURN VARCHAR2 IS
1151:               v_name                    v_osi_participant_indiv_title.NAME%TYPE;
1152:               v_sex                     v_osi_participant_indiv_title.sex%TYPE;
1153:               v_service                 v_osi_participant_indiv_title.service%TYPE;
1154:               v_address                 v_osi_participant_indiv_title.address%TYPE;
1155:               v_dob                     v_osi_participant_indiv_title.dob%TYPE;
1156:               v_affiliation             v_osi_participant_indiv_title.affiliation%TYPE;
1157:               v_race                    v_osi_participant_indiv_title.race%TYPE;
1158:               v_component               v_osi_participant_indiv_title.component%TYPE;
1159:               v_ssn                     v_osi_participant_indiv_title.ssn%TYPE;
1160:               v_pay_plan                v_osi_participant_indiv_title.pay_plan%TYPE;
1161:               v_confirmed               v_osi_participant_indiv_title.confirmed%TYPE;
1162:               v_pay_grade               v_osi_participant_indiv_title.pay_grade%TYPE;
1163:               v_rank                    v_osi_participant_indiv_title.rank%TYPE;
1164:               v_rank_date               v_osi_participant_indiv_title.rank_date%TYPE;
1165:               v_specialty_code          v_osi_participant_indiv_title.specialty_code%TYPE;
1166:               v_military_organization   v_osi_participant_indiv_title.military_organization%TYPE;
1167:               v_format                  VARCHAR2(11);
1168:           BEGIN
1169:               IF (p_pvop IS NOT NULL) THEN
1170:                   SELECT pi.NAME, pi.sex, pi.service, pi.address, pi.dob, pi.affiliation, pi.race,
1171:                          pi.component, pi.ssn, pi.pay_plan, pi.confirmed, pi.pay_grade, pi.rank,
1172:                          pi.rank_date, pi.specialty_code, pi.military_organization
1173:                     INTO v_name, v_sex, v_service, v_address, v_dob, v_affiliation, v_race,
1174:                          v_component, v_ssn, v_pay_plan, v_confirmed, v_pay_grade, v_rank,
1175:                          v_rank_date, v_specialty_code, v_military_organization
1176:                     FROM v_osi_participant_indiv_title pi
1177:                    WHERE pi.SID = p_pvop
1178:                       OR (pi.participant = p_pvop AND pi.SID = pi.current_version);
1179:   
1180:                   v_format := Core_Util.get_config('CORE.DATE_FMT_DAY');
1181:               END IF;
1182:   
1183:               v_rtn := '&lt;TABLE class="formlayout" width="100%" border="0"&gt;&lt;TBODY&gt;';
1184:               v_rtn := v_rtn || '&lt;colgroup span="3" align="left" width="33%"&gt;&lt;/colgroup&gt;';
1185:               v_rtn := v_rtn || row_start || new_cell('Name: ' || v_name);
1186:               v_rtn := v_rtn || new_cell('Sex: ' || v_sex);
1187:   
1188:               IF (p_omit_sa IS NULL) THEN
1189:                   v_rtn := v_rtn || new_cell('Service: ' || v_service);
1190:               END IF;
1191:   
1192:               v_rtn := v_rtn || row_end;
1193:               v_rtn := v_rtn || row_start || new_cell('Address:&lt;br&gt;' || v_address, 0, 8);
1194:               v_rtn := v_rtn || new_cell('Date of Birth: ' || TO_CHAR(v_dob, v_format));
1195:   
1196:               IF (p_omit_sa IS NULL) THEN
1197:                   v_rtn := v_rtn || new_cell('Affiliation: ' || v_affiliation);
1198:               END IF;
1199:   
1200:               v_rtn := v_rtn || row_end;
1201:               v_rtn := v_rtn || row_start || new_cell('Race: ' || v_race);
1202:   
1203:               IF (p_omit_sa IS NULL) THEN
1204:                   v_rtn := v_rtn || new_cell('Component: ' || v_component);
1205:               END IF;
1206:   
1207:               v_rtn := v_rtn || row_end;
1208:               v_rtn := v_rtn || row_start || new_cell('SSN: ' || v_ssn);
1209:   
1210:               IF (p_omit_sa IS NULL) THEN
1211:                   v_rtn := v_rtn || new_cell('Pay Plan: ' || v_pay_plan);
1212:               END IF;
1213:   
1214:               v_rtn := v_rtn || row_end;
1215:               v_rtn := v_rtn || row_start || new_cell('Confirmed: ' || v_confirmed);
1216:   
1217:               IF (p_omit_sa IS NULL) THEN
1218:                   v_rtn := v_rtn || new_cell('Pay Grade: ' || v_pay_grade);
1219:                   v_rtn := v_rtn || row_end;
1220:                   v_rtn := v_rtn || row_start || new_cell('');
1221:                   v_rtn := v_rtn || new_cell('Rank: ' || v_rank);
1222:                   v_rtn := v_rtn || row_end;
1223:                   v_rtn := v_rtn || row_start || new_cell('');
1224:                   v_rtn := v_rtn || new_cell('Rank Date: ' || TO_CHAR(v_rank_date, v_format));
1225:                   v_rtn := v_rtn || row_end;
1226:                   v_rtn := v_rtn || row_start || new_cell('');
1227:                   v_rtn := v_rtn || new_cell('Specialty: ' || v_specialty_code);
1228:                   v_rtn := v_rtn || row_end;
1229:                   v_rtn := v_rtn || row_start || new_cell('');
1230:                   v_rtn := v_rtn || new_cell('Military Organization: ' || v_military_organization);
1231:               END IF;
1232:   
1233:               v_rtn := v_rtn || row_end || '&lt;/TBODY&gt;&lt;/TABLE&gt;';
1234:               RETURN v_rtn;
1235:           END get_indiv_details;
1236:   
1237:           FUNCTION get_nonindiv_details(p_pvop IN VARCHAR2)
1238:               RETURN VARCHAR2 IS
1239:               v_name        VARCHAR2(100);
1240:               v_confirmed   VARCHAR2(20);
1241:               v_subtype     VARCHAR2(100);
1242:               v_address     VARCHAR2(4000);
1243:               v_acronym     v_osi_participant_version.current_name%TYPE;
1244:               v_cage        v_osi_participant_version.co_cage%TYPE;
1245:               v_uic         v_osi_participant_version.org_uic%TYPE;
1246:           BEGIN
1247:               v_name := get_name(p_pvop);
1248:               v_confirmed := get_confirmation(p_pvop);
1249:               v_subtype := get_subtype(p_pvop);
1250:   
1251:               SELECT co_cage, org_uic, Osi_Address.get_addr_display(current_address, NULL, '&lt;br&gt;'),
1252:                      current_name
1253:                 INTO v_cage, v_uic, v_address,
1254:                      v_acronym
1255:                 FROM v_osi_participant_version
1256:                WHERE SID = p_pvop
1257:                   OR (SID = current_version AND participant = p_pvop);
1258:   
1259:               v_rtn := '&lt;TABLE class="formlayout" width="100%" border="0"&gt;&lt;TBODY&gt;';
1260:               v_rtn := v_rtn || '&lt;colgroup span="3" align="left" width="33%"&gt;&lt;/colgroup&gt;';
1261:   
1262:               CASE v_objtype
1263:                   WHEN Core_Obj.lookup_objtype('PART.NONINDIV.PROG') THEN
1264:                       v_rtn := v_rtn || row_start || new_cell('Program: ' || v_name) || row_end;
1265:                       v_rtn := v_rtn || row_start || new_cell('Confirmed: ' || v_confirmed);
1266:   
1267:                       IF (p_for_confirm IS NOT NULL) THEN
1268:                           BEGIN
1269:                               SELECT first_name
1270:                                 INTO v_name
1271:                                 FROM v_osi_partic_name
1272:                                WHERE SID = v_acronym;
1273:                           EXCEPTION
1274:                               WHEN NO_DATA_FOUND THEN
1275:                                   v_name := NULL;
1276:                           END;
1277:   
1278:                           v_rtn := v_rtn || row_start || new_cell('Acronym: ' || v_name);
1279:                           v_rtn := v_rtn || row_start || new_cell('Address:&lt;br&gt;' || v_address);
1280:                       END IF;
1281:   
1282:                       v_rtn := v_rtn || row_end;
1283:                   WHEN Core_Obj.lookup_objtype('PART.NONINDIV.ORG') THEN
1284:                       v_rtn := v_rtn || row_start || new_cell('Organization: ' || v_name, 0, 3);
1285:                       v_rtn := v_rtn || new_cell('Subtype: ' || v_subtype) || row_end;
1286:                       v_rtn := v_rtn || row_start || new_cell('UIC/PAS: ' || v_uic) || row_end;
1287:                       v_rtn := v_rtn || row_start || new_cell('Confirmed: ' || v_confirmed);
1288:   
1289:                       IF (p_for_confirm IS NOT NULL) THEN
1290:                           v_rtn := v_rtn || row_start || new_cell('Address:&lt;br&gt;' || v_address);
1291:                       END IF;
1292:   
1293:                       v_rtn := v_rtn || row_end;
1294:                   WHEN Core_Obj.lookup_objtype('PART.NONINDIV.COMP') THEN
1295:                       v_rtn := v_rtn || row_start || new_cell('Company: ' || v_name, 0, 3);
1296:                       v_rtn := v_rtn || new_cell('Subtype: ' || v_subtype) || row_end;
1297:                       v_rtn := v_rtn || row_start || new_cell('Cage Code: ' || v_cage) || row_end;
1298:                       v_rtn := v_rtn || row_start || new_cell('Confirmed: ' || v_confirmed);
1299:   
1300:                       IF (p_for_confirm IS NOT NULL) THEN
1301:                           v_rtn := v_rtn || row_start || new_cell('Address:&lt;br&gt;' || v_address);
1302:                       END IF;
1303:   
1304:                       v_rtn := v_rtn || row_end;
1305:               END CASE;
1306:   
1307:               v_rtn := v_rtn || '&lt;/TBODY&gt;&lt;/TABLE&gt;';
1308:               RETURN v_rtn;
1309:           END get_nonindiv_details;
1310:       BEGIN
1311:           IF (p_pvop IS NOT NULL) THEN
1312:               v_objtype := get_type_sid(p_pvop);
1313:   
1314:               IF (v_objtype = Core_Obj.lookup_objtype('PART.INDIV')) THEN
1315:                   RETURN get_indiv_details(p_pvop);
1316:               ELSE
1317:                   RETURN get_nonindiv_details(p_pvop);
1318:               END IF;
1319:           END IF;
1320:   
1321:           RETURN NULL;
1322:       EXCEPTION
1323:           WHEN OTHERS THEN
1324:               log_error('get_details: ' || SQLERRM);
1325:               RETURN 'get_details: ' || SQLERRM;
1326:       END get_details;
1327:   
1328:       FUNCTION get_id(p_obj IN VARCHAR2, p_obj_context VARCHAR2)
1329:           RETURN VARCHAR2 IS
1330:       BEGIN
1331:           IF (p_obj_context IS NULL) THEN
1332:               RETURN get_version_label(get_current_version(p_obj), 1);
1333:           ELSE
1334:               RETURN get_version_label(p_obj_context, 1);
1335:           END IF;
1336:       END get_id;
1337:   
1338:       FUNCTION get_image_sid
1339:           RETURN VARCHAR2 IS
1340:       BEGIN
1341:           RETURN v_image_sid;
1342:       END get_image_sid;
1343:   
1344:       FUNCTION get_mil_member_name(p_pvop IN VARCHAR2)
1345:           RETURN VARCHAR2 IS
1346:           v_rtn   VARCHAR2(200);
1347:       BEGIN
1348:           BEGIN
1349:               FOR x IN (SELECT   pr.partic_b
1350:                             FROM T_OSI_PARTIC_RELATION pr, v_osi_participant_version pv
1351:                            WHERE (   pv.SID = p_pvop
1352:                                   OR (pv.participant = p_pvop AND pv.SID = current_version))
1353:                              AND pr.partic_a = pv.participant
1354:                              AND pr.end_date IS NULL
1355:                              AND Osi_Participant.get_subtype_sid(pr.partic_b) =
1356:                                              Osi_Reference.lookup_ref_sid('PART.NONINDIV.ORG', 'POUM')
1357:                         ORDER BY pr.start_date DESC)
1358:               LOOP
1359:                   v_rtn := get_name(x.partic_b);
1360:                   EXIT;
1361:               END LOOP;
1362:           EXCEPTION
1363:               WHEN NO_DATA_FOUND THEN
1364:                   v_rtn := NULL;
1365:           END;
1366:   
1367:           RETURN v_rtn;
1368:       EXCEPTION
1369:           WHEN OTHERS THEN
1370:               log_error('get_mil_member_name: ' || SQLERRM);
1371:               RETURN 'get_mil_member_name: ' || SQLERRM;
1372:       END get_mil_member_name;
1373:   
1374:       FUNCTION get_name(p_pvop IN VARCHAR2)
1375:           RETURN VARCHAR2 IS
1376:           v_program   T_CORE_OBJ_TYPE.SID%TYPE;
1377:       BEGIN
1378:           v_program := Core_Obj.lookup_objtype('PART.NONINDIV.PROG');
1379:   
1380:           FOR x IN (SELECT /*+FIRST_ROWS*/  RTRIM(RTRIM(pn.last_name
1381:                                        || DECODE(pv.obj_type, v_program, '', ', ' || pn.first_name)
1382:                                        || ' ' || pn.middle_name,
1383:                                        ' '),
1384:                                  ',')
1385:                            || DECODE(pv.org_majcom, NULL, '', ' (' || pv.org_majcom_desc || ')')
1386:                                                                                              AS NAME
1387:                       FROM T_OSI_PARTIC_NAME pn, v_osi_participant_version pv
1388:                      WHERE (   pv.SID = p_pvop
1389:                             OR (pv.participant = p_pvop AND pv.SID = pv.current_version))
1390:                        AND (pn.SID = pv.current_name))
1391:           LOOP
1392:               RETURN x.NAME;
1393:           END LOOP;
1394:   
1395:           RETURN NULL;
1396:       EXCEPTION
1397:           WHEN OTHERS THEN
1398:               log_error('get_name: ' || SQLERRM);
1399:               RETURN 'get_name: ' || SQLERRM;
1400:       END get_name;
1401:   
1402:       FUNCTION get_name_type(p_pvop IN VARCHAR2)
1403:           RETURN VARCHAR2 IS
1404:       BEGIN
1405:           FOR x IN (SELECT t.description
1406:                       FROM v_osi_participant_version pv,
1407:                            T_OSI_PARTIC_NAME pn,
1408:                            T_OSI_PARTIC_NAME_TYPE t
1409:                      WHERE (   pv.SID = p_pvop
1410:                             OR (pv.participant = p_pvop AND pv.SID = pv.current_version))
1411:                        AND pn.SID = pv.current_name
1412:                        AND pn.name_type = t.SID)
1413:           LOOP
1414:               RETURN x.description;
1415:           END LOOP;
1416:   
1417:           RETURN NULL;
1418:       EXCEPTION
1419:           WHEN OTHERS THEN
1420:               log_error('get_name_type: ' || SQLERRM);
1421:               RETURN 'get_name_type: ' || SQLERRM;
1422:       END get_name_type;
1423:   
1424:       FUNCTION get_next_version(p_version IN VARCHAR2)
1425:           RETURN VARCHAR2 IS
1426:           v_partic    T_OSI_PARTICIPANT.SID%TYPE;
1427:           v_version   T_OSI_PARTICIPANT_VERSION.SID%TYPE;
1428:       BEGIN
1429:           v_partic := get_participant(p_version);
1430:   
1431:           IF (v_partic IS NULL) THEN
1432:               -- An invalid version sid was given.
1433:               log_error('get_next_version: Unknown version given.');
1434:               RETURN NULL;
1435:           END IF;
1436:   
1437:           SELECT SID
1438:             INTO v_version
1439:             FROM (SELECT   SID
1440:                       FROM T_OSI_PARTICIPANT_VERSION
1441:                      WHERE participant = v_partic AND SID &gt; p_version
1442:                   ORDER BY SID ASC)
1443:            WHERE ROWNUM = 1;
1444:   
1445:           RETURN v_version;
1446:       EXCEPTION
1447:           WHEN NO_DATA_FOUND THEN
1448:               RETURN NULL;
1449:           WHEN OTHERS THEN
1450:               log_error('get_next_version: ' || SQLERRM);
1451:               RETURN 'get_next_version: ' || SQLERRM;
1452:       END get_next_version;
1453:   
1454:       FUNCTION get_previous_version(p_version IN VARCHAR2)
1455:           RETURN VARCHAR2 IS
1456:           v_partic    T_OSI_PARTICIPANT.SID%TYPE;
1457:           v_version   T_OSI_PARTICIPANT_VERSION.SID%TYPE;
1458:       BEGIN
1459:           v_partic := get_participant(p_version);
1460:   
1461:           IF (v_partic IS NULL) THEN
1462:               -- An invalid version sid was given.
1463:               log_error('get_previous_version: Unknown version given.');
1464:               RETURN NULL;
1465:           END IF;
1466:   
1467:           SELECT SID
1468:             INTO v_version
1469:             FROM (SELECT   SID
1470:                       FROM T_OSI_PARTICIPANT_VERSION
1471:                      WHERE participant = v_partic AND SID &lt; p_version
1472:                   ORDER BY SID DESC)
1473:            WHERE ROWNUM = 1;
1474:   
1475:           RETURN v_version;
1476:       EXCEPTION
1477:           WHEN NO_DATA_FOUND THEN
1478:               RETURN NULL;
1479:           WHEN OTHERS THEN
1480:               log_error('get_previous_version: ' || SQLERRM);
1481:               RETURN 'get_previous_version: ' || SQLERRM;
1482:       END get_previous_version;
1483:   
1484:       FUNCTION get_number(p_pvop IN VARCHAR2, p_code IN VARCHAR2)
1485:           RETURN VARCHAR2 IS
1486:           v_obj_code   T_CORE_OBJ_TYPE.code%TYPE;
1487:       BEGIN
1488:           SELECT code
1489:             INTO v_obj_code
1490:             FROM T_CORE_OBJ_TYPE
1491:            WHERE SID = get_type_sid(p_pvop);
1492:   
1493:           IF (v_obj_code = 'PART.INDIV') THEN
1494:               FOR x IN (SELECT pn.num_value
1495:                           FROM T_OSI_PARTIC_NUMBER pn,
1496:                                T_OSI_PARTIC_NUMBER_TYPE nt,
1497:                                v_osi_participant_version pv
1498:                          WHERE (   pv.SID = p_pvop
1499:                                 OR (pv.participant = p_pvop AND pv.SID = current_version))
1500:                            AND pn.participant_version = pv.SID
1501:                            AND pn.num_type = nt.SID
1502:                            AND nt.code = p_code)
1503:               LOOP
1504:                   RETURN x.num_value;
1505:               END LOOP;
1506:           ELSE
1507:               FOR x IN (SELECT DECODE(v_obj_code,
1508:                                       'PART.NONINDIV.COMP', co_cage,
1509:                                       'PART.NONINDIV.ORG', org_uic) AS num_value
1510:                           FROM v_osi_participant_version
1511:                          WHERE SID = p_pvop
1512:                             OR (participant = p_pvop AND SID = current_version))
1513:               LOOP
1514:                   RETURN x.num_value;
1515:               END LOOP;
1516:           END IF;
1517:   
1518:           RETURN NULL;
1519:       EXCEPTION
1520:           WHEN OTHERS THEN
1521:               log_error('get_number: ' || SQLERRM);
1522:               RETURN 'get_number: ' || SQLERRM;
1523:       END get_number;
1524:   
1525:       FUNCTION get_org_member(p_pvop IN VARCHAR2)
1526:           RETURN VARCHAR2 IS
1527:           v_rtn   VARCHAR2(200);
1528:       BEGIN
1529:           BEGIN
1530:               FOR x IN (SELECT   pr.SID
1531:                             FROM v_osi_partic_relation_2way pr,
1532:                                  v_osi_participant_version pv,
1533:                                  T_OSI_PARTIC_RELATION_TYPE rt
1534:                            WHERE (   pv.SID = p_pvop
1535:                                   OR (pv.participant = p_pvop AND pv.SID = pv.current_version))
1536:                              AND pr.this_partic = pv.participant
1537:                              AND (   pr.end_date IS NULL
1538:                                   OR pr.end_date &gt; SYSDATE)
1539:                              AND pr.rel_type = rt.SID
1540:                              AND rt.code IN('IMOU', 'HUM', 'IMO', 'HM')
1541:                         ORDER BY NVL(pr.start_date, pr.modify_on) DESC)
1542:               LOOP
1543:                   v_rtn := x.SID;
1544:                   EXIT;
1545:               END LOOP;
1546:           EXCEPTION
1547:               WHEN NO_DATA_FOUND THEN
1548:                   v_rtn := NULL;
1549:           END;
1550:   
1551:           RETURN v_rtn;
1552:       EXCEPTION
1553:           WHEN OTHERS THEN
1554:               log_error('get_org_member: ' || SQLERRM);
1555:               RETURN 'get_org_member: ' || SQLERRM;
1556:       END get_org_member;
1557:   
1558:       FUNCTION get_org_member_name(p_pvop IN VARCHAR2)
1559:           RETURN VARCHAR2 IS
1560:           v_rtn   VARCHAR2(200);
1561:       BEGIN
1562:           v_rtn := get_name(get_org_member(p_pvop));
1563:           RETURN v_rtn;
1564:       EXCEPTION
1565:           WHEN OTHERS THEN
1566:               log_error('get_org_member_name: ' || SQLERRM);
1567:               RETURN 'get_org_member_name: ' || SQLERRM;
1568:       END get_org_member_name;
1569:   
1570:       FUNCTION get_org_member_addr(p_pvop IN VARCHAR2)
1571:           RETURN VARCHAR2 IS
1572:           v_rtn   VARCHAR2(200);
1573:       BEGIN
1574:           v_rtn := Osi_Address.get_addr_display(Osi_Address.get_address_sid(get_org_member(p_pvop)));
1575:           RETURN v_rtn;
1576:       EXCEPTION
1577:           WHEN OTHERS THEN
1578:               log_error('get_org_member_addr: ' || SQLERRM);
1579:               RETURN 'get_org_member_addr: ' || SQLERRM;
1580:       END get_org_member_addr;
1581:   
1582:       FUNCTION get_participant(p_version IN VARCHAR2)
1583:           RETURN VARCHAR2 IS
1584:           v_sid   T_OSI_PARTICIPANT.SID%TYPE;
1585:       BEGIN
1586:           SELECT participant
1587:             INTO v_sid
1588:             FROM T_OSI_PARTICIPANT_VERSION
1589:            WHERE SID = p_version;
1590:   
1591:           RETURN v_sid;
1592:       EXCEPTION
1593:           WHEN NO_DATA_FOUND THEN
1594:               RETURN NULL;
1595:           WHEN OTHERS THEN
1596:               log_error('get_participant: ' || SQLERRM);
1597:               RETURN 'get_participant: ' || SQLERRM;
1598:       END get_participant;
1599:   
1600:       FUNCTION get_rank(p_pvop IN VARCHAR2)
1601:           RETURN VARCHAR2 IS
1602:       BEGIN
1603:           FOR x IN (SELECT sa_rank AS rank
1604:                       FROM v_osi_participant_version
1605:                      WHERE SID = p_pvop
1606:                         OR (participant = p_pvop AND SID = current_version))
1607:           LOOP
1608:               RETURN x.rank;
1609:           END LOOP;
1610:   
1611:           RETURN NULL;
1612:       EXCEPTION
1613:           WHEN OTHERS THEN
1614:               log_error('get_rank: ' || SQLERRM);
1615:               RETURN 'get_rank: ' || SQLERRM;
1616:       END get_rank;
1617:   
1618:       FUNCTION get_relation_specifics(p_sid IN VARCHAR2)
1619:           RETURN VARCHAR2 IS
1620:           v_specifics    VARCHAR2(3300);
1621:           v_mod1_name    T_OSI_PARTIC_RELATION_TYPE.mod1_name%TYPE;
1622:           v_mod2_name    T_OSI_PARTIC_RELATION_TYPE.mod2_name%TYPE;
1623:           v_mod3_name    T_OSI_PARTIC_RELATION_TYPE.mod3_name%TYPE;
1624:           v_mod1_value   T_OSI_PARTIC_RELATION.mod1_value%TYPE;
1625:           v_mod2_value   T_OSI_PARTIC_RELATION.mod2_value%TYPE;
1626:           v_mod3_value   T_OSI_PARTIC_RELATION.mod3_value%TYPE;
1627:       BEGIN
1628:           SELECT t.mod1_name, t.mod2_name, t.mod3_name, r.mod1_value, r.mod2_value, r.mod3_value
1629:             INTO v_mod1_name, v_mod2_name, v_mod3_name, v_mod1_value, v_mod2_value, v_mod3_value
1630:             FROM T_OSI_PARTIC_RELATION_TYPE t, T_OSI_PARTIC_RELATION r
1631:            WHERE r.SID = p_sid AND r.rel_type = t.SID;
1632:   
1633:           IF (v_mod1_value IS NOT NULL) THEN
1634:               Core_Util.append_info(v_specifics, v_mod1_name);
1635:               Core_Util.append_info(v_specifics, v_mod1_value, ': ');
1636:           END IF;
1637:   
1638:           IF (v_mod2_value IS NOT NULL) THEN
1639:               Core_Util.append_info(v_specifics, v_mod2_name);
1640:               Core_Util.append_info(v_specifics, v_mod2_value, ': ');
1641:           END IF;
1642:   
1643:           IF (v_mod3_value IS NOT NULL) THEN
1644:               Core_Util.append_info(v_specifics, v_mod3_name);
1645:               Core_Util.append_info(v_specifics, v_mod3_value, ': ');
1646:           END IF;
1647:   
1648:           RETURN v_specifics;
1649:       END get_relation_specifics;
1650:   
1651:       FUNCTION get_subtype(p_pvop IN VARCHAR2)
1652:           RETURN VARCHAR2 IS
1653:           v_subtype   T_OSI_REFERENCE.SID%TYPE;
1654:           v_rtn       VARCHAR2(100);
1655:       BEGIN
1656:           SELECT sub_type
1657:             INTO v_subtype
1658:             FROM v_osi_participant_version
1659:            WHERE SID = p_pvop
1660:               OR (participant = p_pvop AND SID = current_version);
1661:   
1662:           IF (v_subtype IS NULL) THEN
1663:               v_rtn := 'Not Applicable';
1664:           ELSE
1665:               SELECT description
1666:                 INTO v_rtn
1667:                 FROM T_OSI_REFERENCE
1668:                WHERE SID = v_subtype;
1669:           END IF;
1670:   
1671:           RETURN v_rtn;
1672:       EXCEPTION
1673:           WHEN OTHERS THEN
1674:               log_error('get_subtype: ' || SQLERRM);
1675:               RETURN 'get_subtype: ' || SQLERRM;
1676:       END get_subtype;
1677:   
1678:       FUNCTION get_subtype_sid(p_pvop IN VARCHAR2)
1679:           RETURN VARCHAR2 IS
1680:           v_subtype   T_OSI_REFERENCE.SID%TYPE;
1681:           v_rtn       T_OSI_PARTICIPANT_NONHUMAN.sub_type%TYPE;
1682:       BEGIN
1683:           SELECT sub_type
1684:             INTO v_subtype
1685:             FROM v_osi_participant_version
1686:            WHERE SID = p_pvop
1687:               OR (participant = p_pvop AND SID = current_version);
1688:   
1689:           IF (v_subtype IS NULL) THEN
1690:               v_rtn := NULL;
1691:           ELSE
1692:               SELECT SID
1693:                 INTO v_rtn
1694:                 FROM T_OSI_REFERENCE
1695:                WHERE SID = v_subtype;
1696:           END IF;
1697:   
1698:           RETURN v_rtn;
1699:       EXCEPTION
1700:           WHEN OTHERS THEN
1701:               log_error('get_subtype: ' || SQLERRM);
1702:               RETURN 'get_subtype: ' || SQLERRM;
1703:       END get_subtype_sid;
1704:   
1705:       FUNCTION get_type(p_pvop IN VARCHAR2)
1706:           RETURN VARCHAR2 IS
1707:           v_type   v_osi_participant_version.obj_type_desc%TYPE;
1708:       BEGIN
1709:           SELECT obj_type_desc
1710:             INTO v_type
1711:             FROM v_osi_participant_version
1712:            WHERE SID = p_pvop
1713:               OR (participant = p_pvop AND SID = current_version);
1714:   
1715:           RETURN v_type;
1716:       EXCEPTION
1717:           WHEN OTHERS THEN
1718:               log_error('get_type: ' || SQLERRM);
1719:               RETURN 'get_type: ' || SQLERRM;
1720:       END get_type;
1721:   
1722:       FUNCTION get_type_sid(p_popv IN VARCHAR2)
1723:           RETURN VARCHAR2 IS
1724:           v_sid   T_CORE_OBJ_TYPE.SID%TYPE;
1725:       BEGIN
1726:           --Assume it's a participant sid.
1727:           BEGIN
1728:               SELECT Core_Obj.get_objtype(p.SID)
1729:                 INTO v_sid
1730:                 FROM T_OSI_PARTICIPANT p
1731:                WHERE p.SID = p_popv;
1732:           EXCEPTION
1733:               WHEN NO_DATA_FOUND THEN
1734:                   --Must be a version sid.
1735:                   SELECT Core_Obj.get_objtype(pv.participant)
1736:                     INTO v_sid
1737:                     FROM T_OSI_PARTICIPANT_VERSION pv
1738:                    WHERE pv.SID = p_popv;
1739:           END;
1740:   
1741:           RETURN v_sid;
1742:       EXCEPTION
1743:           WHEN OTHERS THEN
1744:               log_error('get_type_sid: ' || SQLERRM);
1745:               RETURN 'get_type_sid: ' || SQLERRM;
1746:       END get_type_sid;
1747:   
1748:       FUNCTION get_tagline(p_pvop IN VARCHAR2)
1749:           RETURN VARCHAR2 IS
1750:       BEGIN
1751:           RETURN get_name(p_pvop);
1752:       EXCEPTION
1753:           WHEN OTHERS THEN
1754:               log_error('get_tagline: ' || SQLERRM);
1755:               RETURN 'get_tagline: ' || SQLERRM;
1756:       END get_tagline;
1757:   
1758:       FUNCTION get_type_lov(p_type_list IN VARCHAR2 := 'ALL')
1759:           RETURN VARCHAR2 IS
1760:           v_lov    VARCHAR2(200);
1761:           v_code   VARCHAR2(200);
1762:           v_desc   VARCHAR2(200);
1763:       BEGIN
1764:           IF p_type_list = 'ALL' THEN
1765:               Core_Util.append_info(v_lov, 'All Participant Types;ALL');
1766:               Core_Util.append_info(v_lov, 'Companies;PART.NONINDIV.COMP');
1767:               Core_Util.append_info(v_lov, 'Individuals by Name;PART.INDIV');
1768:               Core_Util.append_info(v_lov, 'Organizations;PART.NONINDIV.ORG');
1769:               Core_Util.append_info(v_lov, 'Programs;PART.NONINDIV.PROG');
1770:           ELSE
1771:               FOR a IN 1 .. 4
1772:               LOOP
1773:                   v_code := Core_List.get_list_element(p_type_list, a);
1774:   
1775:                   BEGIN
1776:                       SELECT description
1777:                         INTO v_desc
1778:                         FROM T_CORE_OBJ_TYPE
1779:                        WHERE code = v_code;
1780:                   EXCEPTION
1781:                       WHEN NO_DATA_FOUND THEN
1782:                           v_desc := NULL;
1783:                   END;
1784:   
1785:                   IF v_desc IS NOT NULL THEN
1786:                       Core_Util.append_info(v_lov, v_desc || ';' || v_code);
1787:                   END IF;
1788:               END LOOP;
1789:           END IF;
1790:   
1791:           RETURN v_lov;
1792:       EXCEPTION
1793:           WHEN OTHERS THEN
1794:               log_error('get_type_lov: ' || SQLERRM);
1795:               RETURN 'get_type_lov: ' || SQLERRM;
1796:       END get_type_lov;
1797:   
1798:       FUNCTION get_version_label(p_pv IN VARCHAR2, p_short_label IN VARCHAR2 := NULL)
1799:           RETURN VARCHAR2 IS
1800:           v_rtn       VARCHAR2(100);
1801:           v_sid       VARCHAR2(20);
1802:           v_current   VARCHAR2(20);
1803:           v_by        VARCHAR2(100);
1804:           v_date      VARCHAR2(11);
1805:           v_time      VARCHAR2(8);
1806:           v_format    VARCHAR2(30);
1807:       BEGIN
1808:           v_format := Core_Util.get_config('CORE.DATE_FMT_DAY');
1809:           v_current := get_current_version(get_participant(p_pv));
1810:   
1811:           IF (v_current = p_pv) THEN
1812:               v_sid := v_current;
1813:               v_rtn := 'Current';
1814:           ELSE
1815:               v_sid := p_pv;
1816:               v_rtn := 'Previous';
1817:           END IF;
1818:   
1819:           IF (p_short_label IS NOT NULL) THEN
1820:               RETURN v_rtn || ' Version';
1821:           END IF;
1822:   
1823:           SELECT TO_CHAR(create_on, v_format), TO_CHAR(create_on, 'HH12:MI AM'), create_by
1824:             INTO v_date, v_time, v_by
1825:             FROM T_OSI_PARTICIPANT_VERSION
1826:            WHERE SID = v_sid;
1827:   
1828:           RETURN v_rtn || ' version created by ' || v_by || ' on ' || v_date || ' at ' || v_time;
1829:   
1830:       END get_version_label;
1831:   
1832:       FUNCTION has_isn_number(p_pvop IN VARCHAR2)
1833:           RETURN VARCHAR2 IS
1834:           v_rtn          VARCHAR2(1);
1835:           v_isn_exists   NUMBER;
1836:           v_isn_type     T_OSI_REFERENCE.SID%TYPE;
1837:       BEGIN
1838:           -- Check for the existence of ISN number type.
1839:           v_isn_type := Osi_Reference.lookup_ref_sid('INDIV_NUM', 'ISN');
1840:   
1841:           IF (v_isn_type IS NOT NULL) THEN
1842:               SELECT COUNT(pn.SID)
1843:                 INTO v_isn_exists
1844:                 FROM v_osi_participant_version pv, T_OSI_PARTIC_NUMBER pn
1845:                WHERE pv.SID = p_pvop
1846:                   OR     (pv.participant = p_pvop AND pv.current_version = pv.SID)
1847:                      AND pv.SID = pn.participant_version
1848:                      AND pn.num_type = v_isn_type;
1849:           END IF;
1850:   
1851:           IF (v_isn_exists &gt; 0) THEN
1852:               v_rtn := 'Y';
1853:           ELSE
1854:               v_rtn := 'N';
1855:           END IF;
1856:   
1857:           RETURN v_rtn;
1858:       EXCEPTION
1859:           WHEN OTHERS THEN
1860:               log_error('has_isn_number: ' || SQLERRM);
1861:               RAISE;
1862:       END has_isn_number;
1863:   
1864:       FUNCTION check_for_duplicates(p_obj IN VARCHAR2)
1865:           RETURN VARCHAR2 IS
1866:           v_target            v_osi_participant_version%ROWTYPE;
1867:           v_indiv             T_CORE_OBJ_TYPE.SID%TYPE;
1868:           v_comp              T_CORE_OBJ_TYPE.SID%TYPE;
1869:           v_org               T_CORE_OBJ_TYPE.SID%TYPE;
1870:           v_prog              T_CORE_OBJ_TYPE.SID%TYPE;
1871:           v_confirm_allowed   VARCHAR2(1);
1872:           v_do_soundex        BOOLEAN;
1873:           v_score             NUMBER                              := 0;
1874:           v_max_score         NUMBER                              := 0;
1875:           v_id_count          NUMBER;
1876:           v_ssn_count         NUMBER;
1877:           v_info              VARCHAR2(200);
1878:       BEGIN
1879:           v_messages := NULL;
1880:           v_session := NULL;
1881:           v_confirm_allowed := 'Y';
1882:           v_indiv := Core_Obj.lookup_objtype('PART.INDIV');
1883:           v_comp := Core_Obj.lookup_objtype('PART.NONINDIV.COMP');
1884:           v_org := Core_Obj.lookup_objtype('PART.NONINDIV.ORG');
1885:           v_prog := Core_Obj.lookup_objtype('PART.NONINDIV.PROG');
1886:   
1887:           -- This is the new participant that we want to verfiy doesn't already exist.
1888:           SELECT *
1889:             INTO v_target
1890:             FROM v_osi_participant_version
1891:            WHERE SID = current_version AND participant = p_obj;
1892:   
1893:           -- This loops over all the other confirmed participants.
1894:           FOR x IN (SELECT v.SID, v.dob, v.participant, v.obj_type, v.co_cage, v.co_duns, v.org_uic,
1895:                            v.sex
1896:                       FROM v_osi_participant_version v
1897:                      WHERE v.SID = v.current_version
1898:                        AND v.confirm_on IS NOT NULL
1899:                        AND v.obj_type = v_target.obj_type
1900:                        AND v.SID &lt;&gt; v_target.SID)
1901:           LOOP
1902:               v_score := 0;
1903:               v_info := NULL;
1904:   
1905:               -- Check DOB.
1906:               IF (x.dob = v_target.dob) THEN
1907:                   v_score := v_score + 20;
1908:                   v_info := v_info || 'Same birth date. ';
1909:               END IF;
1910:   
1911:               -- Check identifying numbers for each participant type.
1912:               -- Individual
1913:               IF (v_target.obj_type = v_indiv) THEN
1914:                   FOR n IN (SELECT DISTINCT nt.code, UPPER(pn.num_value) AS num_value
1915:                                        FROM T_OSI_PARTIC_NUMBER pn, T_OSI_PARTIC_NUMBER_TYPE nt
1916:                                       WHERE pn.participant_version = x.SID AND pn.num_type = nt.SID
1917:                             INTERSECT
1918:                             SELECT DISTINCT nt.code, UPPER(pn.num_value) AS num_value
1919:                                        FROM T_OSI_PARTIC_NUMBER pn, T_OSI_PARTIC_NUMBER_TYPE nt
1920:                                       WHERE pn.participant_version = v_target.SID
1921:                                         AND pn.num_type = nt.SID)
1922:                   LOOP
1923:                       IF (n.code = 'SSN') THEN
1924:                           v_score := v_score + 75;
1925:                           v_info := v_info || 'Same SSN. ';
1926:                           EXIT;
1927:                       END IF;
1928:   
1929:                       v_score := v_score + 50;
1930:                       v_info := v_info || 'Same indentifying number. ';
1931:                       EXIT;
1932:                   END LOOP;
1933:               END IF;
1934:   
1935:               -- Company
1936:               IF (v_target.obj_type = v_comp) THEN
1937:                   IF (UPPER(x.co_cage) = UPPER(v_target.co_cage)) THEN
1938:                       v_score := v_score + 75;
1939:                       v_info := v_info || 'Same CAGE Code. ';
1940:                   END IF;
1941:   
1942:                   IF (UPPER(x.co_duns) = UPPER(v_target.co_duns)) THEN
1943:                       v_score := v_score + 75;
1944:                       v_info := v_info || 'Same DUNS. ';
1945:                   END IF;
1946:               END IF;
1947:   
1948:               -- Organization
1949:               IF (v_target.obj_type = v_org) THEN
1950:                   IF (UPPER(x.org_uic) = UPPER(v_target.org_uic)) THEN
1951:                       v_score := v_score + 75;
1952:                       v_info := v_info || 'Same UIC. ';
1953:                   END IF;
1954:               END IF;
1955:   
1956:               -- Program
1957:               IF (v_target.obj_type = v_prog) THEN
1958:                   -- Check relationship contracts.
1959:                   FOR r IN (SELECT DISTINCT related_to
1960:                                        FROM v_osi_partic_relation
1961:                                       WHERE this_participant = x.SID
1962:                                         AND relation_code IN('ICB', 'ICF')
1963:                             INTERSECT
1964:                             SELECT DISTINCT related_to
1965:                                        FROM v_osi_partic_relation
1966:                                       WHERE this_participant = v_target.SID
1967:                                         AND relation_code IN('ICB', 'ICF'))
1968:                   LOOP
1969:                       v_score := v_score + 10;
1970:                       v_info := v_info || 'Same contractor. ';
1971:                       EXIT;
1972:                   END LOOP;
1973:   
1974:                   FOR r IN (SELECT DISTINCT UPPER(specifics)
1975:                                        FROM v_osi_partic_relation
1976:                                       WHERE this_participant = x.SID
1977:                                             AND relation_code IN('ICB', 'ICF')
1978:                             INTERSECT
1979:                             SELECT DISTINCT UPPER(specifics)
1980:                                        FROM v_osi_partic_relation
1981:                                       WHERE this_participant = v_target.SID
1982:                                         AND relation_code IN('ICB', 'ICF'))
1983:                   LOOP
1984:                       v_score := v_score + 10;
1985:                       v_info := v_info || 'Same contract number. ';
1986:                       EXIT;
1987:                   END LOOP;
1988:               END IF;
1989:   
1990:               -- Check the names.
1991:               IF (v_score &lt; 80 AND v_max_score &lt; 80) THEN
1992:                   v_do_soundex := TRUE;
1993:   
1994:                   FOR n IN (SELECT DISTINCT UPPER(last_name),
1995:                                             UPPER(SUBSTR(NVL(first_name, ' '), 1, 1))
1996:                                                                                     AS first_initial
1997:                                        FROM v_osi_partic_name
1998:                                       WHERE participant_version = x.SID AND type_code &lt;&gt; 'A'
1999:                             INTERSECT
2000:                             SELECT DISTINCT UPPER(last_name),
2001:                                             UPPER(SUBSTR(NVL(first_name, ' '), 1, 1))
2002:                                                                                     AS first_initial
2003:                                        FROM v_osi_partic_name
2004:                                       WHERE participant_version = v_target.SID AND type_code &lt;&gt; 'A')
2005:                   LOOP
2006:                       v_score := v_score + 50;
2007:                       v_info := v_info || 'Same name';
2008:   
2009:                       IF (v_target.obj_type = v_prog) THEN
2010:                           v_info := v_info || ' (or acronym)';
2011:                       END IF;
2012:   
2013:                       v_info := v_info || '. ';
2014:                       v_do_soundex := FALSE;
2015:                       EXIT;
2016:                   END LOOP;
2017:               END IF;
2018:   
2019:               IF (v_score &lt; 75 AND v_score &gt; 15 AND v_max_score &lt; 80 AND v_do_soundex) THEN
2020:                   FOR n IN (SELECT DISTINCT SOUNDEX(last_name) AS last_name,
2021:                                             UPPER(SUBSTR(NVL(first_name, ' '), 1, 1))
2022:                                                                                     AS first_initial
2023:                                        FROM v_osi_partic_name
2024:                                       WHERE participant_version = x.SID AND type_code &lt;&gt; 'A'
2025:                             INTERSECT
2026:                             SELECT DISTINCT SOUNDEX(last_name) AS last_name,
2027:                                             UPPER(SUBSTR(NVL(first_name, ' '), 1, 1))
2028:                                                                                     AS first_initial
2029:                                        FROM v_osi_partic_name
2030:                                       WHERE participant_version = v_target.SID AND type_code &lt;&gt; 'A')
2031:                   LOOP
2032:                       v_score := v_score + 25;
2033:                       v_info := v_info || 'Similar name';
2034:   
2035:                       IF (v_target.obj_type = v_prog) THEN
2036:                           v_info := v_info || ' (or acronym)';
2037:                       END IF;
2038:   
2039:                       v_info := v_info || '. ';
2040:                   END LOOP;
2041:               END IF;
2042:   
2043:               -- Adjust score for expected differences.
2044:               IF (    v_score &gt; 0
2045:                   AND x.sex IS NOT NULL
2046:                   AND v_target.sex IS NOT NULL
2047:                   AND x.sex &lt;&gt; v_target.sex) THEN
2048:                   v_score := v_score - 50;
2049:                   v_info := v_info || 'DIFFERENT sex. ';
2050:               END IF;
2051:   
2052:               IF (v_score &lt;= 0) THEN
2053:                   v_score := 0;
2054:               ELSE
2055:                   v_info := RTRIM(v_info, ' ');
2056:   
2057:                   IF (v_score &gt; 100) THEN
2058:                       v_score := 100;
2059:                   END IF;
2060:   
2061:                   IF (v_session IS NULL) THEN
2062:                       -- This is the first result so set the session.
2063:                       v_session := Core_Sidgen.next_sid;
2064:   --                    v_confirm_allowed := 'N';
2065:                   END IF;
2066:   
2067:                   INSERT INTO T_OSI_PARTIC_SEARCH_RESULT
2068:                               (session_id, participant, score, info)
2069:                        VALUES (v_session, x.participant, v_score, v_info);
2070:               END IF;
2071:   
2072:               IF (v_score &gt; v_max_score) THEN
2073:                   v_max_score := v_score;
2074:               END IF;
2075:           END LOOP;
2076:   
2077:           IF (v_max_score &gt;= 75) THEN
2078:               v_confirm_allowed := 'N';
2079:           END IF;
2080:   
2081:           IF (v_target.obj_type = v_prog) THEN
2082:               SELECT COUNT(SID)
2083:                 INTO v_score
2084:                 FROM v_osi_partic_relation
2085:                WHERE this_participant = v_target.SID AND relation_code IN('ICB', 'ICF');
2086:   
2087:               IF (v_score = 0) THEN
2088:                   v_confirm_allowed := 'N';
2089:               END IF;
2090:           END IF;
2091:   
2092:           RETURN v_confirm_allowed;
2093:       EXCEPTION
2094:           WHEN OTHERS THEN
2095:               log_error('check_for_duplicates: ' || SQLERRM);
2096:               --v_confirm_allowed := 'N';
2097:               RAISE;
2098:       END check_for_duplicates;
2099:   
2100:       PROCEDURE check_for_matches(
2101:           p_number           IN       VARCHAR2,
2102:           p_number_type      IN       VARCHAR2,
2103:           p_dob              IN       DATE,
2104:           p_lname            IN       VARCHAR2,
2105:           p_fname            IN       VARCHAR2,
2106:           p_sex              IN       VARCHAR2,
2107:           p_session_web      IN OUT   VARCHAR2,
2108:           p_session_legacy   IN OUT   VARCHAR2,
2109:           p_deers_result     OUT      VARCHAR2) IS
2110:           v_name_types             T_CORE_CONFIG.setting%TYPE;
2111:           v_lname                  T_OSI_PARTIC_NAME.last_name%TYPE;
2112:           v_fname                  T_OSI_PARTIC_NAME.first_name%TYPE;
2113:           v_score                  NUMBER                               := 0;
2114:           v_info                   VARCHAR2(150);
2115:           v_code                   T_OSI_PARTIC_NUMBER_TYPE.code%TYPE;
2116:           --v_cnt          number                               := 0;--TODO
2117:           v_found_match            BOOLEAN;
2118:           v_sex_code               VARCHAR2(200);
2119:           v_num_type_code          VARCHAR2(200);
2120:           v_num_type_description   VARCHAR2(200);
2121:   
2122:           --Process_Match = Legacy Only
2123:           PROCEDURE process_match(
2124:               p_session          IN   VARCHAR2,
2125:               p_person_version   IN   VARCHAR2,
2126:               p_hit_score        IN   NUMBER,
2127:               p_details          IN   VARCHAR2) IS
2128:               v_cnt   NUMBER;
2129:           BEGIN
2130:               --Clear Buffer
2131:               v_cnt := 0;
2132:   
2133:               FOR k IN (SELECT *
2134:                           FROM T_OSI_MIGRATION_PARTIC_HIT
2135:                          WHERE user_session = p_session AND person_version = p_person_version)
2136:               LOOP
2137:                   --See if this person has been processed as a hit already
2138:                   v_cnt := v_cnt + 1;
2139:               END LOOP;
2140:   
2141:               IF (v_cnt &gt; 0) THEN
2142:                   RETURN;
2143:               ELSE
2144:                   FOR k IN (SELECT *
2145:                               FROM T_OSI_MIGRATION
2146:                              WHERE TYPE = 'PARTICIPANT_VERSION' AND old_sid = p_person_version)
2147:                   LOOP
2148:                       --See if this person has been imported already
2149:                       v_cnt := v_cnt + 1;
2150:                   END LOOP;
2151:               END IF;
2152:   
2153:               IF (v_cnt = 0) THEN
2154:                   INSERT INTO T_OSI_MIGRATION_PARTIC_HIT
2155:                               (user_session, person_version, score, details)
2156:                        VALUES (p_session, p_person_version, p_hit_score, p_details);
2157:   
2158:                   COMMIT;
2159:               END IF;
2160:           END process_match;
2161:       BEGIN
2162:           --Clear Buffers
2163:           v_found_match := FALSE;
2164:   
2165:           --Get Session ID's
2166:           --Legacy
2167:           IF (p_session_legacy IS NULL) THEN
2168:               p_session_legacy := Core_Sidgen.next_sid;
2169:   
2170:               --Just remove anything over 6 hours old
2171:               DELETE FROM T_OSI_MIGRATION_PARTIC_HIT
2172:                     WHERE create_on &lt; SYSDATE - .25;
2173:   
2174:               COMMIT;
2175:           ELSE
2176:               --Clear out old session data
2177:               DELETE FROM T_OSI_MIGRATION_PARTIC_HIT
2178:                     WHERE user_session = p_session_legacy;
2179:   
2180:               COMMIT;
2181:           END IF;
2182:   
2183:           --Web
2184:           IF (p_session_web IS NULL) THEN
2185:               p_session_web := Core_Sidgen.next_sid;
2186:   
2187:               --Just remove anything over 6 hours old
2188:               DELETE FROM T_OSI_PARTIC_SEARCH_RESULT
2189:                     WHERE create_on &lt; SYSDATE - .25;
2190:   
2191:               COMMIT;
2192:           ELSE
2193:               --Clear out old session data
2194:               DELETE FROM T_OSI_PARTIC_SEARCH_RESULT
2195:                     WHERE session_id = p_session_web;
2196:   
2197:               COMMIT;
2198:           END IF;
2199:   
2200:           IF (p_number IS NULL) THEN
2201:               --p_session := core_sidgen.next_sid;--TODO
2202:               -- Get the type codes for the searchable names.
2203:               v_name_types := Core_Util.get_config('OSI.SEARCH_PARTICIPANT_NAME_TYPES');
2204:               v_lname := UPPER(trim(p_lname));
2205:               v_fname := UPPER(trim(p_fname));
2206:   
2207:               --Web Participant Search[BEGIN]
2208:               FOR x IN (SELECT pv.SID, pv.participant, pn.last_name, pn.first_name
2209:                           FROM v_osi_participant_version pv, v_osi_partic_name pn
2210:                          WHERE pv.SID = pv.current_version
2211:                            --and pv.current_name = pn.sid
2212:                            AND pv.SID = pn.participant_version
2213:                            AND (   p_dob IS NULL
2214:                                 OR pv.dob = p_dob)
2215:                            AND (   p_sex IS NULL
2216:                                 OR pv.sex = p_sex)
2217:                            AND INSTR(v_name_types, pn.type_code) &gt; 0
2218:                            AND (    (   SOUNDEX(pn.last_name) = SOUNDEX(v_lname)
2219:                                      OR pn.last_name LIKE v_lname || '%')
2220:                                 AND (   SOUNDEX(pn.first_name) = SOUNDEX(v_fname)
2221:                                      OR pn.first_name LIKE v_fname || '%'))
2222:                            AND pv.confirm_by IS NOT NULL
2223:                            AND pv.confirm_on IS NOT NULL)
2224:               LOOP
2225:                   IF (   v_lname IS NOT NULL
2226:                       OR LENGTH(v_lname) &lt;&gt; 0) THEN
2227:                       IF (x.last_name = v_lname) THEN
2228:                           v_score := v_score + 25;
2229:                           v_info := v_info || 'Matching last name. ';
2230:                       ELSE
2231:                           v_score := v_score + 10;
2232:                           v_info := v_info || 'Like sounding last name. ';
2233:                       END IF;
2234:                   END IF;
2235:   
2236:                   IF (   v_fname IS NOT NULL
2237:                       OR LENGTH(v_fname) &lt;&gt; 0) THEN
2238:                       IF (x.first_name = v_fname) THEN
2239:                           v_score := v_score + 25;
2240:                           v_info := v_info || 'Matching first name. ';
2241:                       ELSE
2242:                           v_score := v_score + 10;
2243:                           v_info := v_info || 'Like sounding first name. ';
2244:                       END IF;
2245:                   END IF;
2246:   
2247:                   IF (p_dob IS NOT NULL) THEN
2248:                       v_score := v_score + 25;
2249:                       v_info := v_info || 'Matching DOB. ';
2250:                   END IF;
2251:   
2252:                   IF (p_sex IS NOT NULL) THEN
2253:                       v_score := v_score + 15;
2254:                       v_info := v_info || 'Matching sex.';
2255:                   END IF;
2256:   
2257:                   INSERT INTO T_OSI_PARTIC_SEARCH_RESULT
2258:                               (session_id, participant, score, info)
2259:                        VALUES (p_session_web, x.participant, v_score, v_info);
2260:   
2261:                   v_score := 0;
2262:                   v_info := '';
2263:               END LOOP;
2264:   
2265:               --Web Participant Search[END]
2266:   
2267:               --Legacy Participant Search[BEGIN]
2268:               --Get Sex Code
2269:               IF (p_sex IS NOT NULL) THEN
2270:                   SELECT code
2271:                     INTO v_sex_code
2272:                     FROM T_DIBRS_REFERENCE
2273:                    WHERE SID = p_sex;
2274:               END IF;
2275:   
2276:               FOR match IN (SELECT pv.SID, pv.person, pn.last_name, pn.first_name, pv.sex
2277:                               FROM ref_t_person_version pv, ref_t_person_name pn, ref_t_person p
2278:                              WHERE p.SID = pv.person
2279:                                AND pv.SID = pn.person_version
2280:                                AND (   p_dob IS NULL
2281:                                     OR p.birth_date = p_dob)
2282:                                AND (   pv.sex IS NULL
2283:                                     OR pv.sex LIKE v_sex_code || '%')
2284:                                AND INSTR(v_name_types, pn.name_type) &gt; 0
2285:                                AND (    (   SOUNDEX(pn.last_name) = SOUNDEX(v_lname)
2286:                                          OR pn.last_name LIKE v_lname || '%')
2287:                                     AND (   SOUNDEX(pn.first_name) = SOUNDEX(v_fname)
2288:                                          OR pn.first_name LIKE v_fname || '%'))
2289:                                AND p.confirm_by IS NOT NULL
2290:                                AND p.confirm_on IS NOT NULL
2291:                                AND pv.current_flag = 1)
2292:               LOOP
2293:                   --Reset Scores and Info
2294:                   v_score := 0;
2295:                   v_info := '';
2296:   
2297:                   --Last Name
2298:                   IF (   v_lname IS NOT NULL
2299:                       OR LENGTH(v_lname) &lt;&gt; 0) THEN
2300:                       IF (match.last_name = v_lname) THEN
2301:                           v_score := v_score + 25;
2302:                           v_info := v_info || 'Matching last name. ';
2303:                       ELSE
2304:                           v_score := v_score + 10;
2305:                           v_info := v_info || 'Like sounding last name. ';
2306:                       END IF;
2307:                   END IF;
2308:   
2309:                   --First Name
2310:                   IF (   v_fname IS NOT NULL
2311:                       OR LENGTH(v_fname) &lt;&gt; 0) THEN
2312:                       IF (match.first_name = v_fname) THEN
2313:                           v_score := v_score + 25;
2314:                           v_info := v_info || 'Matching first name. ';
2315:                       ELSE
2316:                           v_score := v_score + 10;
2317:                           v_info := v_info || 'Like sounding first name. ';
2318:                       END IF;
2319:                   END IF;
2320:   
2321:                   --Birth Date
2322:                   IF (p_dob IS NOT NULL) THEN
2323:                       v_info := v_info || 'Matching DOB. ';
2324:                       v_score := v_score + 25;
2325:                   END IF;
2326:   
2327:                   --Sex
2328:                   IF ((   v_sex_code IS NOT NULL
2329:                        OR LENGTH(v_sex_code) &lt;&gt; 0) AND match.sex IS NOT NULL) THEN
2330:                       v_info := v_info || 'Matching sex. ';
2331:                       v_score := v_score + 15;
2332:                   END IF;
2333:   
2334:                   --Mark match
2335:                   process_match(p_session_legacy, match.SID, v_score, v_info);
2336:               END LOOP;
2337:           --Legacy Participant Search[END]
2338:           ELSE
2339:               --Try matching on Number
2340:               v_score := 90;
2341:   
2342:               --p_session := core_sidgen.next_sid;--TODO
2343:   
2344:               --Web Participant Search With Number [BEGIN]
2345:               SELECT 'Matching ' || description || '.', code
2346:                 INTO v_info, v_code
2347:                 FROM T_OSI_PARTIC_NUMBER_TYPE
2348:                WHERE SID = p_number_type;
2349:   
2350:               FOR x IN (SELECT pv.SID, pv.participant
2351:                           FROM v_osi_participant_version pv, T_OSI_PARTIC_NUMBER pn
2352:                          WHERE pv.SID = pv.current_version
2353:                            AND pn.participant_version = pv.SID
2354:                            AND pn.num_type = p_number_type
2355:                            AND pn.num_value = p_number
2356:                            AND pv.confirm_by IS NOT NULL
2357:                            AND pv.confirm_on IS NOT NULL)
2358:               LOOP
2359:                   INSERT INTO T_OSI_PARTIC_SEARCH_RESULT
2360:                               (session_id, participant, score, info)
2361:                        VALUES (p_session_web, x.participant, v_score, v_info);
2362:   
2363:                   --v_cnt := 1;--TODO
2364:                   v_found_match := TRUE;
2365:               END LOOP;
2366:   
2367:               --Web Participant Search With Number[END]
2368:   
2369:               --Legacy Participant Search With Number[BEGIN]
2370:               IF (p_number IS NOT NULL) THEN
2371:                   IF (p_number_type IS NOT NULL) THEN
2372:                       --Get current code
2373:                       SELECT code, description
2374:                         INTO v_num_type_code, v_num_type_description
2375:                         FROM T_OSI_PARTIC_NUMBER_TYPE
2376:                        WHERE SID = p_number_type;
2377:   
2378:                       IF (v_num_type_code = 'OID') THEN
2379:                           --Codes don't match in legacy vs. web
2380:                           v_num_type_code := 'OTHER';
2381:                       END IF;
2382:   
2383:                       v_info := 'Matching ' || v_num_type_description || '.';
2384:                   END IF;
2385:   
2386:                   FOR k IN (SELECT person_version
2387:                               FROM ref_t_person_number
2388:                              WHERE UPPER(num_value) LIKE '%' || p_number || '%'
2389:                                AND UPPER(num_type) = UPPER(v_num_type_code))
2390:                   LOOP
2391:                       process_match(p_session_legacy, k.person_version, 90, v_info);
2392:                       v_found_match := TRUE;
2393:                   END LOOP;
2394:               END IF;
2395:   
2396:               --Legacy Participant Search With Number[END]
2397:               IF (v_found_match = FALSE AND Osi_Deers.is_searchable_number(p_number_type) = 'Y') THEN
2398:                   -- Check deers.
2399:                   p_session_web := NULL;
2400:                   p_session_legacy := NULL;
2401:   
2402:                   IF Core_Util.get_config('OSI.AUDITING') = 'ON' THEN
2403:                       Log_Info('DEERS:Query for ' || UPPER(trim(p_lname)) || ', ' || p_number);
2404:                   END IF;
2405:   
2406:                   p_deers_result :=
2407:                             Osi_Deers.get_deers_information(p_number, UPPER(trim(p_lname)), 1, v_code);
2408:               END IF;
2409:           END IF;
2410:       EXCEPTION
2411:           WHEN OTHERS THEN
2412:               log_error('check_for_matches: ' || SQLERRM);
2413:               RAISE;
2414:       END check_for_matches;
2415:   
2416:       PROCEDURE confirm(p_obj IN VARCHAR2) IS
2417:       BEGIN
2418:           UPDATE T_OSI_PARTICIPANT
2419:              SET confirm_on = SYSDATE,
2420:                  confirm_by = Core_Context.personnel_name
2421:            WHERE SID = p_obj;
2422:       EXCEPTION
2423:           WHEN OTHERS THEN
2424:               log_error('confirm: ' || SQLERRM);
2425:               RAISE;
2426:       END confirm;
2427:   
2428:       PROCEDURE unconfirm(p_obj IN VARCHAR2) IS
2429:       BEGIN
2430:           UPDATE T_OSI_PARTICIPANT
2431:              SET confirm_on = NULL,
2432:                  confirm_by = NULL
2433:            WHERE SID = p_obj;
2434:   
2435:           INSERT INTO T_OSI_NOTE
2436:                       (obj, note_type, note_text, lock_mode)
2437:                VALUES (p_obj,
2438:                        (SELECT SID
2439:                           FROM T_OSI_NOTE_TYPE
2440:                          WHERE code = 'UNCONFIRM' AND USAGE = 'NOTELIST'),
2441:                        'Participant was unconfirmed.',
2442:                        'IMMED');
2443:       EXCEPTION
2444:           WHEN OTHERS THEN
2445:               log_error('unconfirm: ' || SQLERRM);
2446:               RAISE;
2447:       END unconfirm;
2448:   
2449:       PROCEDURE remap_org_names(p_pvop IN VARCHAR2) IS
2450:           v_count     INTEGER;
2451:           v_pv        T_OSI_PARTICIPANT_VERSION.SID%TYPE;
2452:           v_ok        T_OSI_PARTIC_NAME_TYPE.SID%TYPE;
2453:           v_subtype   T_OSI_PARTICIPANT_NONHUMAN.sub_type%TYPE;
2454:       BEGIN
2455:           -- See if this is a participant sid instead of a version sid.
2456:           v_pv := get_current_version(p_pvop);
2457:   
2458:           IF (v_pv IS NULL) THEN
2459:               v_pv := p_pvop;
2460:           END IF;
2461:   
2462:           -- Get the organization type.
2463:           v_subtype := get_subtype_sid(v_pv);
2464:   
2465:           FOR x IN (SELECT   SID, name_type
2466:                         FROM T_OSI_PARTIC_NAME
2467:                        WHERE participant_version = v_pv
2468:                     ORDER BY create_on ASC)
2469:           LOOP
2470:               -- See if there is a corresponding name for the subtype.
2471:               BEGIN
2472:                   SELECT m.name_type
2473:                     INTO v_ok
2474:                     FROM T_OSI_PARTIC_NAME_TYPE_MAP m
2475:                    WHERE m.participant_type = v_subtype AND m.name_type = x.name_type;
2476:   
2477:                   -- Make the first mapped name the default name.
2478:                   IF (v_count IS NULL) THEN
2479:                       UPDATE T_OSI_PARTICIPANT_VERSION
2480:                          SET current_name = x.SID
2481:                        WHERE SID = v_pv;
2482:   
2483:                       v_count := 1;
2484:                   END IF;
2485:               EXCEPTION
2486:                   WHEN NO_DATA_FOUND THEN
2487:                       -- This name didn't map so unset it if it's the current name then delete it.
2488:                       UPDATE T_OSI_PARTICIPANT_VERSION
2489:                          SET current_name = NULL
2490:                        WHERE SID = v_pv AND current_name = x.SID;
2491:   
2492:                       DELETE FROM T_OSI_PARTIC_NAME
2493:                             WHERE SID = x.SID;
2494:               END;
2495:           END LOOP;
2496:       EXCEPTION
2497:           WHEN OTHERS THEN
2498:               log_error('remap_org_names: ' || SQLERRM);
2499:               RAISE;
2500:       END remap_org_names;
2501:   
2502:       PROCEDURE replace_with(p_obj IN VARCHAR2, p_replacement IN VARCHAR2) IS
2503:           v_count             INTEGER;
2504:           v_sid               VARCHAR2(20);
2505:           v_note              VARCHAR2(32767);
2506:           v_crlf              VARCHAR2(2)                          := CHR(13) || CHR(10);
2507:           v_obj_version       T_OSI_PARTICIPANT_VERSION.SID%TYPE;
2508:           v_replace_version   T_OSI_PARTICIPANT_VERSION.SID%TYPE;
2509:           v_obj_row           v_osi_participant_version%ROWTYPE;
2510:           v_replace_row       v_osi_participant_version%ROWTYPE;
2511:   
2512:           PROCEDURE log_note(p_note IN VARCHAR2) IS
2513:           BEGIN
2514:               Core_Util.append_info(v_note, p_note, v_crlf);
2515:           END log_note;
2516:   
2517:           PROCEDURE check_diff(p_target IN VARCHAR2, p_replace IN VARCHAR2, p_note IN VARCHAR2) IS
2518:               v_yn   VARCHAR2(3);
2519:           BEGIN
2520:               IF (NVL(p_target, 'NULL') &lt;&gt; NVL(p_replace, 'NULL')) THEN
2521:                   CASE p_target
2522:                       WHEN 'Y' THEN
2523:                           log_note(p_note || '=Yes');
2524:                       WHEN 'N' THEN
2525:                           log_note(p_note || '=No');
2526:                       WHEN 'U' THEN
2527:                           log_note(p_note || '=');
2528:                       ELSE
2529:                           log_note(p_note || '=' || p_target);
2530:                   END CASE;
2531:               END IF;
2532:           END check_diff;
2533:   
2534:           PROCEDURE check_diff(p_target IN DATE, p_replace IN DATE, p_note IN VARCHAR2) IS
2535:           BEGIN
2536:               IF (NVL(p_target, TO_DATE('01/01/1900', 'mm/dd/yyyy')) &lt;&gt;
2537:                                                    NVL(p_replace, TO_DATE('01/01/1900', 'mm/dd/yyyy'))) THEN
2538:                   log_note(p_note || '=' || p_target);
2539:               END IF;
2540:           END check_diff;
2541:       BEGIN
2542:           IF (p_obj IS NOT NULL AND p_replacement IS NOT NULL) THEN
2543:               v_obj_version := get_current_version(p_obj);
2544:               v_replace_version := get_current_version(p_replacement);
2545:   
2546:               -- Agent Applicant File
2547:               FOR c IN (SELECT pi.SID
2548:                           FROM T_OSI_PARTIC_INVOLVEMENT pi, T_OSI_PARTIC_ROLE_TYPE rt
2549:                          WHERE pi.involvement_role = rt.SID
2550:                            AND rt.USAGE = 'SUBJECT'
2551:                            AND rt.obj_type = Core_Obj.lookup_objtype('FILE.AAPP')
2552:                            AND pi.participant_version IN(SELECT SID
2553:                                                            FROM T_OSI_PARTICIPANT_VERSION
2554:                                                           WHERE participant = p_obj))
2555:               LOOP
2556:                   BEGIN
2557:                       UPDATE T_OSI_PARTIC_INVOLVEMENT
2558:                          SET participant_version = v_replace_version
2559:                        WHERE SID = c.SID;
2560:                   EXCEPTION
2561:                       WHEN DUP_VAL_ON_INDEX THEN
2562:                           log_note('Duplicate T_AGENT_Applicant filtered out.');
2563:                   END;
2564:               END LOOP;
2565:   
2566:               -- Group Interview
2567:               FOR c IN (SELECT i.SID
2568:                           FROM T_OSI_A_GI_INVOLVEMENT i
2569:                          WHERE participant_version IN(SELECT SID
2570:                                                         FROM T_OSI_PARTICIPANT_VERSION
2571:                                                        WHERE participant = p_obj))
2572:               LOOP
2573:                   BEGIN
2574:                       UPDATE T_OSI_A_GI_INVOLVEMENT
2575:                          SET participant_version = v_replace_version
2576:                        WHERE SID = c.SID;
2577:                   EXCEPTION
2578:                       WHEN DUP_VAL_ON_INDEX THEN
2579:                           log_note('Duplicate GI Involvement filtered out.');
2580:                   END;
2581:               END LOOP;
2582:   
2583:               -- Personnel Recent Objects
2584:               FOR c IN (SELECT p.SID
2585:                           FROM T_OSI_PERSONNEL_RECENT_OBJECTS p
2586:                          WHERE p.obj = p_obj)
2587:               LOOP
2588:                   BEGIN
2589:                       UPDATE T_OSI_PERSONNEL_RECENT_OBJECTS
2590:                          SET obj = v_replace_version
2591:                        WHERE SID = c.SID;
2592:                   EXCEPTION
2593:                       WHEN DUP_VAL_ON_INDEX THEN
2594:                           log_note('Duplicate Personnel Cache filtered out.');
2595:                   END;
2596:               END LOOP;
2597:   
2598:               -- Participant Involvement
2599:               FOR c IN (SELECT pi.SID
2600:                           FROM T_OSI_PARTIC_INVOLVEMENT pi
2601:                          WHERE participant_version IN(SELECT SID
2602:                                                         FROM T_OSI_PARTICIPANT_VERSION
2603:                                                        WHERE participant = p_obj))
2604:               LOOP
2605:                   BEGIN
2606:                       UPDATE T_OSI_PARTIC_INVOLVEMENT
2607:                          SET participant_version = v_replace_version
2608:                        WHERE SID = c.SID;
2609:                   EXCEPTION
2610:                       WHEN DUP_VAL_ON_INDEX THEN
2611:                           log_note('Duplicate Participant Involvement filtered out.');
2612:                   END;
2613:               END LOOP;
2614:   
2615:               -- Investigative File Specification Victim
2616:               FOR c IN (SELECT i.SID
2617:                           FROM T_OSI_F_INV_SPEC i
2618:                          WHERE i.victim IN(SELECT SID
2619:                                              FROM T_OSI_PARTICIPANT_VERSION
2620:                                             WHERE participant = p_obj))
2621:               LOOP
2622:                   BEGIN
2623:                       UPDATE T_OSI_F_INV_SPEC
2624:                          SET victim = v_replace_version
2625:                        WHERE SID = c.SID;
2626:                   EXCEPTION
2627:                       WHEN DUP_VAL_ON_INDEX THEN
2628:                           log_note('Duplicate Specification Victim filtered out.');
2629:                   END;
2630:               END LOOP;
2631:   
2632:               -- Investigative File Specification Subject
2633:               FOR c IN (SELECT i.SID
2634:                           FROM T_OSI_F_INV_SPEC i
2635:                          WHERE i.subject IN(SELECT SID
2636:                                               FROM T_OSI_PARTICIPANT_VERSION
2637:                                              WHERE participant = p_obj))
2638:               LOOP
2639:                   BEGIN
2640:                       UPDATE T_OSI_F_INV_SPEC
2641:                          SET subject = v_replace_version
2642:                        WHERE SID = c.SID;
2643:                   EXCEPTION
2644:                       WHEN DUP_VAL_ON_INDEX THEN
2645:                           log_note('Duplicate Specification Subject filtered out.');
2646:                   END;
2647:               END LOOP;
2648:   
2649:               -- Investigative File Subject Disposition
2650:               FOR c IN (SELECT s.SID
2651:                           FROM T_OSI_F_INV_SUBJ_DISPOSITION s
2652:                          WHERE s.subject IN(SELECT SID
2653:                                               FROM T_OSI_PARTICIPANT_VERSION
2654:                                              WHERE participant = p_obj))
2655:               LOOP
2656:                   BEGIN
2657:                       UPDATE T_OSI_F_INV_SUBJ_DISPOSITION
2658:                          SET subject = v_replace_version
2659:                        WHERE SID = c.SID;
2660:                   EXCEPTION
2661:                       WHEN DUP_VAL_ON_INDEX THEN
2662:                           log_note('Duplicate Subject Disposition filtered out.');
2663:                   END;
2664:               END LOOP;
2665:   
2666:               -- Source File
2667:               UPDATE T_OSI_F_SOURCE
2668:                  SET participant = p_replacement
2669:                WHERE participant = p_obj;
2670:   
2671:               -- Participant Relationships
2672:               UPDATE T_OSI_PARTIC_RELATION r
2673:                  SET r.partic_a = p_replacement
2674:                WHERE r.partic_a = p_obj
2675:                  AND NOT EXISTS(
2676:                          SELECT SID
2677:                            FROM T_OSI_PARTIC_RELATION
2678:                           WHERE partic_a = r.partic_b
2679:                             AND partic_b = p_replacement
2680:                             AND rel_type = r.rel_type
2681:                             AND NVL(known_date, TRUNC(SYSDATE)) = NVL(r.known_date, TRUNC(SYSDATE)));
2682:   
2683:               UPDATE T_OSI_PARTIC_RELATION r
2684:                  SET r.partic_b = p_replacement
2685:                WHERE r.partic_b = p_obj
2686:                  AND NOT EXISTS(
2687:                          SELECT SID
2688:                            FROM T_OSI_PARTIC_RELATION
2689:                           WHERE partic_a = r.partic_a
2690:                             AND partic_b = p_replacement
2691:                             AND rel_type = r.rel_type
2692:                             AND NVL(known_date, TRUNC(SYSDATE)) = NVL(r.known_date, TRUNC(SYSDATE)));
2693:   
2694:               -- For the participant version details we're going to log in the note any differences.
2695:               SELECT *
2696:                 INTO v_obj_row
2697:                 FROM v_osi_participant_version
2698:                WHERE SID = v_obj_version;
2699:   
2700:               SELECT *
2701:                 INTO v_replace_row
2702:                 FROM v_osi_participant_version
2703:                WHERE SID = v_replace_version;
2704:   
2705:               check_diff(v_obj_row.education_level, v_replace_row.education_level, 'education_level');
2706:               check_diff(v_obj_row.sa_pay_grade_desc, v_replace_row.sa_pay_grade_desc, 'sa_pay_grade');
2707:               check_diff(v_obj_row.sa_pay_plan_desc, v_replace_row.sa_pay_plan_desc, 'sa_pay_plan');
2708:               check_diff(v_obj_row.height, v_replace_row.height, 'height');
2709:               check_diff(v_obj_row.weight, v_replace_row.weight, 'weight');
2710:               check_diff(v_obj_row.race_desc, v_replace_row.race_desc, 'race');
2711:               check_diff(v_obj_row.hair_color_desc, v_replace_row.hair_color_desc, 'hair_color');
2712:               check_diff(v_obj_row.eye_color_desc, v_replace_row.eye_color_desc, 'eye_color');
2713:               check_diff(v_obj_row.age_low, v_replace_row.age_low, 'age_low');
2714:               check_diff(v_obj_row.age_high, v_replace_row.age_high, 'age_high');
2715:               check_diff(v_obj_row.sex_desc, v_replace_row.sex_desc, 'sex');
2716:               check_diff(v_obj_row.sa_service_desc, v_replace_row.sa_service_desc, 'sa_service');
2717:               check_diff(v_obj_row.sa_component_desc, v_replace_row.sa_component_desc, 'sa_component');
2718:               check_diff(v_obj_row.org_uic, v_replace_row.org_uic, 'org_uic');
2719:               check_diff(v_obj_row.org_high_risk, v_replace_row.org_high_risk, 'org_high_risk');
2720:               check_diff(v_obj_row.org_num_people, v_replace_row.org_num_people, 'org_num_people');
2721:               check_diff(v_obj_row.org_supporting_unit,
2722:                          v_replace_row.org_supporting_unit,
2723:                          'org_supporting_unit');
2724:               check_diff(v_obj_row.current_address_desc,
2725:                          v_replace_row.current_address_desc,
2726:                          'current_address');
2727:               check_diff(v_obj_row.build_desc, v_replace_row.build_desc, 'build');
2728:               check_diff(v_obj_row.writing_hand_desc, v_replace_row.writing_hand_desc, 'writing_hand');
2729:               check_diff(v_obj_row.is_bald, v_replace_row.is_bald, 'is_bald');
2730:               check_diff(v_obj_row.bald_comment, v_replace_row.bald_comment, 'bald_comment');
2731:               check_diff(v_obj_row.has_facial_hair, v_replace_row.has_facial_hair, 'has_facial_hair');
2732:               check_diff(v_obj_row.facial_hair_comment,
2733:                          v_replace_row.facial_hair_comment,
2734:                          'facial_hair_comment');
2735:               check_diff(v_obj_row.wears_glasses, v_replace_row.wears_glasses, 'wears_glasses');
2736:               check_diff(v_obj_row.glasses_comment, v_replace_row.glasses_comment, 'glasses_comment');
2737:               check_diff(v_obj_row.is_hard_of_hearing,
2738:                          v_replace_row.is_hard_of_hearing,
2739:                          'is_hard_of_hearing');
2740:               check_diff(v_obj_row.hearing_comment, v_replace_row.hearing_comment, 'hearing_comment');
2741:               check_diff(v_obj_row.has_teeth, v_replace_row.has_teeth, 'has_teeth');
2742:               check_diff(v_obj_row.teeth_comment, v_replace_row.teeth_comment, 'teeth_comment');
2743:               check_diff(v_obj_row.sa_rank, v_replace_row.sa_rank, 'sa_rank');
2744:               check_diff(v_obj_row.sa_rank_date, v_replace_row.sa_rank_date, 'sa_rank_date');
2745:               check_diff(v_obj_row.sa_affiliation_desc,
2746:                          v_replace_row.sa_affiliation_desc,
2747:                          'sa_affiliation');
2748:               check_diff(v_obj_row.sa_specialty_code,
2749:                          v_replace_row.sa_specialty_code,
2750:                          'sa_specialty_code');
2751:               check_diff(v_obj_row.fsa_service_desc, v_replace_row.fsa_service_desc, 'fsa_service');
2752:               check_diff(v_obj_row.fsa_rank, v_replace_row.fsa_rank, 'fsa_rank');
2753:               check_diff(v_obj_row.fsa_equiv_rank, v_replace_row.fsa_equiv_rank, 'fsa_equiv_rank');
2754:               check_diff(v_obj_row.fsa_rank_date, v_replace_row.fsa_rank_date, 'fsa_rank_date');
2755:               check_diff(v_obj_row.org_majcom, v_replace_row.org_majcom, 'org_majcom');
2756:               check_diff(v_obj_row.posture_desc, v_replace_row.posture_desc, 'posture');
2757:               check_diff(v_obj_row.religion, v_replace_row.religion, 'religion');
2758:               check_diff(v_obj_row.religion_involvement_desc,
2759:                          v_replace_row.religion_involvement_desc,
2760:                          'religion_involvement');
2761:               check_diff(v_obj_row.prog_description,
2762:                          v_replace_row.prog_description,
2763:                          'prog_description');
2764:               v_note := v_note || v_crlf;
2765:   
2766:               /*
2767:                * Now go through all the p_obj data and copy it with the p_replacement sid
2768:                * before deleting p_obj.
2769:                */
2770:   
2771:               /*
2772:                * For each data element (i.e. table) we want to maintain the audit history so
2773:                * we disable all the triggers before inserting. This requires providing a sid.
2774:                * We only insert records that have certain unique fields.
2775:                */
2776:               EXECUTE IMMEDIATE 'alter table t_osi_partic_citizenship disable all triggers';
2777:   
2778:               INSERT INTO T_OSI_PARTIC_CITIZENSHIP
2779:                           (SID,
2780:                            participant_version,
2781:                            country,
2782:                            effective_date,
2783:                            create_by,
2784:                            create_on,
2785:                            modify_by,
2786:                            modify_on)
2787:                   SELECT Core_Sidgen.next_sid, v_replace_version, country, effective_date, create_by,
2788:                          create_on, modify_by, modify_on
2789:                     FROM T_OSI_PARTIC_CITIZENSHIP
2790:                    WHERE participant_version = v_obj_version
2791:                      AND (country, effective_date) NOT IN(
2792:                                                          SELECT country, effective_date
2793:                                                            FROM T_OSI_PARTIC_CITIZENSHIP
2794:                                                           WHERE participant_version =
2795:                                                                                      v_replace_version);
2796:   
2797:               EXECUTE IMMEDIATE 'alter table t_osi_partic_citizenship enable all triggers';
2798:   
2799:               EXECUTE IMMEDIATE 'alter table t_osi_partic_mark disable all triggers';
2800:   
2801:               INSERT INTO T_OSI_PARTIC_MARK
2802:                           (SID,
2803:                            participant_version,
2804:                            mark_type,
2805:                            mark_location,
2806:                            description,
2807:                            create_by,
2808:                            create_on,
2809:                            modify_by,
2810:                            modify_on)
2811:                   SELECT Core_Sidgen.next_sid, v_replace_version, mark_type, mark_location,
2812:                          description, create_by, create_on, modify_by, modify_on
2813:                     FROM T_OSI_PARTIC_MARK
2814:                    WHERE participant_version = v_obj_version
2815:                      AND (mark_type, mark_location) NOT IN(
2816:                                                          SELECT mark_type, mark_location
2817:                                                            FROM T_OSI_PARTIC_MARK
2818:                                                           WHERE participant_version =
2819:                                                                                      v_replace_version);
2820:   
2821:               EXECUTE IMMEDIATE 'alter table t_osi_partic_mark enable all triggers';
2822:   
2823:               EXECUTE IMMEDIATE 'alter table t_osi_partic_name disable all triggers';
2824:   
2825:               INSERT INTO T_OSI_PARTIC_NAME
2826:                           (SID,
2827:                            participant_version,
2828:                            name_type,
2829:                            title,
2830:                            last_name,
2831:                            first_name,
2832:                            middle_name,
2833:                            cadency,
2834:                            create_by,
2835:                            create_on,
2836:                            modify_by,
2837:                            modify_on)
2838:                   SELECT Core_Sidgen.next_sid, v_replace_version, name_type, title, last_name,
2839:                          first_name, middle_name, cadency, create_by, create_on, modify_by, modify_on
2840:                     FROM T_OSI_PARTIC_NAME
2841:                    WHERE participant_version = v_obj_version
2842:                      AND (name_type, last_name, first_name, middle_name, cadency) NOT IN(
2843:                                          SELECT name_type, last_name, first_name, middle_name,
2844:                                                 cadency
2845:                                            FROM T_OSI_PARTIC_NAME
2846:                                           WHERE participant_version = v_replace_version);
2847:   
2848:               EXECUTE IMMEDIATE 'alter table t_osi_partic_name enable all triggers';
2849:   
2850:               -- We'll take all the participant numbers.
2851:               EXECUTE IMMEDIATE 'alter table t_osi_partic_number disable all triggers';
2852:   
2853:               FOR x IN (SELECT *
2854:                           FROM T_OSI_PARTIC_NUMBER
2855:                          WHERE participant_version = v_obj_version)
2856:               LOOP
2857:                   BEGIN
2858:                       INSERT INTO T_OSI_PARTIC_NUMBER
2859:                                   (SID,
2860:                                    participant_version,
2861:                                    num_type,
2862:                                    num_value,
2863:                                    issue_date,
2864:                                    issue_country,
2865:                                    issue_state,
2866:                                    issue_province,
2867:                                    expire_date,
2868:                                    note,
2869:                                    create_on,
2870:                                    create_by,
2871:                                    modify_on,
2872:                                    modify_by)
2873:                            VALUES (Core_Sidgen.next_sid,
2874:                                    v_replace_version,
2875:                                    x.num_type,
2876:                                    x.num_value,
2877:                                    x.issue_date,
2878:                                    x.issue_country,
2879:                                    x.issue_state,
2880:                                    x.issue_province,
2881:                                    x.expire_date,
2882:                                    x.note,
2883:                                    x.create_on,
2884:                                    x.create_by,
2885:                                    x.modify_on,
2886:                                    x.modify_by);
2887:                   EXCEPTION
2888:                       WHEN DUP_VAL_ON_INDEX THEN
2889:                           NULL;
2890:                   END;
2891:               END LOOP;
2892:   
2893:               EXECUTE IMMEDIATE 'alter table t_osi_partic_number enable all triggers';
2894:   
2895:               EXECUTE IMMEDIATE 'alter table t_osi_partic_org_attr disable all triggers';
2896:   
2897:               INSERT INTO T_OSI_PARTIC_ORG_ATTR
2898:                           (SID,
2899:                            participant_version,
2900:                            ATTRIBUTE,
2901:                            comments,
2902:                            create_on,
2903:                            create_by,
2904:                            modify_on,
2905:                            modify_by)
2906:                   SELECT Core_Sidgen.next_sid, v_replace_version, ATTRIBUTE, comments, create_on,
2907:                          create_by, modify_on, modify_by
2908:                     FROM T_OSI_PARTIC_ORG_ATTR
2909:                    WHERE participant_version = v_obj_version
2910:                      AND (ATTRIBUTE, comments) NOT IN(SELECT ATTRIBUTE, comments
2911:                                                         FROM T_OSI_PARTIC_ORG_ATTR
2912:                                                        WHERE participant_version = v_replace_version);
2913:   
2914:               EXECUTE IMMEDIATE 'alter table t_osi_partic_org_attr enable all triggers';
2915:   
2916:               -- This data is handled differently because we need to log the duplicate records.
2917:               EXECUTE IMMEDIATE 'alter table t_osi_partic_vehicle disable all triggers';
2918:   
2919:               FOR x IN (SELECT plate_num, reg_exp_date, reg_country, reg_state,
2920:                                (SELECT description
2921:                                   FROM T_DIBRS_STATE
2922:                                  WHERE SID = reg_state) AS state_desc, reg_province, title_owner, vin,
2923:                                make, MODEL, YEAR, color, body_type, gross_weight, num_axles, ROLE,
2924:                                comments, create_by, create_on, modify_by, modify_on
2925:                           FROM T_OSI_PARTIC_VEHICLE
2926:                          WHERE participant_version = v_obj_version)
2927:               LOOP
2928:                   DECLARE
2929:                       v_dup   BOOLEAN := FALSE;
2930:                   BEGIN
2931:                       FOR y IN (SELECT plate_num, reg_exp_date, reg_country, reg_state, reg_province,
2932:                                        title_owner, vin, make, MODEL, YEAR, color, body_type,
2933:                                        gross_weight, num_axles, ROLE, comments, create_by, create_on,
2934:                                        modify_by, modify_on
2935:                                   FROM T_OSI_PARTIC_VEHICLE
2936:                                  WHERE participant_version = v_replace_version)
2937:                       LOOP
2938:                           IF (    x.plate_num = y.plate_num
2939:                               AND (   x.reg_state = y.reg_state
2940:                                    OR x.reg_province = y.reg_province)) THEN
2941:                               -- This is a duplicate. Log it.
2942:                               v_dup := TRUE;
2943:                               v_note := v_note || 'Vehicle Information Duplication: plate number=';
2944:                               v_note :=
2945:                                   v_note || x.plate_num || ' state/province='
2946:                                   || NVL(x.state_desc, x.reg_province) || v_crlf;
2947:                           END IF;
2948:                       END LOOP;
2949:   
2950:                       IF (NOT v_dup) THEN
2951:                           INSERT INTO T_OSI_PARTIC_VEHICLE
2952:                                       (SID,
2953:                                        participant_version,
2954:                                        plate_num,
2955:                                        reg_exp_date,
2956:                                        reg_country,
2957:                                        reg_state,
2958:                                        reg_province,
2959:                                        title_owner,
2960:                                        vin,
2961:                                        make,
2962:                                        MODEL,
2963:                                        YEAR,
2964:                                        color,
2965:                                        body_type,
2966:                                        gross_weight,
2967:                                        num_axles,
2968:                                        ROLE,
2969:                                        comments,
2970:                                        create_by,
2971:                                        create_on,
2972:                                        modify_by,
2973:                                        modify_on)
2974:                                VALUES (Core_Sidgen.next_sid,
2975:                                        v_replace_version,
2976:                                        x.plate_num,
2977:                                        x.reg_exp_date,
2978:                                        x.reg_country,
2979:                                        x.reg_state,
2980:                                        x.reg_province,
2981:                                        x.title_owner,
2982:                                        x.vin,
2983:                                        x.make,
2984:                                        x.MODEL,
2985:                                        x.YEAR,
2986:                                        x.color,
2987:                                        x.body_type,
2988:                                        x.gross_weight,
2989:                                        x.num_axles,
2990:                                        x.ROLE,
2991:                                        x.comments,
2992:                                        x.create_by,
2993:                                        x.create_on,
2994:                                        x.modify_by,
2995:                                        x.modify_on);
2996:                       END IF;
2997:                   END;
2998:               END LOOP;
2999:   
3000:               EXECUTE IMMEDIATE 'alter table t_osi_partic_vehicle enable all triggers';
3001:   
3002:               EXECUTE IMMEDIATE 'alter table t_osi_partic_contact disable all triggers';
3003:   
3004:               INSERT INTO T_OSI_PARTIC_CONTACT
3005:                           (SID,
3006:                            participant_version,
3007:                            TYPE,
3008:                            VALUE,
3009:                            create_by,
3010:                            create_on,
3011:                            modify_by,
3012:                            modify_on)
3013:                   SELECT Core_Sidgen.next_sid, v_replace_version, TYPE, VALUE, create_by, create_on,
3014:                          modify_by, modify_on
3015:                     FROM T_OSI_PARTIC_CONTACT
3016:                    WHERE participant_version = v_obj_version
3017:                      AND (TYPE, VALUE) NOT IN(SELECT TYPE, VALUE
3018:                                                 FROM T_OSI_PARTIC_CONTACT
3019:                                                WHERE participant_version = v_replace_version);
3020:   
3021:               EXECUTE IMMEDIATE 'alter table t_osi_partic_contact enable all triggers';
3022:   
3023:               -- In Web I2MS participant addresses are spread across two tables.
3024:               EXECUTE IMMEDIATE 'alter table t_osi_partic_address disable all triggers';
3025:   
3026:               EXECUTE IMMEDIATE 'alter table t_osi_address disable all triggers';
3027:   
3028:               FOR x IN (SELECT va.address_type, va.address_1, va.address_2, va.city, va.province,
3029:                                va.state, va.postal_code, va.country, va.start_date, va.end_date,
3030:                                va.known_date, va.geo_coords, va.comments, va.create_on, va.create_by,
3031:                                va.modify_on, va.modify_by, a.create_on AS c1, a.create_by AS c2,
3032:                                a.modify_on AS m1, a.modify_by AS m2
3033:                           FROM v_osi_partic_address va, T_OSI_PARTIC_ADDRESS a
3034:                          WHERE va.participant_version = v_obj_version
3035:                            AND va.participant_version = a.participant_version
3036:                            AND va.SID = a.SID
3037:                            AND (va.address_1,
3038:                                 va.address_2,
3039:                                 va.city,
3040:                                 va.province,
3041:                                 va.state,
3042:                                 va.postal_code,
3043:                                 va.country,
3044:                                 va.start_date,
3045:                                 va.end_date,
3046:                                 va.known_date,
3047:                                 va.geo_coords,
3048:                                 va.comments) NOT IN(
3049:                                    SELECT address_1, address_2, city, province, state, postal_code,
3050:                                           country, start_date, end_date, known_date, geo_coords,
3051:                                           comments
3052:                                      FROM v_osi_partic_address
3053:                                     WHERE participant_version = v_replace_version))
3054:               LOOP
3055:                   INSERT INTO T_OSI_ADDRESS
3056:                               (SID,
3057:                                obj,
3058:                                address_type,
3059:                                address_1,
3060:                                address_2,
3061:                                city,
3062:                                province,
3063:                                state,
3064:                                postal_code,
3065:                                country,
3066:                                geo_coords,
3067:                                start_date,
3068:                                end_date,
3069:                                known_date,
3070:                                comments,
3071:                                create_on,
3072:                                create_by,
3073:                                modify_on,
3074:                                modify_by)
3075:                        VALUES (Core_Sidgen.next_sid,
3076:                                p_replacement,
3077:                                x.address_type,
3078:                                x.address_1,
3079:                                x.address_2,
3080:                                x.city,
3081:                                x.province,
3082:                                x.state,
3083:                                x.postal_code,
3084:                                x.country,
3085:                                x.geo_coords,
3086:                                x.start_date,
3087:                                x.end_date,
3088:                                x.known_date,
3089:                                x.comments,
3090:                                x.create_on,
3091:                                x.create_by,
3092:                                x.modify_on,
3093:                                x.modify_by)
3094:                     RETURNING SID
3095:                          INTO v_sid;
3096:   
3097:                   INSERT INTO T_OSI_PARTIC_ADDRESS
3098:                               (SID,
3099:                                participant_version,
3100:                                address,
3101:                                create_on,
3102:                                create_by,
3103:                                modify_on,
3104:                                modify_by)
3105:                        VALUES (Core_Sidgen.next_sid, v_replace_version, v_sid, x.c1, x.c2, x.m1, x.m2);
3106:               END LOOP;
3107:   
3108:               EXECUTE IMMEDIATE 'alter table t_osi_partic_address enable all triggers';
3109:   
3110:               EXECUTE IMMEDIATE 'alter table t_osi_address enable all triggers';
3111:   
3112:               DELETE FROM T_CORE_OBJ
3113:                     WHERE SID = p_obj;
3114:   
3115:               IF (v_note IS NOT NULL) THEN
3116:                   v_note :=
3117:                       'Deleted target data: ' || v_obj_row.obj_type_desc || ' Name= '
3118:                       || v_obj_row.full_name || v_crlf || RTRIM(v_note, ', ');
3119:   
3120:                   INSERT INTO T_OSI_NOTE
3121:                               (obj, note_type, note_text, creating_personnel)
3122:                        VALUES (p_replacement,
3123:                                (SELECT SID
3124:                                   FROM T_OSI_NOTE_TYPE
3125:                                  WHERE obj_type = Core_Obj.lookup_objtype('PARTICIPANT')
3126:                                    AND code = 'CONFIRM_REPLACE'),
3127:                                v_note,
3128:                                Core_Context.personnel_sid);
3129:               END IF;
3130:           END IF;
3131:       EXCEPTION
3132:           WHEN OTHERS THEN
3133:               log_error('replace_with: ' || SQLERRM);
3134:               RAISE;
3135:       END replace_with;
3136:   
3137:       PROCEDURE run_report_details(p_obj IN VARCHAR2) IS
3138:           v_date_fmt        VARCHAR2(11);
3139:           v_mugshot         BLOB;
3140:           v_ok              VARCHAR2(1000);
3141:           v_template_date   DATE;
3142:           v_mime_type       T_CORE_TEMPLATE.mime_type%TYPE;
3143:           v_mime_disp       T_CORE_TEMPLATE.mime_disposition%TYPE;
3144:           v_ot_code         T_CORE_OBJ_TYPE.code%TYPE;
3145:           v_pv_sid          T_OSI_PARTICIPANT_VERSION.SID%TYPE;
3146:           v_sa_record       v_osi_partic_sa%ROWTYPE;
3147:           v_counter         INTEGER                                 := 0;
3148:           v_clob            CLOB;
3149:           v_temp_clob       CLOB;
3150:           v_main_clob       CLOB;
3151:           v_pc_clob         CLOB;
3152:           v_sa_clob         CLOB;
3153:           v_bgcolor         VARCHAR2(9);
3154:           v_name            VARCHAR2(200);
3155:           v_no_data         VARCHAR2(35)                         := '&lt;tr&gt;&lt;td&gt;No Data Found&lt;/td&gt;&lt;/tr&gt;';
3156:           v_address_list    VARCHAR2(400)
3157:               := '&lt;table class="bTABLE"&gt;&lt;tr&gt;&lt;td class="bTD" width="55%"&gt;&lt;strong&gt;&lt;u&gt;All Addresses:&lt;/u&gt;&lt;/strong&gt;&lt;/td&gt;&lt;td class="bTD" width="15%"&gt;&lt;strong&gt;&lt;u&gt;Start Date&lt;/u&gt;&lt;/strong&gt;&lt;/td&gt;&lt;td class="bTD" width="15%"&gt;&lt;strong&gt;&lt;u&gt;End Date&lt;/u&gt;&lt;/strong&gt;&lt;/td&gt;&lt;td class="bTD" width="15%"&gt;&lt;strong&gt;&lt;u&gt;Known Date&lt;/u&gt;&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;[TOKEN@ADDRESS_ROWS]&lt;/table&gt;';
3158:   
3159:           v_seq             NUMBER := 0;
3160:       BEGIN
3161:           v_pv_sid := get_current_version(p_obj);
3162:           v_date_fmt := Core_Util.get_config('CORE.DATE_FMT_DAY');
3163:           -- Get the style for this report.
3164:           v_ok :=
3165:               Core_Template.get_latest('PARTIC_DETAILS_STYLE',
3166:                                        v_temp_clob,
3167:                                        v_template_date,
3168:                                        v_mime_type,
3169:                                        v_mime_disp);
3170:           -- Load up the main template.
3171:           v_ok :=
3172:               Core_Template.get_latest('PARTIC_DETAILS_MAIN',
3173:                                        v_main_clob,
3174:                                        v_template_date,
3175:                                        v_mime_type,
3176:                                        v_mime_disp);
3177:           -- Apply the style.
3178:           v_ok := Core_Template.replace_tag(v_main_clob, 'STYLE', v_temp_clob);
3179:           v_temp_clob := NULL;
3180:           -- All this applies to every participant type.
3181:           v_name := Osi_Participant.get_name(p_obj);
3182:           v_ok := Core_Template.replace_tag(v_main_clob, 'TITLE_CONTENTS', v_name);
3183:           v_ok := Core_Template.replace_tag(v_main_clob, 'CURRENT_NAME', v_name);
3184:   
3185:           -- Other names.
3186:           FOR x IN (SELECT full_name, type_description AS TYPE
3187:                       FROM v_osi_partic_name
3188:                      WHERE participant_version = v_pv_sid)
3189:           --AND is_current = 'N')
3190:           LOOP
3191:               Osi_Util.aitc(v_temp_clob, '&lt;b&gt;' || x.TYPE || '&lt;/b&gt; - ' || x.full_name || '&lt;br&gt;');
3192:           END LOOP;
3193:   
3194:           IF (v_temp_clob IS NULL) THEN
3195:               v_ok := Core_Template.replace_tag(v_main_clob, 'OTHER_NAMES', '');
3196:           ELSE
3197:               v_ok := Core_Template.replace_tag(v_main_clob, 'OTHER_NAMES', v_temp_clob);
3198:           END IF;
3199:   
3200:           v_temp_clob := NULL;
3201:   
3202:           -- Current address.
3203:           FOR x IN (SELECT single_line
3204:                       FROM v_osi_partic_address
3205:                      WHERE participant = p_obj AND is_current = 'Y')
3206:           LOOP
3207:               Osi_Util.aitc(v_temp_clob, x.single_line);
3208:           END LOOP;
3209:   
3210:           IF (v_temp_clob IS NULL) THEN
3211:               v_temp_clob := '';
3212:           END IF;
3213:   
3214:           v_ok := Core_Template.replace_tag(v_main_clob, 'CURRENT_ADDRESS', v_temp_clob);
3215:           v_temp_clob := NULL;
3216:   
3217:           FOR x IN (SELECT single_line, type_description AS TYPE, start_date, end_date, known_date
3218:                       FROM v_osi_partic_address
3219:                      WHERE participant = p_obj AND is_current = 'N' AND type_code &lt;&gt; 'BIRTH')
3220:           LOOP
3221:               v_counter := v_counter + 1;
3222:   
3223:               -- Alternate row colors.
3224:               IF (MOD(v_counter, 2) = 0) THEN
3225:                   v_bgcolor := '"#f5f5f5"';
3226:               ELSE
3227:                   v_bgcolor := '""';
3228:               END IF;
3229:   
3230:               IF (x.single_line IS NOT NULL) THEN
3231:                   Osi_Util.aitc(v_temp_clob,
3232:                                 '&lt;tr bgcolor=' || v_bgcolor || '&gt;&lt;td class="bTD" width="55%"&gt;&lt;STRONG&gt;'
3233:                                 || x.TYPE || '&lt;/STRONG&gt;' || ' - ' || x.single_line
3234:                                 || '&lt;/td&gt;&lt;td class="bTD" width="15%"&gt;'
3235:                                 || Osi_Util.display_precision_date(x.start_date)
3236:                                 || '&lt;/td&gt;&lt;td class="bTD" width="15%"&gt;'
3237:                                 || Osi_Util.display_precision_date(x.end_date)
3238:                                 || '&lt;/td&gt;&lt;td class="bTD" width="15%"&gt;'
3239:                                 || Osi_Util.display_precision_date(x.known_date) || '&lt;/td&gt;&lt;/tr&gt;');
3240:               END IF;
3241:           END LOOP;
3242:   
3243:           v_counter := 0;
3244:   
3245:           IF (v_temp_clob IS NULL) THEN
3246:               v_ok := Core_Template.replace_tag(v_main_clob, 'ADDRESS_LIST', '');
3247:           ELSE
3248:               -- v_address_list is the table that we will add rows of addresses to.
3249:               v_ok := Core_Template.replace_tag(v_main_clob, 'ADDRESS_LIST', v_address_list);
3250:               v_ok := Core_Template.replace_tag(v_main_clob, 'ADDRESS_ROWS', v_temp_clob);
3251:           END IF;
3252:   
3253:           v_temp_clob := NULL;
3254:   
3255:           SELECT ot.code
3256:             INTO v_ot_code
3257:             FROM T_CORE_OBJ o, T_CORE_OBJ_TYPE ot
3258:            WHERE o.SID = p_obj AND o.obj_type = ot.SID;
3259:   
3260:           -- Individual only data.
3261:           IF (v_ot_code = 'PART.INDIV') THEN
3262:               -- Make the first cell a bit smaller to fit the mugshot in.
3263:               v_ok := Core_Template.replace_tag(v_main_clob, 'IWIDTH', '80%');
3264:               -- Set the colSpan attribute to the default.
3265:               v_ok := Core_Template.replace_tag(v_main_clob, 'COLSPAN', '1');
3266:               -- Remove the replacement tokens for the other participant types.
3267:               v_ok := Core_Template.replace_tag(v_main_clob, 'NON_INDIV', '');
3268:   
3269:               SELECT MIN(SEQ)
3270:                INTO V_SEQ
3271:               FROM v_osi_partic_images
3272:               WHERE obj = p_obj;
3273:   
3274:               -- Get the mugshot image.
3275:               FOR x IN (SELECT   SID
3276:                             FROM v_osi_partic_images
3277:                            WHERE obj = p_obj AND seq = v_seq)
3278:               LOOP
3279:                   Osi_Util.aitc(v_temp_clob,
3280:                                 '&lt;td align="center"&gt;&lt;img src="f?p=' || v( 'APP_ID') || ':801:'
3281:                                 || v( 'SESSION') || ':' || x.SID
3282:                                 || '" border="0" alt="Mugshot" style="vertical-align:top;"/&gt;&lt;/td&gt;');
3283:               END LOOP;
3284:   
3285:               IF (v_temp_clob IS NULL) THEN
3286:                   Osi_Util.aitc(v_temp_clob,
3287:                                 '&lt;td align="center"&gt;&lt;strong&gt;Image Not Available&lt;/strong&gt;&lt;/td&gt;');
3288:               END IF;
3289:   
3290:               v_ok := Core_Template.replace_tag(v_main_clob, 'MUGSHOT', v_temp_clob);
3291:               v_temp_clob := NULL;
3292:               -- Contact list data.
3293:               Osi_Util.aitc(v_temp_clob, '&lt;strong&gt;&lt;u&gt;Contact Information List:&lt;/u&gt;&lt;/strong&gt;&lt;br&gt;');
3294:   
3295:               -- Build the list of contact values.
3296:               FOR x IN (SELECT r.description AS TYPE, c.VALUE
3297:                           FROM T_OSI_PARTIC_CONTACT c, T_OSI_REFERENCE r
3298:                          WHERE c.participant_version = v_pv_sid AND c.TYPE = r.SID)
3299:               LOOP
3300:                   Osi_Util.aitc(v_temp_clob, x.TYPE || ' - ' || x.VALUE || '&lt;br&gt;');
3301:               END LOOP;
3302:   
3303:               v_ok := Core_Template.replace_tag(v_main_clob, 'CONTACT_LIST', v_temp_clob);
3304:               v_temp_clob := NULL;
3305:               -- Physical information sub-template.
3306:               v_ok :=
3307:                   Core_Template.get_latest('PARTIC_DETAILS_PHYSICAL',
3308:                                            v_pc_clob,
3309:                                            v_template_date,
3310:                                            v_mime_type,
3311:                                            v_mime_disp);
3312:   
3313:               FOR x IN (SELECT a.single_line
3314:                           FROM v_osi_partic_address a
3315:                          WHERE a.participant_version = v_pv_sid AND a.type_code = 'BIRTH')
3316:               LOOP
3317:                   Osi_Util.aitc(v_temp_clob, x.single_line);
3318:               END LOOP;
3319:   
3320:               v_ok := Core_Template.replace_tag(v_pc_clob, 'BIRTH_ADDRESS', v_temp_clob);
3321:               v_temp_clob := NULL;
3322:   
3323:               -- Most of the physical data is handled here.
3324:               FOR x IN (SELECT bi.nationality, FLOOR((SYSDATE - bi.dob) / 365) AS age, bi.dob,
3325:                                bi.ethnicity_desc, pc.is_hard_of_hearing_desc, pc.hearing_comment,
3326:                                pc.has_teeth_desc, pc.teeth_comment, pc.has_facial_hair_desc,
3327:                                pc.facial_hair_comment, pc.wears_glasses_desc, pc.glasses_comment,
3328:                                pc.is_bald_desc, pc.bald_comment, pc.height, pc.weight,
3329:                                pc.hair_color_desc, pc.eye_color_desc, pc.sex_desc, pc.build_desc,
3330:                                pc.posture_desc, pc.writing_hand_desc, pc.race_desc
3331:                           FROM v_osi_partic_birth_info bi, v_osi_partic_physical_chars pc
3332:                          WHERE pc.SID = bi.SID AND pc.SID = v_pv_sid)
3333:               LOOP
3334:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'NATIONALITY', x.nationality);
3335:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'AGE', x.age);
3336:                   v_ok :=
3337:                        Core_Template.replace_tag(v_pc_clob, 'BIRTH_DATE', TO_CHAR(x.dob, v_date_fmt));
3338:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'ETHNICITY', x.ethnicity_desc);
3339:                   v_ok :=
3340:                       Core_Template.replace_tag(v_pc_clob,
3341:                                                 'IS_HARD_OF_HEARING',
3342:                                                 x.is_hard_of_hearing_desc);
3343:                   v_ok :=
3344:                       Core_Template.replace_tag(v_pc_clob,
3345:                                                 'HARD_OF_HEARING_COMMENT',
3346:                                                 x.hearing_comment);
3347:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'HAS_TEETH', x.has_teeth_desc);
3348:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'TEETH_COMMENT', x.teeth_comment);
3349:                   v_ok :=
3350:                        Core_Template.replace_tag(v_pc_clob, 'HAS_FACIAL_HAIR', x.has_facial_hair_desc);
3351:                   v_ok :=
3352:                       Core_Template.replace_tag(v_pc_clob,
3353:                                                 'FACIAL_HAIR_COMMENT',
3354:                                                 x.facial_hair_comment);
3355:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'WEARS_GLASSES', x.wears_glasses_desc);
3356:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'GLASSES_COMMENT', x.glasses_comment);
3357:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'IS_BALD', x.is_bald_desc);
3358:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'BALD_COMMENT', x.bald_comment);
3359:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'HEIGHT', x.height);
3360:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'WEIGHT', x.weight);
3361:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'HAIR_COLOR', x.hair_color_desc);
3362:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'EYE_COLOR', x.eye_color_desc);
3363:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'SEX', x.sex_desc);
3364:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'BUILD', x.build_desc);
3365:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'POSTURE', x.posture_desc);
3366:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'WRITING_HAND', x.writing_hand_desc);
3367:                   v_ok := Core_Template.replace_tag(v_pc_clob, 'RACE', x.race_desc);
3368:               END LOOP;
3369:   
3370:               -- Get citizenships.
3371:               FOR x IN (SELECT d.description AS country
3372:                           FROM T_OSI_PARTIC_CITIZENSHIP pc, T_DIBRS_COUNTRY d
3373:                          WHERE pc.participant_version = v_pv_sid AND pc.country = d.SID)
3374:               LOOP
3375:                   Osi_Util.aitc(v_temp_clob, x.country || '; ');
3376:               END LOOP;
3377:   
3378:               v_ok := Core_Template.replace_tag(v_pc_clob, 'CITIZENSHIP', RTRIM(v_temp_clob, '; '));
3379:               v_temp_clob := NULL;
3380:   
3381:               -- Get special marks.
3382:               FOR x IN (SELECT m.description AS comment_txt, ml.description AS LOCATION,
3383:                                mt.description AS TYPE
3384:                           FROM T_OSI_PARTIC_MARK m,
3385:                                T_DIBRS_MARK_LOCATION_TYPE ml,
3386:                                T_DIBRS_MARK_TYPE mt
3387:                          WHERE m.participant_version = v_pv_sid
3388:                            AND m.mark_type = mt.SID
3389:                            AND m.mark_location = ml.SID)
3390:               LOOP
3391:                   IF (x.comment_txt IS NULL) THEN
3392:                       Osi_Util.aitc(v_temp_clob, x.TYPE);
3393:                   ELSE
3394:                       Osi_Util.aitc(v_temp_clob, x.comment_txt || '-' || x.TYPE);
3395:                   END IF;
3396:   
3397:                   Osi_Util.aitc(v_temp_clob, '-' || x.LOCATION || ';');
3398:               END LOOP;
3399:   
3400:               v_ok := Core_Template.replace_tag(v_pc_clob, 'SPECIAL_MARKS', RTRIM(v_temp_clob, '; '));
3401:               v_temp_clob := NULL;
3402:               -- Add the sub-template to the main template.
3403:               v_ok := Core_Template.replace_tag(v_main_clob, 'PARTIC_DETAILS_PHYSICAL', v_pc_clob);
3404:               -- Service affiliation sub-template.
3405:               v_ok :=
3406:                   Core_Template.get_latest('PARTIC_DETAILS_SA',
3407:                                            v_sa_clob,
3408:                                            v_template_date,
3409:                                            v_mime_type,
3410:                                            v_mime_disp);
3411:   
3412:               BEGIN
3413:                   SELECT *
3414:                     INTO v_sa_record
3415:                     FROM v_osi_partic_sa
3416:                    WHERE SID = v_pv_sid;
3417:   
3418:                   IF (   v_sa_record.service_desc IS NOT NULL
3419:                       OR v_sa_record.pay_grade_desc IS NOT NULL
3420:                       OR v_sa_record.pay_plan_desc IS NOT NULL
3421:                       OR v_sa_record.rank IS NOT NULL
3422:                       OR v_sa_record.rank_date IS NOT NULL
3423:                       OR v_sa_record.component_desc IS NOT NULL
3424:                       OR v_sa_record.affiliation_desc IS NOT NULL
3425:                       OR v_sa_record.specialty_code IS NOT NULL
3426:                       OR v_sa_record.fsa_rank IS NOT NULL
3427:                       OR v_sa_record.fsa_equiv_rank IS NOT NULL
3428:                       OR v_sa_record.fsa_rank_date IS NOT NULL) THEN
3429:                       v_ok :=
3430:                             Core_Template.replace_tag(v_sa_clob, 'SERVICE', v_sa_record.service_desc);
3431:                       v_ok :=
3432:                           Core_Template.replace_tag(v_sa_clob,
3433:                                                     'PAY_GRADE',
3434:                                                     v_sa_record.pay_grade_desc);
3435:                       v_ok :=
3436:                            Core_Template.replace_tag(v_sa_clob, 'PAY_PLAN', v_sa_record.pay_plan_desc);
3437:                       v_ok := Core_Template.replace_tag(v_sa_clob, 'RANK', v_sa_record.rank);
3438:                       v_ok :=
3439:                           Core_Template.replace_tag(v_sa_clob,
3440:                                                     'RANK_DATE',
3441:                                                     TO_CHAR(v_sa_record.rank_date, v_date_fmt));
3442:                       v_ok :=
3443:                           Core_Template.replace_tag(v_sa_clob, 'COMPONENT',
3444:                                                     v_sa_record.component_desc);
3445:                       v_ok :=
3446:                           Core_Template.replace_tag(v_sa_clob,
3447:                                                     'AFFILIATION',
3448:                                                     v_sa_record.affiliation_desc);
3449:                       v_ok :=
3450:                           Core_Template.replace_tag(v_sa_clob,
3451:                                                     'SPECIALTY_CODE',
3452:                                                     v_sa_record.specialty_code);
3453:                       v_ok :=
3454:                           Core_Template.replace_tag(v_sa_clob,
3455:                                                     'FSA_SERVICE',
3456:                                                     v_sa_record.fsa_service_desc);
3457:                       v_ok := Core_Template.replace_tag(v_sa_clob, 'FSA_RANK', v_sa_record.fsa_rank);
3458:                       v_ok :=
3459:                           Core_Template.replace_tag(v_sa_clob,
3460:                                                     'FSA_EQUIV_RANK',
3461:                                                     v_sa_record.fsa_equiv_rank);
3462:                       v_ok :=
3463:                           Core_Template.replace_tag(v_sa_clob,
3464:                                                     'FSA_RANK_DATE',
3465:                                                     TO_CHAR(v_sa_record.fsa_rank_date, v_date_fmt));
3466:                       -- Add the sub-template to the main template.
3467:                       v_ok := Core_Template.replace_tag(v_main_clob, 'PARTIC_DETAILS_SA', v_sa_clob);
3468:                   ELSE
3469:                       v_ok := Core_Template.replace_tag(v_main_clob, 'PARTIC_DETAILS_SA', '');
3470:                   END IF;
3471:               EXCEPTION
3472:                   WHEN NO_DATA_FOUND THEN
3473:                       v_ok := Core_Template.replace_tag(v_main_clob, 'PARTIC_DETAILS_SA', '');
3474:               END;
3475:           END IF;
3476:   
3477:           -- Nonindividual only data.
3478:           IF (v_ot_code LIKE 'PART.NONINDIV%') THEN
3479:               -- Make the first cell as wide as the table since there is no mugshot.
3480:               v_ok := Core_Template.replace_tag(v_main_clob, 'IWIDTH', '100%');
3481:               -- Set the colSpan attribute to 2 so any following table rows that have two columns
3482:               -- won't mess up the first row.
3483:               v_ok := Core_Template.replace_tag(v_main_clob, 'COLSPAN', '2');
3484:               -- Remove the replacement tokens not applicable to these participant types.
3485:               v_ok := Core_Template.replace_tag(v_main_clob, 'MUGSHOT', '');
3486:               v_ok := Core_Template.replace_tag(v_main_clob, 'CONTACT_LIST', '');
3487:               v_ok := Core_Template.replace_tag(v_main_clob, 'PARTIC_DETAILS_PHYSICAL', '');
3488:               v_ok := Core_Template.replace_tag(v_main_clob, 'PARTIC_DETAILS_SA', '');
3489:               v_temp_clob := NULL;
3490:   
3491:               FOR x IN (SELECT r.description AS TYPE, n.co_cage, n.org_uic,
3492:                                r2.description AS org_majcom, n.org_num_people,
3493:                                DECODE(n.org_high_risk, 'Y', 'Yes', 'N', 'No', '') AS org_high_risk,
3494:                                n.prog_description
3495:                           FROM T_OSI_PARTICIPANT_NONHUMAN n, T_OSI_REFERENCE r, T_OSI_REFERENCE r2
3496:                          WHERE n.sub_type = r.SID(+) AND n.org_majcom = r2.SID(+)
3497:                                AND n.SID = v_pv_sid)
3498:               LOOP
3499:                   IF (v_ot_code = 'PART.NONINDIV.COMP') THEN
3500:                       Osi_Util.aitc(v_temp_clob, '&lt;tr&gt;&lt;td colspan="2" width="100%"&gt;');
3501:                       Osi_Util.aitc(v_temp_clob, '&lt;strong&gt;Sub Type:&lt;/strong&gt; ' || x.TYPE || '&lt;br&gt;');
3502:                       Osi_Util.aitc(v_temp_clob, '&lt;strong&gt;Cage Code:&lt;/strong&gt; ' || x.co_cage);
3503:                       Osi_Util.aitc(v_temp_clob, '&lt;/td&gt;&lt;/tr&gt;');
3504:                   ELSIF(v_ot_code = 'PART.NONINDIV.ORG') THEN
3505:                       Osi_Util.aitc(v_temp_clob, '&lt;tr&gt;&lt;td colspan="2" width="100%"&gt;');
3506:                       Osi_Util.aitc(v_temp_clob, '&lt;strong&gt;Sub Type:&lt;/strong&gt; ' || x.TYPE || '&lt;br&gt;');
3507:                       Osi_Util.aitc(v_temp_clob, '&lt;strong&gt;UIC:&lt;/strong&gt; ' || x.org_uic || '&lt;br&gt;');
3508:                       Osi_Util.aitc(v_temp_clob,
3509:                                     '&lt;strong&gt;Major Command:&lt;/strong&gt; ' || x.org_majcom || '&lt;br&gt;');
3510:                       Osi_Util.aitc(v_temp_clob,
3511:                                     '&lt;strong&gt;Number of People:&lt;/strong&gt; ' || x.org_num_people
3512:                                     || '&lt;br&gt;');
3513:                       Osi_Util.aitc(v_temp_clob,
3514:                                     '&lt;strong&gt;High Risk:&lt;/strong&gt; ' || x.org_high_risk || '&lt;br&gt;');
3515:                       Osi_Util.aitc(v_temp_clob, '&lt;/td&gt;&lt;/tr&gt;');
3516:                       -- Time for organization specifics. Add the header row first.
3517:                       Osi_Util.aitc(v_temp_clob, '&lt;tr&gt;&lt;td colspan="2"&gt;&lt;strong&gt;Specifics: &lt;/strong&gt;');
3518:   
3519:                       FOR x IN (SELECT a.comments, AT.CATEGORY, AT.sub_category
3520:                                   FROM T_OSI_PARTIC_ORG_ATTR a, T_OSI_PARTIC_ORG_ATTR_TYPE AT
3521:                                  WHERE a.participant_version = v_pv_sid AND a.ATTRIBUTE = AT.SID(+))
3522:                       LOOP
3523:                           IF (v_counter = 0) THEN
3524:                               -- Close the header row.
3525:                               Osi_Util.aitc(v_temp_clob, '&lt;/td&gt;&lt;/tr&gt;');
3526:                           END IF;
3527:   
3528:                           v_counter := v_counter + 1;
3529:                           Osi_Util.aitc(v_temp_clob,
3530:                                         '&lt;tr&gt;&lt;td&gt;&lt;strong&gt;' || v_counter || '&lt;/strong&gt;&lt;/td&gt;');
3531:                           Osi_Util.aitc(v_temp_clob,
3532:                                         '&lt;td&gt;&lt;strong&gt;Category&lt;/strong&gt; - ' || x.CATEGORY || '&lt;br&gt;');
3533:                           Osi_Util.aitc(v_temp_clob,
3534:                                         '&lt;strong&gt;Sub-Category&lt;/strong&gt; - ' || x.sub_category || '&lt;br&gt;');
3535:                           Osi_Util.aitc(v_temp_clob, '&lt;strong&gt;Comments&lt;/strong&gt; - ' || x.comments);
3536:                           Osi_Util.aitc(v_temp_clob, '&lt;/td&gt;&lt;/tr&gt;');
3537:                       END LOOP;
3538:   
3539:                       IF (v_counter = 0) THEN
3540:                           Osi_Util.aitc(v_temp_clob, 'No Data Found');
3541:                           -- Close the header row.
3542:                           Osi_Util.aitc(v_temp_clob, '&lt;/td&gt;&lt;/tr&gt;');
3543:                       END IF;
3544:   
3545:                       v_counter := 0;
3546:                   ELSIF(v_ot_code = 'PART.NONINDIV.PROG') THEN
3547:                       Osi_Util.aitc(v_temp_clob, '&lt;tr&gt;&lt;td colspan="2" width="100%"&gt;');
3548:                       Osi_Util.aitc(v_temp_clob,
3549:                                     '&lt;strong&gt;Program Description:&lt;/strong&gt; ' || x.prog_description);
3550:                       Osi_Util.aitc(v_temp_clob, '&lt;/td&gt;&lt;/tr&gt;');
3551:                   END IF;
3552:   
3553:                   v_ok := Core_Template.replace_tag(v_main_clob, 'NON_INDIV', v_temp_clob);
3554:                   v_temp_clob := NULL;
3555:               END LOOP;
3556:           END IF;
3557:   
3558:           -- Remaining object data.
3559:           v_counter := 0;
3560:   
3561:           -- Identifying Numbers.
3562:           FOR x IN (SELECT   nt.description AS TYPE, n.num_value, ds.description AS issue_state,
3563:                              dc.description AS issue_country, n.issue_province
3564:                         FROM T_OSI_PARTIC_NUMBER n,
3565:                              T_OSI_PARTIC_NUMBER_TYPE nt,
3566:                              T_DIBRS_STATE ds,
3567:                              T_DIBRS_COUNTRY dc
3568:                        WHERE n.participant_version = v_pv_sid
3569:                          AND n.num_type = nt.SID
3570:                          AND n.issue_state = ds.SID(+)
3571:                          AND n.issue_country = dc.SID(+)
3572:                     ORDER BY TYPE)
3573:           LOOP
3574:               v_counter := v_counter + 1;
3575:               Osi_Util.aitc(v_temp_clob,
3576:                             '&lt;tr&gt;&lt;td width="5%"&gt;&lt;strong&gt;' || v_counter || '&lt;/strong&gt;&lt;/td&gt;');
3577:               Osi_Util.aitc(v_temp_clob, '&lt;td&gt;' || x.TYPE);
3578:               Core_Util.append_info_to_clob(v_temp_clob, x.num_value);
3579:               Core_Util.append_info_to_clob(v_temp_clob, x.issue_state);
3580:               Core_Util.append_info_to_clob(v_temp_clob, x.issue_country);
3581:               Core_Util.append_info_to_clob(v_temp_clob, x.issue_province);
3582:               Osi_Util.aitc(v_temp_clob, '&lt;/td&gt;&lt;/td&gt;&lt;/tr&gt;');
3583:           END LOOP;
3584:   
3585:           IF (v_temp_clob IS NULL) THEN
3586:               Osi_Util.aitc(v_temp_clob, v_no_data);
3587:           END IF;
3588:   
3589:           v_ok := Core_Template.replace_tag(v_main_clob, 'ID_NUMBERS', v_temp_clob);
3590:           v_temp_clob := NULL;
3591:           -- Associated Activities
3592:           -- TODO: Add Handling Instructions
3593:           v_counter := 0;
3594:   
3595:           FOR x IN (SELECT SID, ROLE, activity, activity_date, ID, title
3596:                       FROM v_osi_partic_act_involvement
3597:                      WHERE participant_version = v_pv_sid)
3598:           LOOP
3599:               v_counter := v_counter + 1;
3600:               Osi_Util.aitc(v_temp_clob,
3601:                             '&lt;tr&gt;&lt;td width="5%"&gt;&lt;strong&gt;' || v_counter || '&lt;/strong&gt;&lt;/td&gt;');
3602:               Osi_Util.aitc(v_temp_clob, '&lt;td&gt;' || Osi_Object.get_open_link(x.activity, x.ID));
3603:               Core_Util.append_info_to_clob(v_temp_clob, x.title);
3604:               Core_Util.append_info_to_clob(v_temp_clob, x.ROLE || '&lt;/td&gt;&lt;/tr&gt;');
3605:           END LOOP;
3606:   
3607:           IF (v_temp_clob IS NULL) THEN
3608:               Osi_Util.aitc(v_temp_clob, v_no_data);
3609:           END IF;
3610:   
3611:           v_ok := Core_Template.replace_tag(v_main_clob, 'ASSOCIATED_ACTIVITIES', v_temp_clob);
3612:           v_temp_clob := NULL;
3613:           -- Associated Files
3614:           -- TODO: Add Handling Instructions
3615:           v_counter := 0;
3616:   
3617:           FOR x IN (SELECT SID, ROLE, file_sid, ID, title
3618:                       FROM v_osi_partic_file_involvement
3619:                      WHERE participant_version = v_pv_sid)
3620:           LOOP
3621:               v_counter := v_counter + 1;
3622:               Osi_Util.aitc(v_temp_clob,
3623:                             '&lt;tr&gt;&lt;td width="5%"&gt;&lt;strong&gt;' || v_counter || '&lt;/strong&gt;&lt;/td&gt;');
3624:               Osi_Util.aitc(v_temp_clob, '&lt;td&gt;' || Osi_Object.get_open_link(x.file_sid, x.ID));
3625:               Core_Util.append_info_to_clob(v_temp_clob, x.title);
3626:               Core_Util.append_info_to_clob(v_temp_clob, x.ROLE || '&lt;/td&gt;&lt;/tr&gt;');
3627:           END LOOP;
3628:   
3629:           IF (v_temp_clob IS NULL) THEN
3630:               Osi_Util.aitc(v_temp_clob, v_no_data);
3631:           END IF;
3632:   
3633:           v_ok := Core_Template.replace_tag(v_main_clob, 'ASSOCIATED_FILES', v_temp_clob);
3634:           v_temp_clob := NULL;
3635:           -- Attachments: The only ones we're interested in are mugshots.
3636:           v_counter := 0;
3637:   
3638:           FOR x IN (SELECT SID, NVL(description, SOURCE) AS description, content
3639:                       FROM v_osi_partic_images
3640:                      WHERE obj = p_obj)
3641:           LOOP
3642:               v_counter := v_counter + 1;
3643:               Osi_Util.aitc(v_temp_clob,
3644:                             '&lt;tr&gt;&lt;td width="5%"&gt;&lt;strong&gt;' || v_counter || '&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;');
3645:   
3646:               IF (x.content IS NOT NULL) THEN
3647:                   Osi_Util.aitc(v_temp_clob,
3648:                                 '&lt;a href="f?p=' || v( 'APP_ID') || ':250:' || v( 'SESSION') || ':'
3649:                                 || x.SID || '" target="blank"/&gt;');
3650:               END IF;
3651:   
3652:               Osi_Util.aitc(v_temp_clob, x.description || '&lt;/td&gt;&lt;/tr&gt;');
3653:           END LOOP;
3654:   
3655:           IF (v_temp_clob IS NULL) THEN
3656:               Osi_Util.aitc(v_temp_clob, v_no_data);
3657:           END IF;
3658:   
3659:           v_ok := Core_Template.replace_tag(v_main_clob, 'ATTACHMENTS', v_temp_clob);
3660:           v_temp_clob := NULL;
3661:           -- Relationships
3662:           v_counter := 0;
3663:   
3664:           FOR x IN (SELECT   this_participant, related_to,
3665:                              DECODE(get_participant(v_pv_sid),
3666:                                     this_participant, related_name,
3667:                                     this_name) AS NAME,
3668:                              description, specifics, comments, mod2_value
3669:                         FROM v_osi_partic_relation
3670:                        WHERE (   this_participant = get_participant(v_pv_sid)
3671:                               OR related_to = get_participant(v_pv_sid))
3672:                          AND description IS NOT NULL
3673:                     ORDER BY description, NAME)
3674:           LOOP
3675:               IF (   (NVL(x.mod2_value, 'xxx') LIKE 'ORCON%')
3676:                   OR (NVL(x.mod2_value, 'xxx') LIKE 'LIMDIS%')) THEN
3677:                   --TODO: Replace with a system log entry.
3678:                   log_error
3679:                       ('run_report_details: Object is ORCON or LIMDIS - User does not have permission to view document therefore no link will be generated');
3680:               ELSE
3681:                   v_counter := v_counter + 1;
3682:                   Osi_Util.aitc(v_temp_clob,
3683:                                 '&lt;tr&gt;&lt;td width="5%"&gt;&lt;strong&gt;' || v_counter || '&lt;/strong&gt;&lt;/td&gt;');
3684:   
3685:                   IF (x.related_to = v_pv_sid) THEN
3686:                       Osi_Util.aitc
3687:                               (v_temp_clob,
3688:                                '&lt;td&gt;' || x.description || ': '
3689:                                || Osi_Object.get_tagline_link(get_current_version(x.this_participant))
3690:                                || '&lt;/td&gt;&lt;/tr&gt;');
3691:                   ELSE
3692:                       Osi_Util.aitc(v_temp_clob,
3693:                                     '&lt;td&gt;' || x.description || ': '
3694:                                     || Osi_Object.get_tagline_link(get_current_version(x.related_to))
3695:                                     || '&lt;/td&gt;&lt;/tr&gt;');
3696:                   END IF;
3697:   
3698:                   IF (x.specifics IS NOT NULL) THEN
3699:                       Osi_Util.aitc(v_temp_clob,
3700:                                     '&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td bgcolor="#f5f5f5"&gt;&lt;b&gt;Specifics: &lt;/b&gt;'
3701:                                     || x.specifics || '&lt;/td&gt;&lt;/tr&gt;');
3702:                   END IF;
3703:   
3704:                   IF (LENGTH(x.comments) &gt; 0) THEN
3705:                       Osi_Util.aitc(v_temp_clob,
3706:                                     '&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td bgcolor="#f5f5f5"&gt;&lt;b&gt;Comments: &lt;/b&gt;'
3707:                                     || x.comments || '&lt;/td&gt;&lt;/tr&gt;');
3708:                   END IF;
3709:               END IF;
3710:           END LOOP;
3711:   
3712:           IF (v_temp_clob IS NULL) THEN
3713:               Osi_Util.aitc(v_temp_clob, v_no_data);
3714:           END IF;
3715:   
3716:           v_ok := Core_Template.replace_tag(v_main_clob, 'RELATIONSHIPS', v_temp_clob);
3717:           v_temp_clob := NULL;
3718:           -- Notes
3719:           v_counter := 0;
3720:   
3721:           FOR x IN (SELECT nt.description AS TYPE, n.create_on, n.note_text
3722:                       FROM T_OSI_NOTE n, T_OSI_NOTE_TYPE nt
3723:                      WHERE n.obj = p_obj AND n.note_type = nt.SID)
3724:           LOOP
3725:               v_counter := v_counter + 1;
3726:               Osi_Util.aitc(v_temp_clob,
3727:                             '&lt;tr&gt;&lt;td width="25%"&gt;&lt;strong&gt;' || v_counter || ': ' || x.TYPE || '&lt;br&gt;'
3728:                             || TO_CHAR(x.create_on, v_date_fmt || ' hh24:mi:ss') || '&lt;/strong&gt;&lt;/td&gt;');
3729:               Osi_Util.aitc(v_temp_clob, '&lt;td&gt;' || Core_Util.html_ize(x.note_text) || '&lt;/td&gt;&lt;/tr&gt;');
3730:           END LOOP;
3731:   
3732:           IF (v_temp_clob IS NULL) THEN
3733:               Osi_Util.aitc(v_temp_clob, v_no_data);
3734:           END IF;
3735:   
3736:           v_ok := Core_Template.replace_tag(v_main_clob, 'NOTES', v_temp_clob);
3737:           v_ok := Core_Util.serve_clob(v_main_clob);
3738:       EXCEPTION
3739:           WHEN OTHERS THEN
3740:               log_error('run_report_details: ' || SQLERRM);
3741:               RAISE;
3742:       END run_report_details;
3743:   
3744:       PROCEDURE set_address_sid(p_sid IN VARCHAR2) IS
3745:       BEGIN
3746:           v_address_sid := p_sid;
3747:       END set_address_sid;
3748:   
3749:       PROCEDURE set_current_address(p_pvop IN VARCHAR2, p_address_sid IN VARCHAR2 := NULL) IS
3750:           v_new_current   T_OSI_PARTIC_ADDRESS.SID%TYPE;
3751:       BEGIN
3752:           v_new_current := p_address_sid;
3753:   
3754:           IF (v_new_current IS NULL) THEN
3755:               -- No address was given so find the latest one added.
3756:               FOR x IN (SELECT   a.SID
3757:                             FROM v_osi_partic_address a
3758:                            WHERE (   a.participant_version = p_pvop
3759:                                   OR a.participant = p_pvop)
3760:                         ORDER BY a.create_on DESC)
3761:               LOOP
3762:                   v_new_current := x.SID;
3763:                   EXIT;
3764:               END LOOP;
3765:           END IF;
3766:   
3767:           UPDATE v_osi_participant_version
3768:              SET current_address = v_new_current
3769:            WHERE SID = p_pvop
3770:               OR (participant = p_pvop AND SID = current_version);
3771:       END set_current_address;
3772:   
3773:       PROCEDURE set_current_name(p_pvop IN VARCHAR2, p_name_sid IN VARCHAR2 := NULL) IS
3774:           v_new_current   T_OSI_PARTIC_NAME.SID%TYPE;
3775:       BEGIN
3776:           v_new_current := p_name_sid;
3777:   
3778:           IF (v_new_current IS NULL) THEN
3779:               -- No name was given so see if there is a LEGAL name.
3780:               BEGIN
3781:                   SELECT n.SID
3782:                     INTO v_new_current
3783:                     FROM T_OSI_PARTIC_NAME n,
3784:                          v_osi_participant_version pv,
3785:                          T_OSI_PARTIC_NAME_TYPE_MAP t
3786:                    WHERE (   pv.SID = p_pvop
3787:                           OR (pv.participant = p_pvop AND pv.SID = pv.current_version))
3788:                      AND n.participant_version = pv.SID
3789:                      AND n.name_type = t.SID
3790:                      AND t.max_num = 1;
3791:               EXCEPTION
3792:                   WHEN NO_DATA_FOUND THEN
3793:                       v_new_current := NULL;
3794:               END;
3795:   
3796:               IF (v_new_current IS NULL) THEN
3797:                   -- There was no LEGAL name so get the latest name added.
3798:                   FOR x IN (SELECT   n.SID
3799:                                 FROM T_OSI_PARTIC_NAME n,
3800:                                      v_osi_participant_version pv,
3801:                                      T_OSI_PARTIC_NAME_TYPE t
3802:                                WHERE (   pv.SID = p_pvop
3803:                                       OR (pv.participant = p_pvop AND pv.SID = pv.current_version))
3804:                                  AND n.participant_version = pv.SID
3805:                                  AND n.name_type = t.SID
3806:                             ORDER BY n.create_on DESC)
3807:                   LOOP
3808:                       v_new_current := x.SID;
3809:                       EXIT;
3810:                   END LOOP;
3811:               END IF;
3812:           END IF;
3813:   
3814:           UPDATE v_osi_participant_version
3815:              SET current_name = v_new_current
3816:            WHERE SID = p_pvop
3817:               OR (participant = p_pvop AND SID = current_version);
3818:       EXCEPTION
3819:           WHEN OTHERS THEN
3820:               log_error('set_current_name: ' || SQLERRM);
3821:       END set_current_name;
3822:   
3823:       PROCEDURE set_image_sid(p_sid IN VARCHAR2) IS
3824:       BEGIN
3825:           v_image_sid := p_sid;
3826:       END set_image_sid;
3827:   
3828:       /* Given an Object Type SID, USAGE and CODE - Returns the SID of the involvement type */
3829:       FUNCTION get_inv_type_sid(p_obj_type IN VARCHAR2, p_usage IN VARCHAR2, p_code IN VARCHAR2)
3830:           RETURN VARCHAR2 IS
3831:           v_return   T_OSI_PARTIC_ROLE_TYPE.SID%TYPE;
3832:       BEGIN
3833:           SELECT SID
3834:             INTO v_return
3835:             FROM T_OSI_PARTIC_ROLE_TYPE
3836:            WHERE obj_type = p_obj_type AND USAGE = p_usage AND code = p_code;
3837:   
3838:           RETURN v_return;
3839:       EXCEPTION
3840:           WHEN NO_DATA_FOUND THEN
3841:               --No matching TYPE SID was found
3842:               RETURN NULL;
3843:           WHEN OTHERS THEN
3844:               --Some other error
3845:               log_error('osi_participant.get_inv_type_sid: ' || SQLERRM);
3846:               RAISE;
3847:       END get_inv_type_sid;
3848:   
3849:       PROCEDURE import_legacy_part_version(
3850:           p_legacy_person_version   IN   VARCHAR2,
3851:           p_new_person              IN   VARCHAR2) IS
3852:           --T_OSI_PERSON_CHARS Columns
3853:           v_osi_person_chars_sex           T_OSI_PERSON_CHARS.sex%TYPE;
3854:           v_osi_person_chars_eye_color     T_OSI_PERSON_CHARS.eye_color%TYPE;
3855:           v_osi_person_chars_hair_color    T_OSI_PERSON_CHARS.hair_color%TYPE;
3856:           v_osi_person_chars_blood_type    T_OSI_PERSON_CHARS.blood_type%TYPE;
3857:           v_osi_person_chars_race          T_OSI_PERSON_CHARS.race%TYPE;
3858:           v_osi_person_chars_sa_pay_plan   T_OSI_PERSON_CHARS.sa_pay_plan%TYPE;
3859:           v_osi_person_chars_sa_pay_grad   T_OSI_PERSON_CHARS.sa_pay_grade%TYPE;
3860:           v_osi_person_chars_sa_pay_band   T_OSI_PERSON_CHARS.sa_pay_band%TYPE;
3861:           --T_OSI_PARTICIPANT_HUMAN Columns
3862:           v_osi_partic_human_build         T_OSI_PARTICIPANT_HUMAN.BUILD%TYPE;
3863:           v_osi_partic_human_posture       T_OSI_PARTICIPANT_HUMAN.posture%TYPE;
3864:           v_osi_partic_human_writ_hand     T_OSI_PARTICIPANT_HUMAN.writing_hand%TYPE;
3865:           v_osi_partic_human_rel_inv       T_OSI_PARTICIPANT_HUMAN.religion_involvement%TYPE;
3866:           v_osi_partic_human_clearance     T_OSI_PARTICIPANT_HUMAN.clearance%TYPE;
3867:           v_osi_partic_human_sa_service    T_OSI_PARTICIPANT_HUMAN.sa_service%TYPE;
3868:           v_osi_partic_human_sa_affil      T_OSI_PARTICIPANT_HUMAN.sa_affiliation%TYPE;
3869:           v_osi_partic_human_sa_comp       T_OSI_PARTICIPANT_HUMAN.sa_component%TYPE;
3870:           v_osi_partic_human_sa_res        T_OSI_PARTICIPANT_HUMAN.sa_reservist%TYPE;
3871:           v_osi_partic_human_sa_res_stat   T_OSI_PARTICIPANT_HUMAN.sa_reservist_status%TYPE;
3872:           v_osi_partic_human_sa_res_type   T_OSI_PARTICIPANT_HUMAN.sa_reservist_type%TYPE;
3873:           v_osi_partic_human_fsa_service   T_OSI_PARTICIPANT_HUMAN.fsa_service%TYPE;
3874:           v_osi_partic_human_sus_io        T_OSI_PARTICIPANT_HUMAN.suspected_io%TYPE;
3875:           v_osi_partic_human_known_io      T_OSI_PARTICIPANT_HUMAN.known_io%TYPE;
3876:           v_osi_partic_human_bald          T_OSI_PARTICIPANT_HUMAN.is_bald%TYPE;
3877:           v_osi_partic_human_hard_hear     T_OSI_PARTICIPANT_HUMAN.is_hard_of_hearing%TYPE;
3878:           v_osi_partic_human_facial_hair   T_OSI_PARTICIPANT_HUMAN.has_facial_hair%TYPE;
3879:           v_osi_partic_human_wear_glass    T_OSI_PARTICIPANT_HUMAN.wears_glasses%TYPE;
3880:           v_osi_partic_human_has_teeth     T_OSI_PARTICIPANT_HUMAN.has_teeth%TYPE;
3881:           --T_OSI_PARTICIPANT_NONHUMAN Columns
3882:           v_osi_partic_nonh_sub_type       T_OSI_PARTICIPANT_NONHUMAN.SUB_TYPE%TYPE;
3883:           v_osi_partic_nonh_co_cage        T_OSI_PARTICIPANT_NONHUMAN.CO_CAGE%TYPE;
3884:           v_osi_partic_nonh_co_duns        T_OSI_PARTICIPANT_NONHUMAN.CO_DUNS%TYPE;
3885:           v_osi_partic_nonh_org_uic        T_OSI_PARTICIPANT_NONHUMAN.ORG_UIC%TYPE;
3886:           v_osi_partic_nonh_org_majcom     T_OSI_PARTICIPANT_NONHUMAN.ORG_MAJCOM%TYPE;
3887:           v_osi_partic_nonh_org_highrisk   T_OSI_PARTICIPANT_NONHUMAN.ORG_HIGH_RISK%TYPE;
3888:           v_osi_partic_nonh_org_nopeople   T_OSI_PARTICIPANT_NONHUMAN.ORG_NUM_PEOPLE%TYPE;
3889:           v_osi_partic_nonh_org_suppunit   T_OSI_PARTICIPANT_NONHUMAN.ORG_SUPPORTING_UNIT%TYPE;
3890:           v_osi_partic_nonh_prog_desc      T_OSI_PARTICIPANT_NONHUMAN.PROG_DESCRIPTION%TYPE;
3891:           --T_OSI_PARTIC_NAME Columns
3892:           v_osi_partic_name_name_type      T_OSI_PARTIC_NAME.name_type%TYPE;
3893:           --T_OSI_ADDRESS Columns
3894:           v_osi_address_address_type       T_OSI_ADDRESS.address_type%TYPE;
3895:           --T_OSI_PARTIC_NUMBER Columns
3896:           v_osi_partic_number_num_type     T_OSI_PARTIC_NUMBER.num_type%TYPE;
3897:           --T_OSI_PARTIC_CONTACT Columns
3898:           v_osi_partic_contact_type        T_OSI_PARTIC_CONTACT.TYPE%TYPE;
3899:           --T_OSI_PARTIC_VEHICLE Columns
3900:           v_osi_partic_vehicle_body_type   T_OSI_PARTIC_VEHICLE.body_type%TYPE;
3901:           v_osi_partic_vehicle_role        T_OSI_PARTIC_VEHICLE.ROLE%TYPE;
3902:           --Other
3903:           v_new_sid_version                VARCHAR2(20);
3904:           v_migration_cnt_total            NUMBER                                              := 0;
3905:           v_new_sid_temp                   VARCHAR2(20);
3906:           v_temp                           VARCHAR2(4000);
3907:           v_current_address                T_OSI_PARTICIPANT_VERSION.current_address%TYPE;
3908:           v_current_name                   T_OSI_PARTICIPANT_VERSION.current_name%TYPE;
3909:           v_person_sid                     VARCHAR2(40);
3910:           v_obj_type                       T_CORE_OBJ_TYPE.SID%TYPE;
3911:           v_obj_desc                       VARCHAR2(200);
3912:           v_subtype_sid                    VARCHAR2(20);
3913:           v_subtype_desc                   VARCHAR2(200);
3914:   
3915:           FUNCTION handle_boolean(p_data IN NUMBER)
3916:               RETURN VARCHAR2 IS
3917:           BEGIN
3918:               IF (p_data IS NOT NULL) THEN
3919:                   IF (p_data = -1) THEN
3920:                       RETURN 'Y';
3921:                   ELSIF(p_data = 0) THEN
3922:                       RETURN 'N';
3923:                   ELSE
3924:                       --Probably do not need to account for this situation
3925:                       RETURN 'U';
3926:                   END IF;
3927:               ELSE
3928:                   RETURN 'U';
3929:               END IF;
3930:   
3931:               --If all else fails
3932:               RETURN 'U';
3933:           END handle_boolean;
3934:   
3935:           PROCEDURE mark_as_mig(
3936:               p_type      IN   VARCHAR2,
3937:               p_old_sid   IN   VARCHAR2,
3938:               p_new_sid   IN   VARCHAR2,
3939:               p_parent    IN   VARCHAR2) IS
3940:           BEGIN
3941:               v_migration_cnt_total := v_migration_cnt_total + 1;
3942:   
3943:               INSERT INTO T_OSI_MIGRATION
3944:                           (TYPE, old_sid, new_sid, date_time, num, PARENT)
3945:                    VALUES (p_type, p_old_sid, p_new_sid, SYSDATE, v_migration_cnt_total, p_parent);
3946:           EXCEPTION
3947:               WHEN OTHERS THEN
3948:                   RAISE;
3949:           END mark_as_mig;
3950:       BEGIN
3951:           ----------------------------
3952:           -- Get the object type reference row for this person version
3953:           ----------------------------
3954:           select sid, usage, description
3955:             into v_subtype_sid, v_obj_desc, v_subtype_desc 
3956:             from t_osi_reference  
3957:            where description = (select decode(pt.description,
3958:                                                  'Individual','Individual',
3959:                                                  'Program','Program',
3960:                                                   pt.sub_description) 
3961:                                   from ref_t_person p, ref_t_person_version pv, ref_t_person_type pt
3962:                                  where pv.sid = p_legacy_person_version
3963:                                    and pv.person = p.sid
3964:                                    and pt.code = p.type_code
3965:                                    and pt.sub_code = p.subtype_code);
3966:   
3967:           --Get object type SID
3968:           v_obj_type := Core_Obj.lookup_objtype(v_obj_desc);
3969:   
3970:           --Get the T_PERSON SID
3971:           SELECT person
3972:             INTO v_person_sid
3973:             FROM ref_v_person_version
3974:            WHERE SID = p_legacy_person_version;
3975:   
3976:           --T_PERSON_VERSION
3977:           FOR k IN (SELECT *
3978:                       FROM ref_t_person_version
3979:                      WHERE SID = p_legacy_person_version)
3980:           LOOP
3981:               --Participant Version Table - Insert
3982:               INSERT INTO T_OSI_PARTICIPANT_VERSION
3983:                           (participant, locked_on, locked_by)
3984:                    VALUES (p_new_person, k.locked_on, k.locked_by)
3985:                 RETURNING SID
3986:                      INTO v_new_sid_version;
3987:   
3988:            IF v_obj_desc = 'PART.INDIV' THEN
3989:               --Get PERSON_CHARS columns [BEGIN]
3990:               v_osi_person_chars_sex := Dibrs_Reference.lookup_ref_sid('SEX', UPPER(k.sex));
3991:               IF (k.eye_color IS NOT NULL) THEN
3992:                   begin
3993:                        SELECT SID INTO v_osi_person_chars_eye_color
3994:                          FROM T_OSI_REFERENCE
3995:                         WHERE USAGE = 'PERSON_EYE_COLOR' AND UPPER(description) = UPPER(k.eye_color);
3996:                   exception when others then
3997:   
3998:                            v_osi_person_chars_eye_color := NULL;
3999:                            
4000:                   end;
4001:               ELSE
4002:                   v_osi_person_chars_eye_color := NULL;
4003:               END IF;
4004:   
4005:               IF (k.hair_color IS NOT NULL) THEN
4006:                   begin
4007:                        SELECT SID INTO v_osi_person_chars_hair_color
4008:                          FROM T_OSI_REFERENCE
4009:                          WHERE USAGE = 'PERSON_HAIR_COLOR' AND UPPER(description) = UPPER(k.hair_color);
4010:                   exception when others then
4011:   
4012:                            v_osi_person_chars_hair_color := NULL;
4013:                            
4014:                   end;
4015:               ELSE
4016:                   v_osi_person_chars_hair_color := NULL;
4017:               END IF;
4018:   
4019:               v_osi_person_chars_blood_type :=
4020:                                        Osi_Reference.lookup_ref_sid('PERSON_BLOOD_TYPE', k.blood_type);
4021:               v_osi_person_chars_race := Dibrs_Reference.get_race_sid(k.race);
4022:               v_osi_person_chars_sa_pay_plan :=
4023:                                              Dibrs_Reference.lookup_ref_sid('PAY_PLAN', k.sa_pay_plan);
4024:               v_osi_person_chars_sa_pay_grad := Dibrs_Reference.get_pay_grade_sid(k.sa_pay_grade);
4025:               v_osi_person_chars_sa_pay_band := Dibrs_Reference.get_pay_band_sid(k.sa_pay_band);
4026:   
4027:               --Get PERSON_CHARS columns [END]
4028:   
4029:               --Person Chars Table - Insert
4030:               INSERT INTO T_OSI_PERSON_CHARS
4031:                           (SID,
4032:                            sex,
4033:                            eye_color,
4034:                            hair_color,
4035:                            blood_type,
4036:                            race,
4037:                            sa_pay_plan,
4038:                            sa_pay_grade,
4039:                            sa_pay_band,
4040:                            height,
4041:                            weight,
4042:                            education_level)
4043:                    VALUES (v_new_sid_version,
4044:                            v_osi_person_chars_sex,
4045:                            v_osi_person_chars_eye_color,
4046:                            v_osi_person_chars_hair_color,
4047:                            v_osi_person_chars_blood_type,
4048:                            v_osi_person_chars_race,
4049:                            v_osi_person_chars_sa_pay_plan,
4050:                            v_osi_person_chars_sa_pay_grad,
4051:                            v_osi_person_chars_sa_pay_band,
4052:                            k.height,
4053:                            k.weight,
4054:                            k.education_level);
4055:   
4056:               
4057:             
4058:               --Get PARTICIPANT_HUMAN columns [BEGIN]
4059:               IF (k.BUILD IS NOT NULL) THEN
4060:                   SELECT SID
4061:                     INTO v_osi_partic_human_build
4062:                     FROM T_OSI_REFERENCE
4063:                    WHERE USAGE = 'INDIV_BUILD' AND UPPER(description) = UPPER(k.BUILD);
4064:               ELSE
4065:                   v_osi_partic_human_build := NULL;
4066:               END IF;
4067:   
4068:               IF (k.posture IS NOT NULL) THEN
4069:                   SELECT SID
4070:                     INTO v_osi_partic_human_posture
4071:                     FROM T_OSI_REFERENCE
4072:                    WHERE USAGE = 'INDIV_POSTURE' AND UPPER(description) = UPPER(k.posture);
4073:               ELSE
4074:                   v_osi_partic_human_posture := NULL;
4075:               END IF;
4076:   
4077:               IF (k.writing_hand IS NOT NULL) THEN
4078:                   SELECT SID
4079:                     INTO v_osi_partic_human_writ_hand
4080:                     FROM T_OSI_REFERENCE
4081:                    WHERE USAGE = 'INDIV_HAND' AND UPPER(description) = UPPER(k.writing_hand);
4082:               ELSE
4083:                   v_osi_partic_human_writ_hand := NULL;
4084:               END IF;
4085:   
4086:               IF (k.religious_involvement IS NOT NULL) THEN
4087:                   SELECT SID
4088:                     INTO v_osi_partic_human_rel_inv
4089:                     FROM T_OSI_REFERENCE
4090:                    WHERE USAGE = 'INDIV_RELIGION_INVOLVEMENT'
4091:                      AND UPPER(description) = UPPER(k.religious_involvement);
4092:               ELSE
4093:                   v_osi_partic_human_rel_inv := NULL;
4094:               END IF;
4095:   
4096:               IF (k.clearance IS NOT NULL) THEN
4097:                   IF (k.clearance = 'CON') THEN
4098:                       v_osi_partic_human_clearance :=
4099:                                                  Osi_Reference.lookup_ref_sid('INDIV_CLEARANCE', 'C');
4100:                   ELSIF(k.clearance = 'SEC') THEN
4101:                       v_osi_partic_human_clearance :=
4102:                                                  Osi_Reference.lookup_ref_sid('INDIV_CLEARANCE', 'S');
4103:                   ELSE
4104:                       v_osi_partic_human_clearance :=
4105:                                          Osi_Reference.lookup_ref_sid('INDIV_CLEARANCE', k.clearance);
4106:                   END IF;
4107:               ELSE
4108:                   v_osi_partic_human_clearance := NULL;
4109:               END IF;
4110:   
4111:               v_osi_partic_human_sa_service :=
4112:                                             Osi_Reference.lookup_ref_sid('SERVICE_TYPE', k.sa_service);
4113:               v_osi_partic_human_sa_affil :=
4114:                                    Osi_Reference.lookup_ref_sid('INDIV_AFFILIATION', k.sa_affiliation);
4115:               v_osi_partic_human_sa_comp :=
4116:                                      Osi_Reference.lookup_ref_sid('SERVICE_COMPONENT', k.sa_component);
4117:               v_osi_partic_human_sa_res := handle_boolean(k.sa_reservist);
4118:               v_osi_partic_human_sa_res_stat :=
4119:                            Osi_Reference.lookup_ref_sid('INDIV_RESERVE_STATUS', k.sa_reservist_status);
4120:               v_osi_partic_human_sa_res_type :=
4121:                                Osi_Reference.lookup_ref_sid('INDIV_RESERVE_TYPE', k.sa_reservist_type);
4122:               v_osi_partic_human_fsa_service :=
4123:                                          Dibrs_Reference.lookup_ref_sid('SERVICE_TYPE', k.fsa_service);
4124:               v_osi_partic_human_sus_io := handle_boolean(k.suspected_io);
4125:               v_osi_partic_human_known_io := handle_boolean(k.known_io);
4126:               v_osi_partic_human_bald := handle_boolean(k.is_bald);
4127:               v_osi_partic_human_hard_hear := handle_boolean(k.is_hard_of_hearing);
4128:               v_osi_partic_human_facial_hair := handle_boolean(k.has_facial_hair);
4129:               v_osi_partic_human_wear_glass := handle_boolean(k.wears_glasses);
4130:               v_osi_partic_human_has_teeth := handle_boolean(k.has_teeth);
4131:   
4132:               --Get PARTICIPANT_HUMAN columns [END]
4133:               INSERT INTO T_OSI_PARTICIPANT_HUMAN
4134:                           (SID,
4135:                            age_low,
4136:                            age_high,
4137:                            BUILD,
4138:                            posture,
4139:                            writing_hand,
4140:                            religion,
4141:                            religion_involvement,
4142:                            clearance,
4143:                            sa_service,
4144:                            sa_affiliation,
4145:                            sa_component,
4146:                            sa_rank,
4147:                            sa_rank_date,
4148:                            sa_specialty_code,
4149:                            sa_reservist,
4150:                            sa_reservist_status,
4151:                            sa_reservist_type,
4152:                            fsa_service,
4153:                            fsa_rank,
4154:                            fsa_equiv_rank,
4155:                            fsa_rank_date,
4156:                            suspected_io,
4157:                            known_io,
4158:                            is_bald,
4159:                            bald_comment,
4160:                            is_hard_of_hearing,
4161:                            hearing_comment,
4162:                            has_facial_hair,
4163:                            facial_hair_comment,
4164:                            wears_glasses,
4165:                            glasses_comment,
4166:                            has_teeth,
4167:                            teeth_comment,
4168:                            deers_date)
4169:                    VALUES (v_new_sid_version,
4170:                            k.age_low,
4171:                            k.age_high,
4172:                            v_osi_partic_human_build,
4173:                            v_osi_partic_human_posture,
4174:                            v_osi_partic_human_writ_hand,
4175:                            k.religious_affiliation,
4176:                            v_osi_partic_human_rel_inv,
4177:                            v_osi_partic_human_clearance,
4178:                            v_osi_partic_human_sa_service,
4179:                            v_osi_partic_human_sa_affil,
4180:                            v_osi_partic_human_sa_comp,
4181:                            k.sa_rank,
4182:                            k.sa_rank_date,
4183:                            k.sa_specialty_code,
4184:                            v_osi_partic_human_sa_res,
4185:                            v_osi_partic_human_sa_res_stat,
4186:                            v_osi_partic_human_sa_res_type,
4187:                            v_osi_partic_human_fsa_service,
4188:                            k.fsa_rank,
4189:                            k.fsa_equiv_rank,
4190:                            k.fsa_rank_date,
4191:                            v_osi_partic_human_sus_io,
4192:                            v_osi_partic_human_known_io,
4193:                            v_osi_partic_human_bald,
4194:                            k.bald_comment,
4195:                            v_osi_partic_human_hard_hear,
4196:                            k.hard_of_hearing_comment,
4197:                            v_osi_partic_human_facial_hair,
4198:                            k.facial_hair_comment,
4199:                            v_osi_partic_human_wear_glass,
4200:                            k.glasses_comment,
4201:                            v_osi_partic_human_has_teeth,
4202:                            k.teeth_comment,
4203:                            k.deers_date);
4204:   
4205:            ELSE  ----------------------------
4206:                  -- GET PART.NONINDIV COLUMNS
4207:                  ----------------------------
4208:                  IF v_subtype_sid IS NOT NULL THEN
4209:                     v_osi_partic_nonh_sub_type := v_subtype_sid;
4210:                  END IF;
4211:                  IF k.co_cage IS NOT NULL THEN
4212:                     v_osi_partic_nonh_co_cage := k.co_cage;
4213:                  ELSE
4214:                     v_osi_partic_nonh_co_cage := null;
4215:                  END IF;
4216:                  IF k.co_duns IS NOT NULL THEN
4217:                     v_osi_partic_nonh_co_duns := k.co_duns;
4218:                  ELSE
4219:                     v_osi_partic_nonh_co_duns := null;
4220:                  END IF;
4221:                  IF k.org_uic IS NOT NULL THEN
4222:                     v_osi_partic_nonh_org_uic := k.org_uic;
4223:                  ELSE
4224:                     v_osi_partic_nonh_org_uic := null;
4225:                  END IF;
4226:                  IF k.org_majcom IS NOT NULL THEN
4227:                   SELECT SID
4228:                     INTO v_osi_partic_nonh_org_majcom
4229:                     FROM T_OSI_REFERENCE
4230:                    WHERE USAGE = 'MAJCOM' AND code = k.org_majcom;
4231:                  ELSE
4232:                       v_osi_partic_nonh_org_majcom := NULL;
4233:                  END IF;
4234:                  IF k.org_high_risk IS NOT NULL THEN
4235:                     IF k.org_high_risk &lt;&gt; 0 then
4236:                            v_osi_partic_nonh_org_highrisk := 'Y';
4237:                     ELSE
4238:                            v_osi_partic_nonh_org_highrisk := 'N';
4239:                     END IF;
4240:                  ELSE
4241:                     v_osi_partic_nonh_org_highrisk := 'U'; --unknown
4242:                  END IF;
4243:                  IF k.org_num_people IS NOT NULL THEN
4244:                     v_osi_partic_nonh_org_nopeople := k.org_num_people;
4245:                  ELSE
4246:                     v_osi_partic_nonh_org_nopeople := null;
4247:                  END IF;
4248:                  IF k.org_supporting_unit IS NOT NULL THEN
4249:                    SELECT NEW_SID
4250:                      INTO v_osi_partic_nonh_org_suppunit
4251:                      FROM T_OSI_MIGRATION
4252:                     WHERE OLD_SID = k.org_supporting_unit;
4253:                  ELSE
4254:                     v_osi_partic_nonh_org_suppunit := null;
4255:                  END IF;
4256:                  IF k.prog_description IS NOT NULL THEN
4257:                     v_osi_partic_nonh_prog_desc := k.prog_description;
4258:                  ELSE
4259:                     v_osi_partic_nonh_prog_desc := null;
4260:                  END IF;
4261:   
4262:                  INSERT INTO T_OSI_PARTICIPANT_NONHUMAN
4263:                              (SID,
4264:                               sub_type,
4265:                               co_cage,
4266:                               co_duns,
4267:                               org_uic,
4268:                               org_majcom,
4269:                               org_high_risk,
4270:                               org_num_people,
4271:                               org_supporting_unit,
4272:                               prog_description)
4273:                       VALUES (v_new_sid_version,
4274:                               v_osi_partic_nonh_sub_type,
4275:                               v_osi_partic_nonh_co_cage,
4276:                               v_osi_partic_nonh_co_duns,
4277:                               v_osi_partic_nonh_org_uic,
4278:                               v_osi_partic_nonh_org_majcom,
4279:                               v_osi_partic_nonh_org_highrisk,
4280:                               v_osi_partic_nonh_org_nopeople,
4281:                               v_osi_partic_nonh_org_suppunit,
4282:                               v_osi_partic_nonh_prog_desc);
4283:                           
4284:            END IF;
4285:   
4286:   
4287:           END LOOP;
4288:   
4289:           mark_as_mig('PARTICIPANT_VERSION', p_legacy_person_version, v_new_sid_version, p_new_person);
4290:   
4291:           --T_PERSON_CITIZENSHIP Table
4292:           FOR k IN (SELECT *
4293:                       FROM ref_t_person_citizenship
4294:                      WHERE person_version = p_legacy_person_version)
4295:           LOOP
4296:               INSERT INTO T_OSI_PARTIC_CITIZENSHIP
4297:                           (participant_version, country, effective_date)
4298:                    VALUES (v_new_sid_version,
4299:                            Dibrs_Reference.get_country_sid(k.country),
4300:                            k.effective_date)
4301:                 RETURNING SID
4302:                      INTO v_new_sid_temp;
4303:   
4304:               mark_as_mig('PARTICIPANT_CITIZENSHIP', k.SID, v_new_sid_temp, v_new_sid_version);
4305:           END LOOP;
4306:   
4307:           --T_PERSON_MARK
4308:           FOR k IN (SELECT *
4309:                       FROM ref_t_person_mark
4310:                      WHERE person_version = p_legacy_person_version)
4311:           LOOP
4312:               INSERT INTO T_OSI_PARTIC_MARK
4313:                           (participant_version, mark_type, mark_location, description)
4314:                    VALUES (v_new_sid_version,
4315:                            Dibrs_Reference.get_mark_type_sid(k.type_code),
4316:                            Dibrs_Reference.get_mark_location_type_sid(k.loc_code),
4317:                            k.description)
4318:                 RETURNING SID
4319:                      INTO v_new_sid_temp;
4320:   
4321:               mark_as_mig('PARTICIPANT_MARK', k.SID, v_new_sid_temp, v_new_sid_version);
4322:           END LOOP;
4323:   
4324:           --T_PERSON_NAME
4325:           FOR k IN (SELECT *
4326:                       FROM ref_t_person_name
4327:                      WHERE person_version = p_legacy_person_version)
4328:           LOOP
4329:               --Get Columns
4330:               IF (k.name_type IS NOT NULL) THEN
4331:                   BEGIN
4332:                       SELECT DESCRIPTION 
4333:                         INTO v_temp
4334:                         FROM ref_t_person_name_type
4335:                        WHERE code = k.name_type;
4336:                   EXCEPTION
4337:                           WHEN OTHERS THEN
4338:                               log_error('import_legacy_part_version: Error locating description for name_type: ' || k.name_type || ' ' || SQLERRM);
4339:                   END;
4340:   
4341:                   --Shouldn't need this try/catch, but have it in place for non-indiv folks
4342:                   BEGIN
4343:                       SELECT SID
4344:                         INTO v_osi_partic_name_name_type
4345:                         FROM T_OSI_PARTIC_NAME_TYPE
4346:                        WHERE UPPER(DESCRIPTION) = UPPER(v_temp);
4347:                   EXCEPTION
4348:                       WHEN OTHERS THEN
4349:                           DBMS_OUTPUT.PUT_LINE('Bad Type : [' || k.name_type || ']');
4350:                   END;
4351:               ELSE
4352:                   v_osi_partic_name_name_type := NULL;
4353:               END IF;
4354:   
4355:               INSERT INTO T_OSI_PARTIC_NAME
4356:                           (participant_version,
4357:                            name_type,
4358:                            title,
4359:                            last_name,
4360:                            first_name,
4361:                            middle_name,
4362:                            cadency)
4363:                    VALUES (v_new_sid_version,
4364:                            v_osi_partic_name_name_type,
4365:                            k.title,
4366:                            k.last_name,
4367:                            k.first_name,
4368:                            k.middle_name,
4369:                            k.cadency)
4370:                 RETURNING SID
4371:                      INTO v_new_sid_temp;
4372:   
4373:               mark_as_mig('PARTICIPANT_NAME', k.SID, v_new_sid_temp, v_new_sid_version);
4374:           END LOOP;
4375:   
4376:           --T_ADDRESS_V2
4377:           --Clear Current Address
4378:           v_current_address := NULL;
4379:   
4380:           FOR k IN (SELECT *
4381:                       FROM ref_t_address_v2
4382:                      WHERE PARENT = p_legacy_person_version
4383:                         OR PARENT = v_person_sid)
4384:           LOOP
4385:               CASE upper(k.addr_type)
4386:                   WHEN 'PERMANENT' THEN
4387:                       v_osi_address_address_type :=
4388:                                            Osi_Address.get_addr_type(v_obj_type, 'ADDR_LIST', 'PERM');
4389:                   WHEN 'EDUCATION' THEN
4390:                       v_osi_address_address_type :=
4391:                                              Osi_Address.get_addr_type(v_obj_type, 'ADDR_LIST', 'ED');
4392:                   WHEN 'EMPLOYMENT' THEN
4393:                       v_osi_address_address_type :=
4394:                                             Osi_Address.get_addr_type(v_obj_type, 'ADDR_LIST', 'EMP');
4395:                   WHEN 'MAIL' THEN
4396:                       v_osi_address_address_type :=
4397:                                            Osi_Address.get_addr_type(v_obj_type, 'ADDR_LIST', 'MAIL');
4398:                   WHEN 'OTHER' THEN
4399:                       v_osi_address_address_type :=
4400:                                             Osi_Address.get_addr_type(v_obj_type, 'ADDR_LIST', 'OTH');
4401:                   WHEN 'RESIDENCE' THEN
4402:                       v_osi_address_address_type :=
4403:                                             Osi_Address.get_addr_type(v_obj_type, 'ADDR_LIST', 'RES');
4404:                   WHEN 'TEMPORARY' THEN
4405:                       v_osi_address_address_type :=
4406:                                            Osi_Address.get_addr_type(v_obj_type, 'ADDR_LIST', 'TEMP');
4407:                   WHEN 'BIRTH' THEN
4408:                       v_osi_address_address_type :=
4409:                                               Osi_Address.get_addr_type(v_obj_type, 'BIRTH', 'BIRTH');
4410:               END CASE;
4411:   
4412:               --Create Address Record, Tied to PERSON
4413:               INSERT INTO T_OSI_ADDRESS
4414:                           (obj,
4415:                            address_type,
4416:                            address_1,
4417:                            address_2,
4418:                            city,
4419:                            province,
4420:                            state,
4421:                            postal_code,
4422:                            country,
4423:                            geo_coords,
4424:                            start_date,
4425:                            end_date,
4426:                            known_date,
4427:                            comments)
4428:                    VALUES (p_new_person,
4429:                            v_osi_address_address_type,
4430:                            k.addr_1,
4431:                            k.addr_2,
4432:                            k.addr_city,
4433:                            k.addr_province,
4434:                            Dibrs_Reference.get_state_sid(k.addr_state),
4435:                            k.addr_zip,
4436:                            Dibrs_Reference.get_country_sid(k.addr_country),
4437:                            k.geo_coords,
4438:                            k.start_date,
4439:                            k.end_date,
4440:                            k.known_date,
4441:                            k.comments)
4442:                 RETURNING SID
4443:                      INTO v_new_sid_temp;
4444:   
4445:               --Create Participant Address Record, Tied to PERSON_VERSION
4446:               IF (k.PARENT &lt;&gt; v_person_sid) THEN
4447:                   --Only need to tie the PERSON_VERSION (non birth) to the version
4448:                   INSERT INTO T_OSI_PARTIC_ADDRESS
4449:                               (participant_version, address)
4450:                        VALUES (v_new_sid_version, v_new_sid_temp)
4451:                     RETURNING SID
4452:                          INTO v_new_sid_temp;
4453:               END IF;
4454:   
4455:               mark_as_mig('PARTICIPANT_ADDRESS',
4456:                           k.SID,
4457:                           v_new_sid_temp,
4458:                           '~' || p_new_person || '~' || v_new_sid_version || '~');
4459:   
4460:               --Check for Current Address
4461:               IF (k.selected = -1 AND k.PARENT = p_legacy_person_version) THEN
4462:                   v_current_address := v_new_sid_temp;
4463:               END IF;
4464:           END LOOP;
4465:   
4466:           --Numbers
4467:           FOR k IN (SELECT *
4468:                       FROM ref_t_person_number
4469:                      WHERE person_version = p_legacy_person_version)
4470:           LOOP
4471:               v_temp := NULL;
4472:   
4473:               IF (k.num_type = 'OTHER') THEN
4474:                   v_temp := 'OID';
4475:               ELSE
4476:                   v_temp := k.num_type;
4477:               END IF;
4478:   
4479:               SELECT SID
4480:                 INTO v_osi_partic_number_num_type
4481:                 FROM T_OSI_PARTIC_NUMBER_TYPE
4482:                WHERE code = v_temp;
4483:   
4484:               INSERT INTO T_OSI_PARTIC_NUMBER
4485:                           (participant_version,
4486:                            num_type,
4487:                            num_value,
4488:                            issue_date,
4489:                            issue_country,
4490:                            issue_state,
4491:                            issue_province,
4492:                            expire_date,
4493:                            note)
4494:                    VALUES (v_new_sid_version,
4495:                            v_osi_partic_number_num_type,
4496:                            k.num_value,
4497:                            k.issue_date,
4498:                            Dibrs_Reference.get_country_sid(k.issue_country),
4499:                            Dibrs_Reference.get_state_sid(k.issue_state),
4500:                            k.issue_province,
4501:                            k.expire_date,
4502:                            k.note)
4503:                 RETURNING SID
4504:                      INTO v_new_sid_temp;
4505:   
4506:               mark_as_mig('PARTICIPANT_NUMBER', k.SID, v_new_sid_temp, v_new_sid_version);
4507:           END LOOP;
4508:   
4509:           --Contact Info
4510:           FOR k IN (SELECT *
4511:                       FROM ref_t_phone_email
4512:                      WHERE PARENT = p_legacy_person_version)
4513:           LOOP
4514:               IF (k.pe_category IS NOT NULL) THEN
4515:                   SELECT SID
4516:                     INTO v_osi_partic_contact_type
4517:                     FROM T_OSI_REFERENCE
4518:                    WHERE USAGE = 'CONTACT_TYPE' AND UPPER(description) = UPPER(k.pe_category);
4519:               --Need to UPPER() above because Legacy Val is DSN-Fax and Web Val is DSN-FAX
4520:               ELSE
4521:                   v_osi_partic_contact_type := NULL;
4522:               END IF;
4523:   
4524:               INSERT INTO T_OSI_PARTIC_CONTACT
4525:                           (participant_version, TYPE, VALUE)
4526:                    VALUES (v_new_sid_version, v_osi_partic_contact_type, k.pe_value)
4527:                 RETURNING SID
4528:                      INTO v_new_sid_temp;
4529:   
4530:               mark_as_mig('PARTICIPANT_CONTACT', k.SID, v_new_sid_temp, v_new_sid_version);
4531:           END LOOP;
4532:   
4533:           --T_PERSON_ORG_ATTR
4534:           FOR k IN (SELECT *
4535:                       FROM ref_t_person_org_attr
4536:                      WHERE person_version = p_legacy_person_version)
4537:           LOOP
4538:               IF (k.ATTRIBUTE IS NOT NULL) THEN
4539:                   SELECT SID
4540:                     INTO v_temp
4541:                     FROM T_OSI_PARTIC_ORG_ATTR_TYPE
4542:                    WHERE code = k.ATTRIBUTE;
4543:               ELSE
4544:                   v_temp := NULL;
4545:               END IF;
4546:   
4547:               INSERT INTO T_OSI_PARTIC_ORG_ATTR
4548:                           (participant_version, ATTRIBUTE, comments)
4549:                    VALUES (v_new_sid_version, v_temp, k.comments);
4550:   
4551:               mark_as_mig('PARTICIPANT_ORG_ATTR', k.SID, v_new_sid_temp, v_new_sid_version);
4552:           END LOOP;
4553:   
4554:           --T_PERSON_VEHICLE
4555:           FOR k IN (SELECT *
4556:                       FROM ref_t_person_vehicle
4557:                      WHERE person_version = p_legacy_person_version)
4558:           LOOP
4559:               --Get Body Type (From Description)
4560:               IF (k.body_type IS NOT NULL) THEN
4561:                   SELECT description
4562:                     INTO v_temp
4563:                     FROM wcc_ref_t_person_vehicle_bt
4564:                    WHERE SID = k.body_type;
4565:   
4566:                   BEGIN
4567:                       SELECT SID
4568:                         INTO v_osi_partic_vehicle_body_type
4569:                         FROM T_OSI_REFERENCE
4570:                        WHERE USAGE = 'VEHICLE_BODY' AND description = v_temp;
4571:                   EXCEPTION
4572:                       WHEN OTHERS THEN
4573:                           v_osi_partic_vehicle_body_type := NULL;
4574:                   END;
4575:               ELSE
4576:                   v_osi_partic_vehicle_body_type := NULL;
4577:               END IF;
4578:   
4579:               --Get Role (From Description)
4580:               IF (k.ROLE IS NOT NULL) THEN
4581:                   SELECT description
4582:                     INTO v_temp
4583:                     FROM wcc_ref_t_person_vehicle_roles
4584:                    WHERE SID = k.ROLE;
4585:   
4586:                   BEGIN
4587:                       SELECT SID
4588:                         INTO v_osi_partic_vehicle_role
4589:                         FROM T_OSI_REFERENCE
4590:                        WHERE USAGE = 'VEHICLE_ROLE' AND description = v_temp;
4591:                   EXCEPTION
4592:                       WHEN OTHERS THEN
4593:                           v_osi_partic_vehicle_role := NULL;
4594:                   END;
4595:               ELSE
4596:                   v_osi_partic_vehicle_role := NULL;
4597:               END IF;
4598:   
4599:               INSERT INTO T_OSI_PARTIC_VEHICLE
4600:                           (participant_version,
4601:                            plate_num,
4602:                            reg_exp_date,
4603:                            reg_country,
4604:                            reg_state,
4605:                            reg_province,
4606:                            title_owner,
4607:                            vin,
4608:                            make,
4609:                            MODEL,
4610:                            YEAR,
4611:                            color,
4612:                            body_type,
4613:                            gross_weight,
4614:                            num_axles,
4615:                            ROLE,
4616:                            comments)
4617:                    VALUES (v_new_sid_version,
4618:                            k.plate_num,
4619:                            k.reg_exp_date,
4620:                            Dibrs_Reference.get_country_sid(k.reg_country),
4621:                            Dibrs_Reference.get_state_sid(k.reg_state),
4622:                            k.reg_province,
4623:                            k.title_num,
4624:                            k.vin,
4625:                            k.vehicle_make,
4626:                            k.vehicle_model,
4627:                            k.vehicle_year,
4628:                            k.vehicle_color,
4629:                            v_osi_partic_vehicle_body_type,
4630:                            k.gross_weight,
4631:                            k.num_axles,
4632:                            v_osi_partic_vehicle_role,
4633:                            k.comments)
4634:                 RETURNING SID
4635:                      INTO v_new_sid_temp;
4636:   
4637:               mark_as_mig('PARTICIPANT_VEHICLE', k.SID, v_new_sid_temp, v_new_sid_version);
4638:           END LOOP;
4639:   
4640:           --T_DATE
4641:           FOR k IN (SELECT *
4642:                       FROM wcc_ref_t_date
4643:                      WHERE PARENT = p_legacy_person_version)
4644:           LOOP
4645:               --Get Date Type (From Description)
4646:               IF (k.date_type IS NOT NULL) THEN
4647:                   BEGIN
4648:                       SELECT SID
4649:                         INTO v_temp
4650:                         FROM T_OSI_REFERENCE
4651:                        WHERE USAGE = DECODE(v_obj_desc, 'PART.INDIV','INDIV_DATE','NON_INDIV_DATE') 
4652:                          AND description = k.date_type;
4653:                   EXCEPTION
4654:                       WHEN OTHERS THEN
4655:                           v_temp := NULL;
4656:                   END;
4657:               ELSE
4658:                   v_temp := NULL;
4659:               END IF;
4660:   
4661:               INSERT INTO T_OSI_PARTIC_DATE
4662:                           (participant_version, TYPE, VALUE, comments)
4663:                    VALUES (v_new_sid_version, v_temp, k.date_value, k.comments)
4664:                 RETURNING SID
4665:                      INTO v_new_sid_temp;
4666:   
4667:               mark_as_mig('PARTICIPANT_DATE', k.SID, v_new_sid_temp, v_new_sid_version);
4668:           END LOOP;
4669:   
4670:           --FINALIZATION STUFF
4671:   
4672:           --TODO, probably should a p_current to the function and only update when set to Y
4673:   
4674:           --Update Current Name and Current Address[BEGIN]
4675:           --v_current_name
4676:           v_current_name := NULL;
4677:   
4678:           FOR k IN (SELECT ind_curr_name
4679:                       FROM ref_t_person_version
4680:                      WHERE SID = p_legacy_person_version)
4681:           LOOP
4682:               v_current_name := k.ind_curr_name;
4683:           END LOOP;
4684:   
4685:           FOR k IN (SELECT new_sid
4686:                       FROM T_OSI_MIGRATION
4687:                      WHERE old_sid = v_current_name AND PARENT = v_new_sid_version)
4688:           LOOP
4689:               v_current_name := k.new_sid;
4690:           END LOOP;
4691:           
4692:           UPDATE T_OSI_PARTICIPANT_VERSION
4693:              SET current_name = v_current_name,
4694:                  current_address = v_current_address
4695:            WHERE SID = v_new_sid_version;
4696:       --Update Current Name and Current Address[END]
4697:       EXCEPTION
4698:           WHEN OTHERS THEN
4699:               log_error('osi_participant.import_legacy_part_version: ' || SQLERRM || ' ' || dbms_utility.format_error_backtrace || ' using legacy version: ' || p_legacy_person_version);
4700:               RAISE;
4701:       END import_legacy_part_version;
4702:   
4703:       FUNCTION import_legacy_participant(p_person_version IN VARCHAR2, p_import_relations IN VARCHAR2 := 'Y')
4704:           RETURN VARCHAR2 IS
4705:           v_temp                          VARCHAR2(4000);
4706:           v_temp2                         VARCHAR2(4000);
4707:           v_temp_clob                     CLOB;
4708:           v_person_sid                    VARCHAR2(40);
4709:           v_obj_type                      T_CORE_OBJ_TYPE.SID%TYPE;
4710:           v_new_sid                       T_CORE_OBJ.SID%TYPE;
4711:           v_new_sid_version               T_OSI_PARTICIPANT_VERSION.SID%TYPE;
4712:           v_new_sid_temp                  VARCHAR2(20);
4713:           v_migration_cnt_total           NUMBER                               := 0;
4714:           v_current_version_sid           VARCHAR2(20);
4715:           --T_OSI_PARTICIPANT Columns
4716:           v_osi_participant_ethnicity     T_OSI_PARTICIPANT.ethnicity%TYPE;
4717:           --T_OSI_NOTE Columns
4718:           v_osi_note_note_type            T_OSI_NOTE.note_type%TYPE;
4719:           v_osi_note_creating_personnel   T_OSI_NOTE.creating_personnel%TYPE;
4720:           v_result                        VARCHAR2(200);
4721:           v_obj_desc                      VARCHAR2(200);
4722:           v_create_by                     varchar2(100);
4723:           v_atch_seq                      NUMBER := 0;
4724:   
4725:           PROCEDURE mark_as_mig(
4726:               p_type      IN   VARCHAR2,
4727:               p_old_sid   IN   VARCHAR2,
4728:               p_new_sid   IN   VARCHAR2,
4729:               p_parent    IN   VARCHAR2,
4730:               p_imp_rel   IN   VARCHAR2 := NULL) IS
4731:           BEGIN
4732:               v_migration_cnt_total := v_migration_cnt_total + 1;
4733:   
4734:               INSERT INTO T_OSI_MIGRATION
4735:                           (TYPE, old_sid, new_sid, date_time, num, PARENT, imp_relations)
4736:                    VALUES (p_type, p_old_sid, p_new_sid, SYSDATE, v_migration_cnt_total, p_parent, p_imp_rel);
4737:           EXCEPTION
4738:               WHEN OTHERS THEN
4739:                   RAISE;
4740:           END mark_as_mig;
4741:   
4742:           FUNCTION get_part_rel_info(p_person IN VARCHAR2)
4743:               RETURN CLOB IS
4744:               v_file_begin   VARCHAR2(2000)
4745:                   := '{\rtf1\ansi\ansicpg1252\deff0\deflang1033{\fonttbl{\f0\fswiss\fcharset0 Arial;}} {\*\generator Msftedit 5.41.15.1515;}\viewkind4\uc1\pard\f0\fs20';
4746:               v_file_end     VARCHAR2(2000)  := '\par }';
4747:               v_return       CLOB;
4748:               v_temp1        <a name="diff" id="c1"><span class="HDDeleted">CLOB;--</span></a>VARCHAR2(20000);
4749:               v_cnt          NUMBER;
4750:           BEGIN
<a name="diff" id="c2"><span class="HDDeleted">4751:                if p_import_relations = 'N' then
4752:                
4753:                  return null;
4754:                  
4755:                end if;
4756:                
</span></a>4757:               --Start File
4758:               v_return := v_file_begin;
4759:               --*****Header
4760:               v_temp1 :=
4761:                   'Relational data for: ' || ref_person.current_name(p_person) || ' \par  As of: '
4762:                   || SYSDATE || ' \par\par ';
4763:               v_return := v_return || v_temp1;
4764:               v_temp1 := '';
4765:               --*****Associated Activities
4766:               v_temp1 := NULL;
4767:               v_cnt := 0;
4768:               v_temp1 := '\b ASSOCIATED ACTIVITIES \b0 \par \par ';
4769:   
4770:               FOR k IN (SELECT DISTINCT ID, title, subtype_desc, involvement_role, SID
4771:                                    FROM ref_v_person_act_inv
4772:                                   WHERE person = p_person)
4773:               LOOP
4774:                   --Do not need to check for WEB.SECURE as it does not exist in NIPR so will not exist anyway
4775:                   IF (    (ref_classification_pkg.has_hi(k.SID, 'ORCON') &lt;&gt; 'Y')
4776:                       AND (ref_classification_pkg.has_hi(k.SID, 'LIMDIS') &lt;&gt; 'Y')) THEN
4777:                       v_cnt := v_cnt + 1;
4778:                       v_temp1 :=
4779:                               v_temp1 || '\b ' || v_cnt || '.&gt; \b0 Activity ID: ' || k.ID || ' \par ';
4780:                       v_temp1 := v_temp1 || 'Activity Title: ' || k.title || ' \par ';
4781:                       v_temp1 := v_temp1 || 'Activity Type: ' || k.subtype_desc || ' \par ';
4782:                       v_temp1 :=
4783:                            v_temp1 || 'Activity Involvement Role: ' || k.involvement_role || ' \par ';
4784:                       v_temp1 := v_temp1 || ' \par ';
4785:                   END IF;
4786:               END LOOP;
4787:   
4788:               IF v_cnt = 0 THEN
4789:                   v_temp1 := v_temp1 || 'No Data Found \par ';
4790:               END IF;
4791:   
4792:               --Concatonate the activities
4793:               v_return := v_return || v_temp1 || ' \par ';
4794:               --Clear buffer(s)
4795:               v_temp1 := NULL;
4796:               v_cnt := 0;
4797:               v_temp1 := '\b ASSOCIATED FILES \b0 \par \par ';
4798:   
4799:               --*****Associated Files
4800:               FOR k IN (SELECT DISTINCT ID, title, type_desc, subtype_desc, involvement_role, SID
4801:                                    FROM ref_v_person_file_inv
4802:                                   WHERE person = p_person)
4803:               LOOP
4804:                   --Do not need to check for WEB.SECURE as it does not exist in NIPR so will not exist anyway
4805:                   IF (    (ref_classification_pkg.has_hi(k.SID, 'ORCON') &lt;&gt; 'Y')
4806:                       AND (ref_classification_pkg.has_hi(k.SID, 'LIMDIS') &lt;&gt; 'Y')) THEN
4807:                       v_cnt := v_cnt + 1;
4808:                       v_temp1 := v_temp1 || '\b ' || v_cnt || '.&gt; \b0 File ID: ' || k.ID || ' \par ';
4809:                       v_temp1 := v_temp1 || 'File Title: ' || k.title || ' \par ';
4810:                       v_temp1 := v_temp1 || 'File Type: ' || k.type_desc || ' \par ';
4811:                       v_temp1 := v_temp1 || 'File Sub Type: ' || k.subtype_desc || ' \par ';
4812:                       v_temp1 :=
4813:                                v_temp1 || 'File Involvement Role: ' || k.involvement_role || ' \par ';
4814:                       v_temp1 := v_temp1 || ' \par ';
4815:                   END IF;
4816:               END LOOP;
4817:   
4818:               IF v_cnt = 0 THEN
4819:                   v_temp1 := v_temp1 || 'No Data Found \par ';
4820:               END IF;
4821:   
4822:               --Concatonate the files
4823:               v_return := v_return || v_temp1 || ' \par ';
4824:               --Clear buffer(s)
4825:               v_temp1 := NULL;
4826:               v_cnt := 0;
4827:               v_temp1 := '\b RELATIONSHIPS \b0 \par \par ';
4828:   
4829:               --*****Relationships
4830:               FOR k IN (SELECT *
4831:                           FROM ref_v_person_relation
4832:                          WHERE this_person = p_person)
4833:               LOOP
4834:                   IF (    (NVL(k.mod2_value, 'xxx') NOT LIKE 'ORCON%')
4835:                       AND (NVL(k.mod2_value, 'xxx') NOT LIKE 'LIMDIS%')) THEN
4836:                       IF (k.rel_desc IS NOT NULL) THEN
4837:                           v_cnt := v_cnt + 1;
4838:                           v_temp1 := v_temp1 || '\b ' || v_cnt || '.&gt; \b0 ' || k.rel_desc || ' \par ';
4839:                           v_temp1 := v_temp1 || 'Participant: ' || k.that_name || ' \par ';
4840:   
4841:                           -- add specifics if any
4842:                           IF (k.rel_specifics IS NOT NULL) THEN
4843:                               v_temp1 := v_temp1 || 'Specifics: ' || k.rel_specifics || ' \par ';
4844:                           END IF;
4845:   
4846:                           -- add comments if any
4847:                           IF (k.comments IS NOT NULL) THEN
4848:                               v_temp1 := v_temp1 || 'Comments: ' || k.comments || ' \par ';
4849:                           END IF;
4850:   
4851:                           v_temp1 := v_temp1 || ' \par ';
4852:                       END IF;
4853:                   END IF;
4854:               END LOOP;
4855:   
4856:               IF v_cnt = 0 THEN
4857:                   v_temp1 := v_temp1 || 'No Data Found \par ';
4858:               END IF;
4859:   
4860:               --Concatonate the files
4861:               v_return := v_return || v_temp1 || ' \par ';
4862:               --Finish off file
4863:               v_return := v_return || v_file_end;
4864:               --Send home
4865:               RETURN v_return;
4866:           END get_part_rel_info;
4867:       BEGIN
4868:           ----------------------------
4869:           -- Get the object type reference row for this person version
4870:           ----------------------------
4871:           log_error('import_legacy_relationships: STATUS - fetching the object description for version: ' || p_person_version);
4872:           select usage
4873:             into v_obj_desc 
4874:             from t_osi_reference  
4875:            where usage like 'PART.%'
4876:              and description = (select decode(pt.description,
4877:                                                  'Individual','Individual',
4878:                                                  'Program','Program',
4879:                                                   pt.sub_description)                                 
4880:                                   from ref_t_person p, ref_t_person_version pv, ref_t_person_type pt
4881:                                  where pv.sid = p_person_version
4882:                                    and pv.person = p.sid
4883:                                    and pt.code = p.type_code
4884:                                    and pt.sub_code = p.subtype_code);
<a name="diff" id="c3"><span class="HDDeleted">4885:   
</span></a>4886:           --Get object type SID
4887:           v_obj_type := Core_Obj.lookup_objtype(v_obj_desc);
4888:   
4889:           --Get the T_PERSON SID
4890:           SELECT person
4891:             INTO v_person_sid
4892:             FROM ref_v_person_version
4893:            WHERE SID = p_person_version;
4894:   
4895:           --CORE_OBJ Record - Insert
4896:           INSERT INTO T_CORE_OBJ
4897:                       (obj_type)
4898:                VALUES (v_obj_type)
4899:             RETURNING SID
4900:                  INTO v_new_sid;
4901:   
4902:           --Main Participant Record
4903:           FOR k IN (SELECT *
4904:                       FROM ref_t_person
4905:                      WHERE SID = v_person_sid)
4906:           LOOP
4907:               --Get Ethnicity
4908:               v_osi_participant_ethnicity := Dibrs_Reference.lookup_ref_sid('ETHNICITY', k.ethnicity);
4909:   
4910:               --Main Part Record - Insert
4911:               INSERT INTO T_OSI_PARTICIPANT
4912:                           (SID,
4913:                            unknown_flag,
4914:                            confirm_on,
4915:                            confirm_by,
4916:                            dod_edi_pn_id,
4917:                            dob,
4918:                            dod,
4919:                            ethnicity,
4920:                            nationality,
4921:                            details_lock)
4922:                    VALUES (v_new_sid,
4923:                            'N',
4924:                            k.confirm_on,
4925:                            k.confirm_by,
4926:                            k.dod_edi_pn_id,
4927:                            k.birth_date,
4928:                            k.decease_date,
4929:                            v_osi_participant_ethnicity,
4930:                            k.nationality,
4931:                            k.lock_details)
4932:                 RETURNING SID
4933:                      INTO v_new_sid_temp;
4934:   
4935:               --Save off the Confirmed By field for use below
4936:               v_temp := k.confirm_by;
4937:               mark_as_mig('PARTICIPANT', k.SID, v_new_sid_temp, '', p_import_relations);
4938:           END LOOP;
4939:   
4940:           --Give the participant a starting status
4941:           Osi_Status.change_status_brute
4942:                                (v_new_sid,
4943:                                 Osi_Status.get_starting_status(Core_Obj.lookup_objtype(v_obj_desc)),
4944:                                 'Created');
4945:   
4946:           --If person is confirmed, need to change their status to show it
4947:           IF (v_temp IS NOT NULL) THEN
4948:               --Get status change
4949:               SELECT SID
4950:                 INTO v_temp
4951:                 FROM T_OSI_STATUS_CHANGE
4952:                WHERE obj_type = Core_Obj.lookup_objtype(v_obj_desc)
4953:                  AND from_status =
4954:                                  Osi_Status.get_starting_status(Core_Obj.lookup_objtype(v_obj_desc))
4955:                  AND UPPER(transition) = 'CONFIRM';
4956:   
4957:               Osi_Status.change_status(v_new_sid, v_temp);
4958:           END IF;
4959:   
4960:           --Notes
4961:           --Transfer the notes to the temp table
4962:           DELETE FROM T_OSI_MIGRATION_NOTES;
4963:   
4964:           INSERT INTO T_OSI_MIGRATION_NOTES
4965:               SELECT *
4966:                 FROM ref_t_note_v2
4967:                WHERE PARENT = v_person_sid;
4968:   
4969:           FOR k IN (SELECT *
4970:                       FROM T_OSI_MIGRATION_NOTES
4971:                      WHERE PARENT = v_person_sid)
4972:           LOOP
4973:               --Get Category
4974:               IF (k.CATEGORY IS NOT NULL) THEN
4975:                   BEGIN
4976:                       SELECT SID
4977:                         INTO v_osi_note_note_type
4978:                         FROM T_OSI_NOTE_TYPE
4979:                        WHERE obj_type = Core_Obj.lookup_objtype(v_obj_desc)
4980:                          AND USAGE = 'NOTELIST'
4981:                          AND UPPER(description) = UPPER(k.CATEGORY);
4982:                   EXCEPTION
4983:                       WHEN OTHERS THEN
4984:                           --If not type is not found, then use the 'Additional Info' note.
4985:                           v_osi_note_note_type :=
4986:                               Osi_Note.get_note_type(Core_Obj.lookup_objtype(v_obj_desc),
4987:                                                      'ADD_INFO');
4988:                   END;
4989:               ELSE
4990:                   --Category should never be null, but if it is, just use "Additional Info" note.
4991:                   v_osi_note_note_type :=
4992:                             Osi_Note.get_note_type(Core_Obj.lookup_objtype(v_obj_desc), 'ADD_INFO');
4993:               END IF;
4994:   
4995:               --Get Creating Personnel
4996:               IF (k.personnel IS NOT NULL) THEN
4997:                   BEGIN
4998:                       SELECT new_sid
4999:                         INTO v_osi_note_creating_personnel
5000:                         FROM T_OSI_MIGRATION
5001:                        WHERE TYPE = 'PERSONNEL' AND old_sid = k.personnel;
5002:                   EXCEPTION
5003:                       WHEN OTHERS THEN
5004:                           --If personnel is not found, then use the current personnel
5005:                           v_osi_note_creating_personnel := Core_Context.personnel_sid;
5006:                   END;
5007:               ELSE
5008:                   --Personnel should never be null, but if it is, use the current User.
5009:                   v_osi_note_creating_personnel := Core_Context.personnel_sid;
5010:               END IF;
5011:   
5012:               INSERT INTO T_OSI_NOTE
5013:                           (obj, note_type, note_text, creating_personnel, lock_mode)
5014:                    VALUES (v_new_sid,
5015:                            v_osi_note_note_type,
5016:                            k.note,
5017:                            v_osi_note_creating_personnel,
5018:                            k.lock_mode)
5019:                 RETURNING SID
5020:                      INTO v_new_sid_temp;
5021:   
5022:               mark_as_mig('PARTICIPANT_NOTE', k.SID, v_new_sid_temp, v_new_sid);
5023:           END LOOP;
5024:   
5025:           --Attachments / Images (Mugshots)
5026:           --Transfer the Attachments to the temp table
5027:           DELETE FROM T_OSI_MIGRATION_ATCH;
5028:   
5029:           INSERT INTO T_OSI_MIGRATION_ATCH
5030:               SELECT *
5031:                 FROM ref_t_attachment_v3
5032:                WHERE PARENT = v_person_sid
5033:             ORDER BY modify_on;
5034:   
5035:           FOR k IN (SELECT *
5036:                       FROM T_OSI_MIGRATION_ATCH
5037:                      WHERE PARENT = v_person_sid)
5038:           LOOP
5039:               --Get Creating Personnel
5040:               IF (k.attach_by IS NOT NULL) THEN
5041:                   BEGIN
5042:                       SELECT new_sid
5043:                         INTO v_temp
5044:                         FROM T_OSI_MIGRATION
5045:                        WHERE TYPE = 'PERSONNEL' AND old_sid = k.attach_by;
5046:                   EXCEPTION
5047:                       WHEN OTHERS THEN
5048:                           --If personnel is not found, then use the current personnel
5049:                           v_temp := Core_Context.personnel_sid;
5050:                   END;
5051:               ELSE
5052:                   --Personnel should never be null, but if it is, use the current User.
5053:                   v_temp := Core_Context.personnel_sid;
5054:               END IF;
5055:   
5056:               --Get Type
5057:               IF (k.USAGE = 'MUGSHOT') THEN
5058:                   v_temp2 :=
5059:                       Osi_Attachment.get_attachment_type_sid(Core_Obj.lookup_objtype(v_obj_desc),
5060:                                                              'MUG',
5061:                                                              'MUGSHOT');
5062:               ELSE
5063:                   v_temp2 := NULL;
5064:               END IF;
5065:   
5066:               --Transfer the Attachment to the temp table
5067:               DELETE FROM T_OSI_MIGRATION_ATCH;
5068:   
5069:               INSERT INTO T_OSI_MIGRATION_ATCH
5070:                   SELECT *
5071:                     FROM ref_t_attachment_v3
5072:                    WHERE SID = k.SID;
5073:   
5074:               FOR j IN (SELECT *
5075:                           FROM T_OSI_MIGRATION_ATCH
5076:                          WHERE SID = k.SID)
5077:               LOOP
5078:                   --Update the attachment sequence for mugshots only
5079:                   IF v_temp2 is not null then
5080:                       v_atch_seq := v_atch_seq + 1;
5081:                   END IF;
5082:   
5083:                   --Note: Do not need Attachment Type
5084:                   INSERT INTO T_OSI_ATTACHMENT
5085:                               (obj,
5086:                                TYPE,
5087:                                content,
5088:                                storage_loc_type,
5089:                                description,
5090:                                SOURCE,
5091:                                mime_type,
5092:                                creating_personnel,
5093:                                lock_mode,
5094:                                date_modified,
5095:                                seq)
5096:                        VALUES (v_new_sid,
5097:                                v_temp2,
5098:                                j.blob_content,
5099:                                j.attach_location,
5100:                                j.description,
5101:                                j.source_location,
5102:                                NULL,
5103:                                v_temp,
5104:                                j.LOCKED,
5105:                                j.content_date,
5106:                                decode(v_temp2,NULL,NULL,v_atch_seq))
5107:                     RETURNING SID
5108:                          INTO v_new_sid_temp;
5109:   
5110:                     begin
5111:                          select osi_personnel.get_name(v_temp) into v_create_by from dual;
5112:   
5113:                     exception when others then
5114:                          
5115:                              v_create_by := core_context.personnel_name;
5116:                          
5117:                     end;             
5118:                     --- To keep the Original Create On/By from Legacy, mainly for DEERS ---     
5119:                     update t_osi_attachment set create_by=v_create_by, create_on=j.attach_date where sid=v_new_sid_temp;
5120:   
5121:               END LOOP;
5122:   
5123:               mark_as_mig('PARTICIPANT_ATCH', k.SID, v_new_sid_temp, v_new_sid);
5124:           END LOOP;
5125:   
<a name="diff" id="c4"><span class="HDDeleted">5126:   
</span></a>5127:           --Person Detail Report
5128:           --ref_obj_doc_web.make_doc_per(v_person_sid, v_temp_clob, null);
5129:           v_temp_clob := get_part_rel_info(v_person_sid);
5130:           
<a name="diff" id="c5"><span class="HDDeleted">5131:           if v_temp_clob is not null then
5132:   
</span></a>5133:             INSERT INTO T_OSI_ATTACHMENT
5134:                         (obj,
5135:                          content,
5136:                          storage_loc_type,
5137:                          description,
5138:                          SOURCE,
5139:                          mime_type,
5140:                          creating_personnel)
5141:                  VALUES (v_new_sid,
5142:                          Hex_Funcs.clob_to_blob(v_temp_clob),
5143:                          'DB',
5144:                          'Participant Detail Report - Imported Participant',
5145:                          'DetailReport.rtf',
5146:                          'application/msword',
5147:                          Core_Context.personnel_sid)
5148:               RETURNING SID
5149:                    INTO v_new_sid_temp;
5150:           
<a name="diff" id="c6"><span class="HDDeleted">5151:           end if;
5152:           
</span></a>5153:           mark_as_mig('PARTICIPANT_DOC_DETAIL', p_person_version, v_new_sid_temp, v_new_sid);
5154:   
5155:           --Import Versions
5156:           FOR k IN (SELECT   SID
5157:                         FROM ref_t_person_version
5158:                        WHERE person = v_person_sid
5159:                     ORDER BY SID)
5160:           LOOP
5161:               import_legacy_part_version(k.SID, v_new_sid);
5162:           END LOOP;
5163:   
5164:           --Get the current version
5165:           FOR k IN (SELECT SID
5166:                       FROM ref_t_person_version
5167:                      WHERE person = v_person_sid AND current_flag = 1)
5168:           LOOP
5169:               SELECT new_sid
5170:                 INTO v_current_version_sid
5171:                 FROM T_OSI_MIGRATION
5172:                WHERE old_sid = k.SID AND TYPE = 'PARTICIPANT_VERSION';
5173:           END LOOP;
5174:   
5175:           --Update the Current Version
5176:           UPDATE T_OSI_PARTICIPANT
5177:              SET current_version = v_current_version_sid
5178:            WHERE SID = v_new_sid;
5179:   
5180:           ----------------------------
5181:           --Import Relationships
5182:           ----------------------------
5183:           IF p_import_relations = 'Y' THEN
5184:               v_result := import_legacy_relationships(v_new_sid, v_person_sid);
5185:           
5186:               IF (v_result &lt;&gt; 'Y' and v_result not like 'Search complete.%') THEN
5187:                   log_error('import_legacy_participant: ' || v_result);
5188:                   ROLLBACK;
5189:                   RETURN v_result;
5190:               END IF;
5191:           END IF;
5192:   
5193:           --Legacy:
5194:           --T_PERSON [Complete]
5195:           --T_PERSON_VERSION [Completish - See Notes]
5196:           --T_PERSON_CITIZENSHIP [Complete]
5197:           --T_PERSON_INVOLVEMENT_V2 (Not needed, will be generating the Part Detail Rpt.)
5198:           --T_PERSON_MARK [Complete]
5199:           --T_PERSON_NAME [Complete]
5200:           --T_PERSON_NUMBER [Complete]
5201:           --T_PERSON_ORG_ATTR [Complete]
5202:           --T_PERSON_RELATION (Not needed, will be generating the Part Detail Rpt.)
5203:           --T_PERSON_VEHICLE [Complete]
5204:           --T_ADDRESS_V2 [Complete]
5205:           --T_PHONE_EMAIL [Complete]
5206:           --T_DATE [Complete]
5207:           --Attach: Person Detail Report
5208:           --Images [Complete]
5209:           --Notes [Complete]
5210:           --Attachments [Complete]
5211:           --No associations [Complete]
5212:           --No relationships [Complete]
5213:   
5214:           --Web:
5215:           --T_CORE_OBJ [Complete]
5216:           --T_OSI_PARTICIPANT [Complete]
5217:           --T_OSI_PARTICIPANT_VERSION (Need CURRENT_ADDRESS, CURRENT_NAME)
5218:           --T_OSI_PARTICIPANT_HUMAN [Complete]
5219:           --T_OSI_PERSON_CHARS [Complete]
5220:           --T_OSI_PARTIC_ADDRESS [Complete]
5221:           --T_OSI_PARTIC_CITIZENSHIP [Complete]
5222:           --T_OSI_PARTIC_CONTACT [Complete]
5223:           --T_OSI_PARTIC_DATE [Complete]
5224:           --T_OSI_PARTIC_NAME [Complete]
5225:           --T_OSI_PARTIC_NUMBER [Complete]
5226:           --T_OSI_PARTIC_ORG_ATTR [Complete]
5227:           --T_OSI_PARTIC_VEHICLE [Complete]
5228:           RETURN v_new_sid;
5229:       END import_legacy_participant;
5230:   
5231:       FUNCTION get_legacy_part_names(p_person_version IN VARCHAR2)
5232:           RETURN VARCHAR2 IS
5233:           v_legal_names    VARCHAR2(4000) := NULL;
5234:           v_alias_names    VARCHAR2(4000) := NULL;
5235:           v_maiden_names   VARCHAR2(4000) := NULL;
5236:           v_temp           VARCHAR2(4000);
5237:       BEGIN
5238:           FOR k IN (SELECT name_type, last_name, first_name, middle_name
5239:                       FROM ref_t_person_name
5240:                      WHERE person_version = p_person_version AND name_type IN('L', 'A', 'M'))
5241:           LOOP
5242:               v_temp := '';
5243:   
5244:               IF (k.last_name IS NOT NULL) THEN
5245:                   v_temp := v_temp || k.last_name || ', ';
5246:               END IF;
5247:   
5248:               IF (k.first_name IS NOT NULL) THEN
5249:                   v_temp := v_temp || k.first_name || ', ';
5250:               END IF;
5251:   
5252:               IF (k.middle_name IS NOT NULL) THEN
5253:                   v_temp := v_temp || k.middle_name || ', ';
5254:               END IF;
5255:   
5256:               v_temp := RTRIM(v_temp, ', ');
5257:   
5258:               CASE UPPER(k.name_type)
5259:                   WHEN 'L' THEN
5260:                       v_legal_names := v_temp || ' (Legal) ';
5261:                   WHEN 'M' THEN
5262:                       v_maiden_names := v_temp || ' (Maiden) ';
5263:                   WHEN 'A' THEN
5264:                       v_alias_names := v_temp || ' (AKA) ';
5265:               END CASE;
5266:           END LOOP;
5267:   
5268:           RETURN v_legal_names || v_maiden_names || v_alias_names;
5269:       END get_legacy_part_names;
5270:   
5271:       FUNCTION get_legacy_part_details(
5272:           p_person_version   IN   VARCHAR2,
5273:           p_omit_sa          IN   VARCHAR2 := NULL,
5274:           p_for_confirm      IN   VARCHAR2 := NULL)
5275:           RETURN VARCHAR2 IS
5276:           v_rtn       VARCHAR2(4000);
5277:           v_objtype   VARCHAR2(40);                                       --t_core_obj_type.sid%type;
5278:   
5279:           FUNCTION row_start
5280:               RETURN VARCHAR2 IS
5281:           BEGIN
5282:               RETURN '&lt;TR&gt;';
5283:           END row_start;
5284:   
5285:           FUNCTION row_end
5286:               RETURN VARCHAR2 IS
5287:           BEGIN
5288:               RETURN '&lt;/TR&gt;';
5289:           END row_end;
5290:   
5291:           FUNCTION new_row(p_text IN VARCHAR2)
5292:               RETURN VARCHAR2 IS
5293:           BEGIN
5294:               RETURN row_start || p_text || row_end;
5295:           END new_row;
5296:   
5297:           FUNCTION cell_start(p_col_span IN INTEGER := 0, p_row_span IN INTEGER := 0)
5298:               RETURN VARCHAR2 IS
5299:               v_rtn   VARCHAR2(500) := '&lt;TD vAlign="top" ';
5300:           BEGIN
5301:               IF (p_col_span &gt; 0) THEN
5302:                   v_rtn := v_rtn || 'colSpan="' || p_col_span || '" ';
5303:               END IF;
5304:   
5305:               IF (p_row_span &gt; 0) THEN
5306:                   v_rtn := v_rtn || 'rowSpan="' || p_row_span || '" ';
5307:               END IF;
5308:   
5309:               RETURN v_rtn || '&gt;';
5310:           END cell_start;
5311:   
5312:           FUNCTION cell_end
5313:               RETURN VARCHAR2 IS
5314:           BEGIN
5315:               RETURN '&lt;/TD&gt;';
5316:           END cell_end;
5317:   
5318:           FUNCTION new_cell(p_text IN VARCHAR2, p_col_span IN INTEGER := 0, p_row_span IN INTEGER := 0)
5319:               RETURN VARCHAR2 IS
5320:           BEGIN
5321:               RETURN cell_start(p_col_span, p_row_span) || p_text || cell_end;
5322:           END new_cell;
5323:   
5324:           FUNCTION make_label(p_text IN VARCHAR2)
5325:               RETURN VARCHAR2 IS
5326:           BEGIN
5327:               RETURN '&lt;LABEL class="optionallabel"&gt;&lt;SPAN&gt;' || p_text || '&lt;/SPAN&gt;&lt;/LABEL&gt;';
5328:           END make_label;
5329:   
5330:           FUNCTION get_indiv_details(p_person_version IN VARCHAR2)
5331:               RETURN VARCHAR2 IS
5332:               v_name                    VARCHAR2(200);
5333:               v_sex                     VARCHAR2(200);
5334:               v_service                 VARCHAR2(200);
5335:               v_address                 VARCHAR2(200);
5336:               v_dob                     DATE;
5337:               v_affiliation             VARCHAR2(200);
5338:               v_race                    VARCHAR2(200);
5339:               v_component               VARCHAR2(200);
5340:               v_ssn                     VARCHAR2(200);
5341:               v_pay_plan                VARCHAR2(200);
5342:               v_confirmed               VARCHAR2(200);
5343:               v_pay_grade               VARCHAR2(200);
5344:               v_rank                    VARCHAR2(200);
5345:               v_rank_date               DATE;
5346:               v_specialty_code          VARCHAR2(200);
5347:               v_military_organization   VARCHAR2(200);
5348:               v_format                  VARCHAR2(11);
5349:           BEGIN
5350:               IF (p_person_version IS NOT NULL) THEN
5351:                   SELECT ref_person.current_name(vpv.SID), sex, vpv.sa_service_desc "SA_SERVICE",
5352:                          ref_person.address(vpv.SID, 'CURRENT') AS "ADDRESS", vpv.birth_date,
5353:                          oaffiliation.description AS "SA_AFFILIATION", vpv.race_desc,
5354:                          dcomponent.description AS "SA_COMPONENT",
5355:                          ref_person.latest_number(vpv.SID, 'SSN') AS "SSN",
5356:                          dpay_plan.description AS "SA_PAYPLAN",
5357:                          (SELECT DECODE(confirm_by, NULL, 'Not Confirmed', 'Confirmed')
5358:                             FROM ref_t_person
5359:                            WHERE SID = vpv.person) AS "CONFIRMED",
5360:                          dpay_grade.description AS "SA_PAY_GRADE", vpv.sa_rank AS "SA_RANK",
5361:                          vpv.sa_rank_date AS "SA_RANK_DATE",
5362:                          vpv.sa_specialty_code AS "SA_SPECIALTY_CODE",
5363:                          ref_person.get_org_info(vpv.SID) AS "MILITARY_ORG"
5364:                     INTO v_name, v_sex, v_service,
5365:                          v_address, v_dob,
5366:                          v_affiliation, v_race,
5367:                          v_component,
5368:                          v_ssn,
5369:                          v_pay_plan,
5370:                          v_confirmed,
5371:                          v_pay_grade, v_rank,
5372:                          v_rank_date,
5373:                          v_specialty_code,
5374:                          v_military_organization
5375:                     FROM ref_v_person_version vpv,
5376:                          T_OSI_REFERENCE oaffiliation,
5377:                          T_DIBRS_REFERENCE dcomponent,
5378:                          T_DIBRS_REFERENCE dpay_plan,
5379:                          T_DIBRS_PAY_GRADE_TYPE dpay_grade
5380:                    WHERE (oaffiliation.code(+) = vpv.sa_affiliation AND oaffiliation.USAGE(+) =
5381:                                                                                    'INDIV_AFFILIATION')
5382:                      AND (dcomponent.code(+) = vpv.sa_component AND dcomponent.USAGE(+) =
5383:                                                                                    'SERVICE_COMPONENT')
5384:                      AND (dpay_plan.code(+) = vpv.sa_pay_plan AND dpay_plan.USAGE(+) = 'PAY_PLAN')
5385:                      AND (dpay_grade.code(+) = vpv.sa_pay_grade)
5386:                      AND vpv.SID = p_person_version;
5387:   
5388:                   v_format := Core_Util.get_config('CORE.DATE_FMT_DAY');
5389:               END IF;
5390:   
5391:               v_rtn := '&lt;TABLE class="formlayout" width="100%" border="0"&gt;&lt;TBODY&gt;';
5392:               v_rtn := v_rtn || '&lt;colgroup span="3" align="left" width="33%"&gt;&lt;/colgroup&gt;';
5393:               v_rtn := v_rtn || row_start || new_cell('Name: ' || v_name);
5394:               v_rtn := v_rtn || new_cell('Sex: ' || v_sex);
5395:   
5396:               IF (p_omit_sa IS NULL) THEN
5397:                   v_rtn := v_rtn || new_cell('Service: ' || v_service);
5398:               END IF;
5399:   
5400:               v_rtn := v_rtn || row_end;
5401:               v_rtn := v_rtn || row_start || new_cell('Address:&lt;br&gt;' || v_address, 0, 8);
5402:               v_rtn := v_rtn || new_cell('Date of Birth: ' || TO_CHAR(v_dob, v_format));
5403:   
5404:               IF (p_omit_sa IS NULL) THEN
5405:                   v_rtn := v_rtn || new_cell('Affiliation: ' || v_affiliation);
5406:               END IF;
5407:   
5408:               v_rtn := v_rtn || row_end;
5409:               v_rtn := v_rtn || row_start || new_cell('Race: ' || v_race);
5410:   
5411:               IF (p_omit_sa IS NULL) THEN
5412:                   v_rtn := v_rtn || new_cell('Component: ' || v_component);
5413:               END IF;
5414:   
5415:               v_rtn := v_rtn || row_end;
5416:               v_rtn := v_rtn || row_start || new_cell('SSN: ' || v_ssn);
5417:   
5418:               IF (p_omit_sa IS NULL) THEN
5419:                   v_rtn := v_rtn || new_cell('Pay Plan: ' || v_pay_plan);
5420:               END IF;
5421:   
5422:               v_rtn := v_rtn || row_end;
5423:               v_rtn := v_rtn || row_start || new_cell('Confirmed: ' || v_confirmed);
5424:   
5425:               IF (p_omit_sa IS NULL) THEN
5426:                   v_rtn := v_rtn || new_cell('Pay Grade: ' || v_pay_grade);
5427:                   v_rtn := v_rtn || row_end;
5428:                   v_rtn := v_rtn || row_start || new_cell('');
5429:                   v_rtn := v_rtn || new_cell('Rank: ' || v_rank);
5430:                   v_rtn := v_rtn || row_end;
5431:                   v_rtn := v_rtn || row_start || new_cell('');
5432:                   v_rtn := v_rtn || new_cell('Rank Date: ' || TO_CHAR(v_rank_date, v_format));
5433:                   v_rtn := v_rtn || row_end;
5434:                   v_rtn := v_rtn || row_start || new_cell('');
5435:                   v_rtn := v_rtn || new_cell('Specialty: ' || v_specialty_code);
5436:                   v_rtn := v_rtn || row_end;
5437:                   v_rtn := v_rtn || row_start || new_cell('');
5438:                   v_rtn := v_rtn || new_cell('Military Organization: ' || v_military_organization);
5439:               END IF;
5440:   
5441:               v_rtn := v_rtn || row_end || '&lt;/TBODY&gt;&lt;/TABLE&gt;';
5442:               RETURN v_rtn;
5443:           END get_indiv_details;
5444:       BEGIN
5445:           RETURN get_indiv_details(p_person_version);
5446:       EXCEPTION
5447:           WHEN OTHERS THEN
5448:               log_error('get_legacy_part_details: ' || SQLERRM);
5449:               RETURN 'get_legacy_part_details: ' || SQLERRM;
5450:       END get_legacy_part_details;
5451:   
5452:       FUNCTION get_part_rel_info(p_person IN VARCHAR2)
5453:           RETURN CLOB IS
5454:           v_file_begin   VARCHAR2(2000)
5455:               := '{\rtf1\ansi\ansicpg1252\deff0\deflang1033{\fonttbl{\f0\fswiss\fcharset0 Arial;}} {\*\generator Msftedit 5.41.15.1515;}\viewkind4\uc1\pard\f0\fs20';
5456:           v_file_end     VARCHAR2(2000)  := '\par }';
5457:           v_return       CLOB;
5458:           v_temp1        VARCHAR2(20000);
5459:           --v_temp2 varchar2(20000);
5460:           --v_temp3 varchar2(32000);
5461:           v_cnt          NUMBER;
5462:       BEGIN
5463:           --Start File
5464:           v_return := v_file_begin;
5465:           --*****Header
5466:           v_temp1 :=
5467:               'Relational data for: ' || ref_person.current_name(p_person) || ' \par  As of: '
5468:               || SYSDATE || ' \par\par ';
5469:           v_return := v_return || v_temp1;
5470:           v_temp1 := '';
5471:           --*****Associated Activities
5472:           v_temp1 := NULL;
5473:           v_cnt := 0;
5474:           v_temp1 := '\b ASSOCIATED ACTIVITIES \b0 \par \par ';
5475:   
5476:           FOR k IN (SELECT DISTINCT ID, title, subtype_desc, involvement_role, SID
5477:                                FROM ref_v_person_act_inv
5478:                               WHERE person = p_person)
5479:           LOOP
5480:               --Do not need to check for WEB.SECURE as it does not exist in NIPR so will not exist anyway
5481:               IF (    (ref_classification_pkg.has_hi(k.SID, 'ORCON') &lt;&gt; 'Y')
5482:                   AND (ref_classification_pkg.has_hi(k.SID, 'LIMDIS') &lt;&gt; 'Y')) THEN
5483:                   v_cnt := v_cnt + 1;
5484:                   v_temp1 := v_temp1 || '\b ' || v_cnt || '.&gt; \b0 Activity ID: ' || k.ID || ' \par ';
5485:                   v_temp1 := v_temp1 || 'Activity Title: ' || k.title || ' \par ';
5486:                   v_temp1 := v_temp1 || 'Activity Type: ' || k.subtype_desc || ' \par ';
5487:                   v_temp1 :=
5488:                            v_temp1 || 'Activity Involvement Role: ' || k.involvement_role || ' \par ';
5489:                   v_temp1 := v_temp1 || ' \par ';
5490:               END IF;
5491:           END LOOP;
5492:   
5493:           IF v_cnt = 0 THEN
5494:               v_temp1 := v_temp1 || 'No Data Found \par ';
5495:           END IF;
5496:   
5497:           --Concatonate the activities
5498:           v_return := v_return || v_temp1 || ' \par ';
5499:           --Clear buffer(s)
5500:           v_temp1 := NULL;
5501:           v_cnt := 0;
5502:           v_temp1 := '\b ASSOCIATED FILES \b0 \par \par ';
5503:   
5504:           --*****Associated Files
5505:           FOR k IN (SELECT DISTINCT ID, title, type_desc, subtype_desc, involvement_role, SID
5506:                                FROM ref_v_person_file_inv
5507:                               WHERE person = p_person)
5508:           LOOP
5509:               --Do not need to check for WEB.SECURE as it does not exist in NIPR so will not exist anyway
5510:               IF (    (ref_classification_pkg.has_hi(k.SID, 'ORCON') &lt;&gt; 'Y')
5511:                   AND (ref_classification_pkg.has_hi(k.SID, 'LIMDIS') &lt;&gt; 'Y')) THEN
5512:                   v_cnt := v_cnt + 1;
5513:                   v_temp1 := v_temp1 || '\b ' || v_cnt || '.&gt; \b0 File ID: ' || k.ID || ' \par ';
5514:                   v_temp1 := v_temp1 || 'File Title: ' || k.title || ' \par ';
5515:                   v_temp1 := v_temp1 || 'File Type: ' || k.type_desc || ' \par ';
5516:                   v_temp1 := v_temp1 || 'File Sub Type: ' || k.subtype_desc || ' \par ';
5517:                   v_temp1 := v_temp1 || 'File Involvement Role: ' || k.involvement_role || ' \par ';
5518:                   v_temp1 := v_temp1 || ' \par ';
5519:               END IF;
5520:           END LOOP;
5521:   
5522:           IF v_cnt = 0 THEN
5523:               v_temp1 := v_temp1 || 'No Data Found \par ';
5524:           END IF;
5525:   
5526:           --Concatonate the files
5527:           v_return := v_return || v_temp1 || ' \par ';
5528:           --Clear buffer(s)
5529:           v_temp1 := NULL;
5530:           v_cnt := 0;
5531:           v_temp1 := '\b RELATIONSHIPS \b0 \par \par ';
5532:   
5533:           --*****Relationships
5534:           FOR k IN (SELECT *
5535:                       FROM ref_v_person_relation
5536:                      WHERE this_person = p_person)
5537:           LOOP
5538:               IF (    (NVL(k.mod2_value, 'xxx') NOT LIKE 'ORCON%')
5539:                   AND (NVL(k.mod2_value, 'xxx') NOT LIKE 'LIMDIS%')) THEN
5540:                   IF (k.rel_desc IS NOT NULL) THEN
5541:                       v_cnt := v_cnt + 1;
5542:                       v_temp1 := v_temp1 || '\b ' || v_cnt || '.&gt; \b0 ' || k.rel_desc || ' \par ';
5543:                       v_temp1 := v_temp1 || 'Participant: ' || k.that_name || ' \par ';
5544:   
5545:                       -- add specifics if any
5546:                       IF (k.rel_specifics IS NOT NULL) THEN
5547:                           v_temp1 := v_temp1 || 'Specifics: ' || k.rel_specifics || ' \par ';
5548:                       END IF;
5549:   
5550:                       -- add comments if any
5551:                       IF (k.comments IS NOT NULL) THEN
5552:                           v_temp1 := v_temp1 || 'Comments: ' || k.comments || ' \par ';
5553:                       END IF;
5554:   
5555:                       v_temp1 := v_temp1 || ' \par ';
5556:                   END IF;
5557:               END IF;
5558:           END LOOP;
5559:   
5560:           IF v_cnt = 0 THEN
5561:               v_temp1 := v_temp1 || 'No Data Found \par ';
5562:           END IF;
5563:   
5564:           --Concatonate the files
5565:           v_return := v_return || v_temp1 || ' \par ';
5566:           --Clear buffer(s)
5567:           --v_temp1 := null; [Do Not Need]
5568:           --v_cnt := 0;      [Do Not Need]
5569:   
5570:           --Finish off file
5571:           v_return := v_return || v_file_end;
5572:           --Send home
5573:           RETURN v_return;
5574:       END get_part_rel_info;
5575:   
5576:        ----------------------
5577:        --Used to import legacy relationships
5578:        ----------------------
5579:        FUNCTION import_legacy_relationships(p_new_person IN VARCHAR2, p_i2ms_person IN VARCHAR2 := NULL) 
5580:               RETURN VARCHAR2 IS
5581:        
5582:        v_source_person       VARCHAR2(20);
5583:        v_rel_person          VARCHAR2(20);
5584:        v_rel_perver          VARCHAR2(20);
5585:        v_new_source_person   VARCHAR2(20);
5586:        v_new_rel_person      VARCHAR2(20);
5587:        v_partic_a            VARCHAR2(20);
5588:        v_partic_b            VARCHAR2(20);
5589:        v_rel_type            VARCHAR2(20);
5590:        v_start_date            DATE;
5591:        v_end_date            DATE;
5592:        v_known_date            DATE;
5593:        v_mod1_value            VARCHAR2(200);
5594:        v_mod2_value            VARCHAR2(200);
5595:        v_mod3_value            VARCHAR2(200);
5596:        v_comments            VARCHAR2(1000);
5597:        v_new_rel_sid         VARCHAR2(20);
5598:        v_migration_cnt_total NUMBER := 0;
5599:        v_cnt                 NUMBER := 0;
5600:        
5601:        PROCEDURE mark_as_mig(
5602:               p_type      IN   VARCHAR2,
5603:               p_old_sid   IN   VARCHAR2,
5604:               p_new_sid   IN   VARCHAR2,
5605:               p_parent    IN   VARCHAR2) IS
5606:           BEGIN
5607:               v_migration_cnt_total := v_migration_cnt_total + 1;
5608:   
5609:               INSERT INTO T_OSI_MIGRATION
5610:                           (TYPE, old_sid, new_sid, date_time, num, PARENT)
5611:                    VALUES (p_type, p_old_sid, p_new_sid, SYSDATE, v_migration_cnt_total, p_parent);
5612:           EXCEPTION
5613:               WHEN OTHERS THEN
5614:                   RAISE;
5615:           END mark_as_mig;
5616:   
5617:        BEGIN
5618:   
5619:               /* preliminary check to see if the import has already been run on this participant */
5620:               IF p_i2ms_person is null and osi_participant.get_imp_relations_flag(p_new_person) = 'Y' THEN
5621:                   return 'Search complete. Legacy relationships have already been migrated.';
5622:               END IF;
5623:               
5624:               /* initialize the legacy participant (not initialized when 
5625:                  import_legacy_relationships is called directly from the application) */
5626:               IF p_i2ms_person is null then
5627:                  BEGIN
5628:                       SELECT old_sid 
5629:                         INTO v_source_person
5630:                         FROM T_OSI_MIGRATION
5631:                        WHERE new_sid = p_new_person
5632:                          AND type = 'PARTICIPANT';
5633:                  EXCEPTION
5634:                           WHEN NO_DATA_FOUND THEN
5635:                                --return an error message
5636:                                return 'Error: Unable to locate a legacy participant for ' || p_new_person;
5637:                  END; 
5638:               ELSE
5639:                   v_source_person := p_i2ms_person;     
5640:               END IF;
5641:   
5642:               v_new_source_person := p_new_person;
5643:               
5644:               /* loop through the legacy relationships for v_source_person, EXCLUDING those previously migrated */
5645:               FOR k IN (SELECT *
5646:                           FROM ref_v_person_relation
5647:                          WHERE this_person = v_source_person
5648:                            AND sid not in(SELECT old_sid
5649:                                             FROM t_osi_migration
5650:                                            WHERE type = 'RELATIONSHIP'))
5651:               LOOP
5652:                   v_cnt := v_cnt + 1;
5653:   
5654:                   log_error('import_legacy_relationships: STATUS - processing relationship ' || v_cnt);
5655:   
5656:                   --get the related person sid from legacy
5657:                   v_rel_person := k.that_person;
5658:                   v_new_rel_person := null;
5659:                   
5660:                   --first check to see if the related person has already been migrated
5661:                   BEGIN
5662:                       SELECT new_sid
5663:                         INTO v_new_rel_person
5664:                         FROM t_osi_migration 
5665:                        WHERE type = 'PARTICIPANT' 
5666:                          AND old_sid = v_rel_person;
5667:                   EXCEPTION
5668:                       WHEN NO_DATA_FOUND THEN
5669:                           v_new_rel_person := null;
5670:                   END;
5671:                   
5672:                   /* if v_rel_person does not yet exist in t_osi_migration, get the current 
5673:                      version from legacy (for import) */
5674:                   IF v_new_rel_person is null then
5675:                      BEGIN
5676:                          SELECT SID
5677:                            INTO v_rel_perver
5678:                            FROM ref_t_person_version
5679:                           WHERE person = v_rel_person AND current_flag = 1;
5680:                      EXCEPTION
5681:                           WHEN NO_DATA_FOUND THEN
5682:                                --return an error message
5683:                                return 'Error: Unable to locate a current version in legacy for ' || v_rel_person;
5684:                      END;
5685:                   /* import them...but do not import their relationships */
5686:                       v_new_rel_person := import_legacy_participant(v_rel_perver, 'N');
5687:                   END IF;
5688:                   
5689:                   -- import the relationship using the new person sids
5690:                   /* initialize A and B persons */
5691:                   /* NOTE: in I2G, specific relationship sids are defined for each direction, so
5692:                         regardless of I2MS A2B or B2A we will map this relationship as A to B */
5693:                   v_partic_a := v_new_source_person;
5694:                   v_partic_b := v_new_rel_person;
5695:   
5696:                   /* get rel_type */
5697:                   BEGIN
5698:                       select sid
5699:                         into v_rel_type
5700:                         from T_OSI_PARTIC_RELATION_TYPE
5701:                        where upper(description) = upper(k.rel_desc);
5702:                   EXCEPTION
5703:                       WHEN NO_DATA_FOUND THEN
5704:                            --return an error message
5705:                            return 'Error: Unable to locate relationship type for ' || nvl(k.rel_desc, 'NULL');
5706:                   END;
5707:   
5708:                   /* get remaining fields */
5709:                   v_start_date := k.START_DATE;
5710:                   v_end_date := k.END_DATE;
5711:                   v_known_date := k.KNOWN_DATE;
5712:                   v_mod1_value := k.MOD1_VALUE;
5713:                   v_mod2_value := k.MOD2_VALUE;
5714:                   v_mod3_value := k.MOD3_VALUE;
5715:                   v_comments := k.COMMENTS;
5716:                   
5717:                   /* insert the new relationship */
5718:                   INSERT INTO T_OSI_PARTIC_RELATION
5719:                                   (PARTIC_A,
5720:                                    PARTIC_B,
5721:                                    REL_TYPE,
5722:                                    START_DATE,
5723:                                    END_DATE,
5724:                                    KNOWN_DATE,
5725:                                    MOD1_VALUE,
5726:                                    MOD2_VALUE,
5727:                                    MOD3_VALUE,
5728:                                    COMMENTS)
5729:                            VALUES (v_partic_a,
5730:                                    v_partic_b,
5731:                                    v_rel_type,
5732:                                    v_start_date,
5733:                                    v_end_date,
5734:                                    v_known_date,
5735:                                    v_mod1_value,
5736:                                    v_mod2_value,
5737:                                    v_mod3_value,
5738:                                    v_comments
5739:                                    )
5740:                         RETURNING SID
5741:                              INTO v_new_rel_sid;
5742:   
5743:                   mark_as_mig('RELATIONSHIP', k.SID, v_new_rel_sid, v_new_source_person);
5744:                   
5745:               END LOOP;
5746:   
5747:               /* update the migration table to reflect that imp_relations now = 'Y' for this PARTICIPANT */ 
5748:               UPDATE T_OSI_MIGRATION 
5749:                  SET imp_relations = 'Y' 
5750:                WHERE type = 'PARTICIPANT' 
5751:                  AND new_sid = v_new_source_person
5752:                  AND imp_relations = 'N';
5753:   
5754:               /* return a confirmation message if no relationships found, or a 'Y' for successful import... */
5755:   
5756:               IF v_cnt = 0 THEN
5757:                   return 'Search complete. No additional legacy relationships found.';
5758:               END IF;
5759:               
5760:               return 'Y';
5761:        EXCEPTION
5762:             WHEN OTHERS THEN
5763:                  log_error('import_legacy_relationships: Error: ' || dbms_utility.format_error_backtrace);
5764:                  ROLLBACK;
5765:                  return 'Error: ' || sqlerrm;
5766:        END import_legacy_relationships;
5767:   
5768:       /* Given a specific role type SID, return the maximum number of participants allowed per object */
5769:       FUNCTION get_max_allowed_for_role(p_role IN VARCHAR2)
5770:           RETURN NUMBER IS
5771:       BEGIN
5772:           FOR k IN (SELECT max_num
5773:                       FROM T_OSI_PARTIC_ROLE_TYPE
5774:                      WHERE SID = p_role)
5775:           LOOP
5776:               RETURN k.max_num;
5777:           END LOOP;
5778:   
5779:           --Simply return if passed an invalid sid
5780:           RETURN 0;
5781:       EXCEPTION
5782:           WHEN OTHERS THEN
5783:               log_error('OSI_PARTICIPANT.get_max_allowed_for_role: ' || SQLERRM);
5784:               RAISE;
5785:       END get_max_allowed_for_role;
5786:   
5787:       /* Given an object SID and a role SID, return the number already in that given role tied to the given object */
5788:       --Note the exclude parameter, this is used to exclude the current item your on
5789:       FUNCTION get_num_part_in_role(p_obj IN VARCHAR2, p_role IN VARCHAR2, p_exclude IN VARCHAR2)
5790:           RETURN NUMBER IS
5791:           v_cnt       NUMBER;
5792:           v_exclude   VARCHAR2(20);
5793:       BEGIN
5794:           --Clear buffer
5795:           v_cnt := 0;
5796:   
5797:           --Did this to make the query simpler
5798:           IF (p_exclude IS NULL) THEN
5799:               v_exclude := ' ';
5800:           ELSE
5801:               v_exclude := p_exclude;
5802:           END IF;
5803:   
5804:           FOR k IN (SELECT SID
5805:                       FROM T_OSI_PARTIC_INVOLVEMENT
5806:                      WHERE obj = p_obj AND involvement_role = p_role AND SID &lt;&gt; v_exclude)
5807:           LOOP
5808:               v_cnt := v_cnt + 1;
5809:           END LOOP;
5810:   
5811:           --Return value
5812:           RETURN v_cnt;
5813:       EXCEPTION
5814:           WHEN OTHERS THEN
5815:               log_error('OSI_PARTICIPANT.get_num_part_in_role: ' || SQLERRM);
5816:               RAISE;
5817:       END get_num_part_in_role;
5818:   
5819:       /* Given a participant SID and a personnel SID (optional) will return Y/N if the details should be editable */
5820:       FUNCTION details_are_editable(p_obj IN VARCHAR2, p_personnel IN VARCHAR2 := NULL)
5821:           RETURN VARCHAR2 IS
5822:           v_return          VARCHAR2(1)                 := 'N';
5823:           v_personnel_sid   T_CORE_PERSONNEL.SID%TYPE;
5824:       BEGIN
5825:           --First see if participant object is locked
5826:           FOR k IN (SELECT SID
5827:                       FROM T_OSI_PARTICIPANT
5828:                      WHERE SID = p_obj AND details_lock = 'N')
5829:           LOOP
5830:               --If its not locked, just exit right out
5831:               RETURN 'Y';
5832:           END LOOP;
5833:   
5834:           --Get the personnel that is attempting to see data
5835:           IF (p_personnel IS NOT NULL) THEN
5836:               v_personnel_sid := p_personnel;
5837:           ELSE
5838:               v_personnel_sid := Core_Context.personnel_sid;
5839:           END IF;
5840:   
5841:           --Since the object is marked as locked, need to see if the user has the override privilege
5842:           --Action type = 'DET_UNL'
5843:           IF (Osi_Auth.check_for_priv('DET_UNL',
5844:                                       Core_Obj.lookup_objtype('PARTICIPANT'),
5845:                                       v_personnel_sid) = 'Y') THEN
5846:               v_return := 'Y';
5847:           ELSE
5848:               v_return := 'N';
5849:           END IF;
5850:   
5851:           --If all else, return current v_return value
5852:           RETURN v_return;
5853:       EXCEPTION
5854:           WHEN OTHERS THEN
5855:               log_error('OSI_PARTICIPANT.details_are_editable: ' || SQLERRM);
5856:               RAISE;
5857:       END details_are_editable;
5858:   
5859:       procedure reorder_partic_images(p_obj in varchar2, p_cur_seq in number, p_targ_seq in number) is
5860:       begin
5861:           if p_targ_seq &gt; p_cur_seq then                                  --moving LOWER in the chain
5862:               for a in (select   *
5863:                             from t_osi_attachment
5864:                            where obj = p_obj and seq &gt; p_cur_seq and seq &lt;= p_targ_seq
5865:                         order by seq)
5866:               loop
5867:                   update v_osi_partic_images
5868:                      set seq = a.seq - 1
5869:                    where SID = a.SID;
5870:               end loop;
5871:   
5872:               commit;
5873:           elsif p_targ_seq &lt; p_cur_seq then                               --moving HIGHER in the chain
5874:               for a in (select   *
5875:                             from v_osi_partic_images
5876:                            where obj = p_obj and seq &gt;= p_targ_seq and seq &lt; p_cur_seq
5877:                         order by seq)
5878:               loop
5879:                   update t_osi_attachment
5880:                      set seq = a.seq + 1
5881:                    where SID = a.SID;
5882:               end loop;
5883:   
5884:               commit;
5885:           end if;
5886:       exception
5887:           when others then
5888:               log_error('reorder_partic_images: ' || sqlerrm);
5889:               raise;
5890:       end;
5891:   
5892:       procedure partic_image_sort(v_obj in varchar2) is
5893:           v_seq   Number := 0;
5894:       Begin
5895:           for a in (select   SID
5896:                         from v_osi_partic_images
5897:                        where obj = v_obj
5898:                     order by SEQ asc)
5899:           loop
5900:               v_seq := v_seq + 1;
5901:   
5902:               update t_osi_attachment
5903:                  set seq = v_seq
5904:                where SID = a.SID;
5905:           end loop;
5906:   
5907:         end;
5908:   
5909:       FUNCTION Is_Married( pPoPV IN VARCHAR2 ) RETURN VARCHAR2 IS
5910:   
5911:           v_result VARCHAR2(3);
5912:           v_cnt NUMBER;
5913:       
5914:       BEGIN
5915:           SELECT COUNT(*) INTO v_cnt
5916:             FROM T_OSI_PARTICIPANT_VERSION pv,
5917:                  V_OSI_PARTIC_RELATION_2WAY pr
5918:             WHERE pr.this_partic = pv.participant AND
5919:                   upper(pr.rel_desc) LIKE '%SPOUSE%' AND
5920:                   (pv.participant = pPoPV OR pv.SID = pPoPV) AND
5921:                   NVL(pr.END_DATE,(SYSDATE + 1)) &gt; SYSDATE;
5922:                          
5923:           IF v_cnt &gt; 0 THEN
5924:   
5925:             v_result := 'YES';
5926:   
5927:           ELSE
5928:   
5929:             v_result := 'NO';
5930:   
5931:           END IF;
5932:       
5933:           RETURN (v_result);
5934:   
5935:       END Is_Married;
5936:   
5937:       ------------------------
5938:       -- Returns Y if legacy relationships have already been imported, otherwise return N
5939:       ------------------------
5940:       FUNCTION get_imp_relations_flag(p_obj in varchar2)
5941:           RETURN VARCHAR2 is
5942:   
5943:           v_return Varchar2(1);
5944:   
5945:       BEGIN
5946:           select imp_relations
5947:             into v_return
5948:             from t_osi_migration
5949:            where new_sid = p_obj
5950:              and type = 'PARTICIPANT';
5951:   
5952:           v_return := nvl(v_return, 'Y');
5953:   
5954:           return v_return;
5955:   
5956:       EXCEPTION
5957:           WHEN NO_DATA_FOUND THEN
5958:                return 'Y';
5959:       END get_imp_relations_flag;
5960:   
5961:   --grant select on t_person_name to webi2ms;
5962:   --grant select on t_person_number_type to webi2ms;
5963:   --grant select on t_person_number to webi2ms;
5964:   --grant select on t_person to webi2ms;
5965:   --grant select on t_person_version to webi2ms;
5966:   --grant select on v_person_version to webi2ms;
5967:   --grant select on t_person_citizenship to webi2ms;
5968:   --grant select on t_person_mark to webi2ms;
5969:   --grant select on t_address_v2 to webi2ms;
5970:   --grant select on t_phone_email to webi2ms;
5971:   --grant select on t_person_org_attr to webi2ms;
5972:   --grant select on t_person_vehicle to webi2ms;
5973:   --grant select on t_person_vehicle_body_types to webi2ms;
5974:   --grant select on t_person_vehicle_roles to webi2ms;
5975:   --grant select on t_date to webi2ms;
5976:   --grant select on t_date_type to webi2ms;
5977:   --grant select on t_note_v2 to webi2ms;
5978:   --grant select on t_attachment_v3 to webi2ms;
5979:   --grant select on v_person_act_inv to webi2ms;
5980:   --grant select on v_person_file_inv to webi2ms;
5981:   --grant select on v_person_relation to webi2ms;
5982:   --grant execute on person to webi2ms;
5983:   --grant execute on obj_doc_web to webi2ms;
5984:   --grant execute on classification_pkg to webi2ms;
5985:   
5986:   --create synonym ref_t_person_name for i2ms.t_person_name;
5987:   --create synonym ref_t_person_number_type for i2ms.t_person_number_type;
5988:   --create synonym ref_t_person_number for i2ms.t_person_number;
5989:   --create synonym ref_t_person for i2ms.t_person;
5990:   --create synonym ref_t_person_version for i2ms.t_person_version;
5991:   --create synonym ref_v_person_version for i2ms.v_person_version;
5992:   --create synonym ref_t_person_citizenship for i2ms.t_person_citizenship;
5993:   --create synonym ref_t_person_mark for i2ms.t_person_mark;
5994:   --create synonym ref_t_address_v2  for i2ms.t_address_v2;
5995:   --create synonym ref_t_phone_email for i2ms.t_phone_email;
5996:   --create synonym ref_t_person_org_attr for i2ms.t_person_org_attr;
5997:   --create synonym ref_t_person_vehicle for i2ms.t_person_vehicle;
5998:   --create synonym ref_t_person_vehicle_bt for i2ms.t_person_vehicle_body_types;
5999:   --create synonym ref_t_person_vehicle_roles for i2ms.t_person_vehicle_roles;
6000:   --create synonym ref_t_date for i2ms.t_date;
6001:   --create synonym ref_t_date_type for i2ms.t_date_type;
6002:   --create synonym ref_t_note_v2 for i2ms.t_note_v2;
6003:   --create synonym ref_t_attachment_v3 for i2ms.t_attachment_v3;
6004:   --create synonym ref_v_person_act_inv  for i2ms.v_person_act_inv;
6005:   --create synonym ref_v_person_file_inv  for i2ms.v_person_file_inv;
6006:   --create synonym ref_v_person_relation  for i2ms.v_person_relation;
6007:   --create synonym ref_person for i2ms.person;
6008:   --create synonym ref_obj_doc_web for i2ms.obj_doc_web;
6009:   --create synonym ref_classification_pkg for i2ms.classification_pkg;
6010:   END Osi_Participant;
6011:   /
</span>
</pre>
</body>
<SCRIPT LANGUAGE="JavaScript" TYPE="text/javascript">
<!--
var newWind;
function putJumpCode(){
	var cnt = 7;
	newWind.document.write('<html>\n');
	newWind.document.write('<title>CSDiff Navigation</title>\n');
	newWind.document.write('<body>\n');
	newWind.document.write('<form name="jump">\n');
	newWind.document.write('<input type="button" value=" |&lt; " name="First" onclick=goto_first(this.form)>&nbsp;')
	newWind.document.write('<input type="button" value=" &lt; " name="Prev" onclick=goto_prev(this.form)>&nbsp;&nbsp;\n');
	newWind.document.write('<select name=url onchange=menu_goto(this.form)> \n');
	for (var i=0; i<cnt ;i++ ) {
		newWind.document.write('<option value="#c'+i+'">Change #'+(i+1)+ '</option> \n');
		}
	newWind.document.write('');
	newWind.document.write('</select>&nbsp;&nbsp;\n');
	newWind.document.write('<input type="button" value=" &gt; " name="Next"\n');
	newWind.document.write('onclick=goto_next(this.form)>\n');
	newWind.document.write('<input type="button" value=" &gt| " name="Last"\n');
	newWind.document.write('onclick=goto_last(this.form)>\n');
	newWind.document.write('</form>\n');
	newWind.document.write('');
	newWind.document.write('<form method="POST">\n');
	newWind.document.write('<p align="center"><i><font size="3">Generated\n');
	newWind.document.write('by <a href="http://www.ComponentSoftware.com/products/csdiff/" target="_blank">CSDiff</a> \n');
	newWind.document.write('</form>\n');
	newWind.document.write('</body>\n');
	newWind.document.write('</html>\n');
	newWind.document.write('<SCRIPT LANGUAGE="JavaScript" TYPE="text/javascript">\n');
	newWind.document.write('<!--\n');
	newWind.document.write('');
	newWind.document.write('var directCloseFlag=1;\n');
	newWind.document.write('');
	newWind.document.write('function menu_goto( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('  var baseurl = opener.location.href ;\n');
	newWind.document.write('  var idx = baseurl.indexOf("#");\n');
	newWind.document.write('  if (idx > -1) {\n');
	newWind.document.write('	baseurl = baseurl.slice(0, idx);\n');
	newWind.document.write('  }');
	newWind.document.write('  selecteditem = menuform.url.selectedIndex ;\n');
	newWind.document.write('  newurl = menuform.url.options[ selecteditem ].value ;\n');
	newWind.document.write('  if (newurl.length != 0) {\n');
	newWind.document.write('    	opener.top.location.href = baseurl + newurl ;\n');
	newWind.document.write('  }');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_prev( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	if(menuform.url.selectedIndex>0) menuform.url.selectedIndex--;\n');
	newWind.document.write('	menu_goto( menuform )\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_first( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	menuform.url.selectedIndex = 0;	\n');
	newWind.document.write('	menu_goto( menuform );\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_last( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	menuform.url.selectedIndex = menuform.url.options.length-1;	\n');
	newWind.document.write('	menu_goto( menuform );\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_next( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	if(menuform.url.options.length > (menuform.url.selectedIndex+1))\n');
	newWind.document.write('	menuform.url.selectedIndex++;\n');
	newWind.document.write('	menu_goto( menuform )\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function restore()\n');
	newWind.document.write('{\n');
	newWind.document.write('    	focus();\n');
	newWind.document.write('	menu_goto(jump);\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('goto_first(jump)\n');
	newWind.document.write('//-->\n');
	newWind.document.write('<');
	newWind.document.write('/SCRIPT>\n');
}
function pop_navigate(){
var isOpen = false
try {
isOpen = (newWind != null) && (!newWind.closed)
} catch (e) {}
  if (!isOpen) {
    newWind =  window.open("" ,"HtmlDiffJumpWindow","width=270,height=40")
    if (newWind.opener == null) { // for Nav 2.0x
      newWind.opener = self // this creates and sets a new prop
    }	putJumpCode();
  
} 
else 
{	newWind.execScript("restore()", "JavaScript");
  }
}
function exit(){
var isOpen = false
try {
isOpen = (newWind != null) && (!newWind.closed)
} catch (e) {}
if (isOpen) {
	newWind.close();
  }
}
//--></SCRIPT></html>
</BODY></HTML>