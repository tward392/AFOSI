CREATE TABLE WEBI2MS.T_OSI_A_SURV_APPROVAL
(
  SID                 VARCHAR2(20 BYTE)         NOT NULL,
  SURVEILLANCE        VARCHAR2(20 BYTE)         NOT NULL,
  APPROVAL_TYPE       VARCHAR2(20 BYTE)         NOT NULL,
  APPROVED_BY         VARCHAR2(100 BYTE),
  APPROVED_DATE       DATE,
  APPROVED_DURATION   NUMBER,
  APPROVAL_CREATE_BY  VARCHAR2(100 BYTE),
  APPROVAL_CREATE_ON  DATE,
  APPROVAL_MODIFY_BY  VARCHAR2(100 BYTE),
  APPROVAL_MODIFY_ON  DATE
);

CREATE UNIQUE INDEX WEBI2MS.PK_SURV_APPROVAL ON WEBI2MS.T_OSI_A_SURV_APPROVAL (SID);

ALTER TABLE WEBI2MS.T_OSI_A_SURV_APPROVAL ADD (CONSTRAINT PK_SURV_APPROVAL PRIMARY KEY (SID));

ALTER TABLE WEBI2MS.T_OSI_A_SURV_APPROVAL ADD (CONSTRAINT FK_OSI_A_SURV_APPROVAL_OBJ FOREIGN KEY (SURVEILLANCE) REFERENCES WEBI2MS.T_OSI_A_SURVEILLANCE (SID) ON DELETE CASCADE);

ALTER TABLE WEBI2MS.T_OSI_A_SURV_APPROVAL ADD (CONSTRAINT FK_OSI_A_SURV_APPROVAL_TYPE FOREIGN KEY (APPROVAL_TYPE) REFERENCES WEBI2MS.T_OSI_REFERENCE (SID));

GRANT SELECT ON  WEBI2MS.T_OSI_A_SURV_APPROVAL TO MIS_ROLE;


CREATE OR REPLACE TRIGGER WEBI2MS."OSI_SURV_APPROVAL_B_I_SID" 
    before insert
    on T_OSI_A_SURV_APPROVAL
    for each row
begin
    if :new.sid is null then
        :new.sid := core_sidgen.next_sid;
    end if;
end;
/


INSERT INTO T_OSI_A_SURV_APPROVAL (SURVEILLANCE,APPROVAL_TYPE,APPROVED_BY,APPROVED_DATE,APPROVED_DURATION,APPROVAL_CREATE_BY,APPROVAL_CREATE_ON,APPROVAL_MODIFY_BY,APPROVAL_MODIFY_ON)
 (SELECT SID,'33318UJD',APPROVED_BY,APPROVED_DATE,APPROVED_DURATION,APPROVAL_CREATE_BY,APPROVAL_CREATE_ON,APPROVAL_MODIFY_BY,APPROVAL_MODIFY_ON FROM T_OSI_A_SURVEILLANCE
   WHERE (APPROVED_BY IS NOT NULL OR APPROVED_DATE IS NOT NULL OR APPROVED_DURATION IS NOT NULL OR APPROVAL_CREATE_BY IS NOT NULL OR APPROVAL_CREATE_ON IS NOT NULL OR APPROVAL_MODIFY_BY IS NOT NULL OR APPROVAL_MODIFY_ON IS NOT NULL));
COMMIT;


CREATE OR REPLACE TRIGGER WEBI2MS."OSI_SURV_APPROVAL_B_IU_TS" 
    before insert or update
    on T_OSI_A_SURV_APPROVAL
    for each row
declare
    v_who    varchar2(100);
    v_when   date;
begin
    v_who := core_context.personnel_name;

    if v_who is null then
        v_who := v('APP_USER');
    end if;

    if v_who is null then
        v_who := sys_context('USERENV', 'OS_USER');
    end if;

    if v_who is null then
        v_who := user;
    end if;

    v_when := sysdate;

    if inserting then
        :new.approval_create_by := v_who;
        :new.approval_create_on := v_when;
    end if;

    :new.approval_modify_by := v_who;
    :new.approval_modify_on := v_when;
end;
/